<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="version" content="2.1.0" />
<title>è¯†å­—å¡ï½œäººæ•™ç‰ˆ ä¸€ï½äºŒå¹´çº§ï¼ˆä¸Š/ä¸‹ï¼‰</title>
<style>
  :root {
    /* æ—¥å¼é…è‰²æ–¹æ¡ˆ */
    --bg-primary: #faf8f5;     /* ç±³ç™½è‰²èƒŒæ™¯ */
    --bg-secondary: #f5f2ed;   /* æµ…ç±³è‰² */
    --card: #ffffff;           /* çº¯ç™½å¡ç‰‡ */
    --text-primary: #2c2c2c;   /* æ·±ç°è‰²æ–‡å­— */
    --text-secondary: #6b6b6b; /* ä¸­ç°è‰² */
    --text-muted: #9a9a9a;     /* æµ…ç°è‰² */
    --accent: #8b7355;         /* æ—¥å¼æ£•è‰² */
    --accent-light: #a68b5b;   /* æµ…æ£•è‰² */
    --border: #e8e3dd;         /* æµ…æ£•è‰²è¾¹æ¡† */
    --shadow: 0 8px 32px rgba(139, 115, 85, 0.08);
    --radius: 12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    color: var(--text-primary);
    font: 16px/1.6 "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", "Noto Sans CJK JP", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
    min-height: 100vh;
    letter-spacing: 0.02em;
  }
  
  /* ç§»åŠ¨ç«¯ä¼˜åŒ–çš„å¤´éƒ¨ */
  header{
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    box-shadow: 0 2px 8px rgba(139, 115, 85, 0.05);
  }
  h1{
    margin: 0;
    font-size: 20px;
    font-weight: 500;
    color: var(--text-primary);
    letter-spacing: 0.05em;
  }
  .settings-btn{
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 24px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(139, 115, 85, 0.2);
  }
  .settings-btn:hover{
    background: var(--accent-light);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3);
  }
  
  /* ä¸»å®¹å™¨ */
  .main-container{padding:20px 16px;max-width:480px;margin:0 auto;min-height:calc(100vh - 60px);display:flex;flex-direction:column;justify-content:center}
  
  /* å•å¡ç‰‡æ˜¾ç¤º */
  .card-container{display:flex;justify-content:center;margin:24px 0}
  .card{
    perspective: 1000px;
    width: 300px;
    height: 300px;
    position: relative;
  }
  .card-inner{
    position: absolute;
    inset: 0;
    border-radius: var(--radius);
    transform-style: preserve-3d;
    transition: transform 0.7s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: var(--shadow);
    background: var(--card);
    border: 1px solid var(--border);
  }
  .card.flipped .card-inner{transform: rotateY(180deg)}
  .face{
    position: absolute;
    inset: 0;
    backface-visibility: hidden;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 24px;
  }
  .front{
    background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
    border: 1px solid var(--border);
  }
  .back{
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
    color: #fff;
    transform: rotateY(180deg);
  }
  .hanzi{
    font-size: 88px;
    font-weight: 400;
    letter-spacing: 0.1em;
    margin-bottom: 12px;
    color: var(--text-primary);
    text-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .pinyin{
    font-size: 36px;
    font-weight: 300;
    letter-spacing: 0.15em;
    margin-bottom: 12px;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .tag{
    position: absolute;
    top: 16px;
    left: 16px;
    background: rgba(139, 115, 85, 0.1);
    color: var(--accent);
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.05em;
    border: 1px solid rgba(139, 115, 85, 0.2);
  }
  .hint{
    font-size: 13px;
    color: var(--text-muted);
    text-align: center;
    margin-top: 8px;
    letter-spacing: 0.02em;
  }
  
  /* æ§åˆ¶æŒ‰é’® */
  .controls{
    display: flex;
    justify-content: center;
    gap: 16px;
    margin: 24px 0;
  }
  button{
    appearance: none;
    border: none;
    background: var(--accent);
    color: #fff;
    padding: 14px 24px;
    border-radius: 28px;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    letter-spacing: 0.02em;
    box-shadow: 0 4px 16px rgba(139, 115, 85, 0.2);
    transition: all 0.3s ease;
    border: 1px solid transparent;
  }
  button:hover{
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(139, 115, 85, 0.3);
    background: var(--accent-light);
  }
  button.secondary{
    background: #fff;
    color: var(--accent);
    border: 1px solid var(--accent);
    box-shadow: 0 2px 8px rgba(139, 115, 85, 0.1);
  }
  button.secondary:hover{
    background: var(--accent);
    color: #fff;
    box-shadow: 0 4px 16px rgba(139, 115, 85, 0.2);
  }
  button.ghost{
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border);
    box-shadow: none;
  }
  button.ghost:hover{
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-color: var(--accent);
  }
  
  /* è¿›åº¦ä¿¡æ¯ */
  .progress{
    text-align: center;
    margin: 20px 0;
    color: var(--text-secondary);
    font-size: 15px;
    font-weight: 400;
    letter-spacing: 0.02em;
  }
  
  /* è®¾ç½®å¼¹çª— */
  .modal{
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 1000;
    backdrop-filter: blur(4px);
  }
  .modal.show{display: flex !important}
  .dialog{
    width: min(420px, 90vw);
    background: #fff;
    border-radius: 24px;
    box-shadow: 0 24px 64px rgba(139, 115, 85, 0.15);
    padding: 28px;
    max-height: 85vh;
    overflow-y: auto;
    border: 1px solid var(--border);
  }
  .dialog h3{
    margin: 0 0 20px;
    font-size: 20px;
    text-align: center;
    color: var(--text-primary);
    font-weight: 500;
    letter-spacing: 0.02em;
  }
  
  /* è®¾ç½®å†…å®¹ */
  .setting-group{margin-bottom: 24px}
  .setting-group label{
    display: block;
    margin-bottom: 10px;
    font-weight: 500;
    color: var(--text-primary);
    font-size: 15px;
    letter-spacing: 0.01em;
  }
  select, input[type="number"]{
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 14px;
    background: #fff;
    color: var(--text-primary);
    transition: all 0.2s ease;
    font-family: inherit;
  }
  select:focus, input[type="number"]:focus{
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
  }
  
  /* è¯¾æ–‡é€‰æ‹© */
  .lessons{
    max-height: 220px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    background: var(--bg-primary);
  }
  .lessons h4{
    margin: 12px 0 8px;
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
    letter-spacing: 0.01em;
  }
  .lesson-item{
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
    color: var(--text-primary);
  }
  .lesson-item:hover{
    background: var(--bg-secondary);
  }
  .lesson-item input{
    transform: scale(1.1);
    accent-color: var(--accent);
  }
  
  /* æŒ‰é’®ç»„ */
  .btn-group{
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }
  .btn-group button{flex: 1}
  
  /* å¬å†™ç•Œé¢æ ·å¼ */
  .dictation-container {
    display: flex;
    justify-content: center;
    margin: 24px 0;
  }
  
  .dictation-card {
    width: 100%;
    max-width: 400px;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    padding: 28px;
  }
  
  .dictation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  
  .play-btn {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .play-btn:hover {
    background: var(--accent-light);
    transform: scale(1.05);
  }
  
  .play-btn:active {
    transform: scale(0.95);
  }
  
  .dictation-content {
    text-align: center;
  }
  
  .audio-visual {
    margin-bottom: 28px;
    padding: 20px;
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  
  .sound-waves {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px;
    height: 40px;
    margin-bottom: 16px;
  }
  
  .sound-waves span {
    width: 4px;
    height: 20px;
    background: var(--accent);
    border-radius: 2px;
    opacity: 0.3;
    transition: all 0.3s ease;
  }
  
  .sound-waves.playing span {
    animation: soundWave 1.2s ease-in-out infinite;
  }
  
  .sound-waves.playing span:nth-child(1) { animation-delay: 0s; }
  .sound-waves.playing span:nth-child(2) { animation-delay: 0.1s; }
  .sound-waves.playing span:nth-child(3) { animation-delay: 0.2s; }
  .sound-waves.playing span:nth-child(4) { animation-delay: 0.3s; }
  .sound-waves.playing span:nth-child(5) { animation-delay: 0.4s; }
  
  @keyframes soundWave {
    0%, 100% { height: 20px; opacity: 0.3; }
    50% { height: 35px; opacity: 1; }
  }
  
  .current-pinyin {
    font-size: 24px;
    color: var(--accent);
    font-weight: 500;
    letter-spacing: 0.1em;
  }
  
  .input-area {
    margin-bottom: 24px;
  }
  
  .input-area input {
    width: 100%;
    max-width: 200px;
    padding: 16px 20px;
    font-size: 32px;
    text-align: center;
    border: 2px solid var(--border);
    border-radius: 12px;
    background: #fff;
    color: var(--text-primary);
    transition: all 0.3s ease;
    font-weight: 400;
    letter-spacing: 0.1em;
  }
  
  .input-area input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
    transform: scale(1.02);
  }
  
  .input-area input.correct {
    border-color: #10b981;
    background: rgba(16, 185, 129, 0.05);
  }
  
  .input-area input.incorrect {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.05);
    animation: shake 0.5s ease-in-out;
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  
  .input-hint {
    margin-top: 12px;
    font-size: 14px;
    color: var(--text-muted);
    letter-spacing: 0.02em;
  }
  
  .result-area {
    padding: 20px;
    border-radius: 12px;
    margin-top: 20px;
    transition: all 0.3s ease;
  }
  
  .result-area.correct {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
  }
  
  .result-area.incorrect {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
  }
  
  .result-icon {
    font-size: 32px;
    margin-bottom: 8px;
  }
  
  .result-text {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 12px;
    letter-spacing: 0.02em;
  }
  
  .result-area.correct .result-text {
    color: #059669;
  }
  
  .result-area.incorrect .result-text {
    color: #dc2626;
  }
  
  .answer-display {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .correct-answer {
    font-size: 28px;
    font-weight: 500;
    color: var(--text-primary);
    padding: 8px 16px;
    background: rgba(139, 115, 85, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(139, 115, 85, 0.2);
  }
  
  .correct-pinyin {
    font-size: 18px;
    color: var(--accent);
    font-weight: 400;
    letter-spacing: 0.1em;
  }

  /* ç”°å­—æ ¼æ‰“å°æ ·å¼ */
  .tianzi-grid {
    display: inline-block;
    width: 14mm;
    height: 14mm;
    border: 1px solid #000;
    position: relative;
    margin: 0;
    vertical-align: top;
    box-sizing: border-box;
  }
  
  .tianzi-grid::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #000;
    border-top: 1px dashed #000;
    transform: translateY(-50%);
  }
  
  .tianzi-grid::after {
    content: '';
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 1px;
    background: #000;
    border-left: 1px dashed #000;
    transform: translateX(-50%);
  }
  
  .tianzi-char {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 14mm;
    font-weight: normal;
    line-height: 1;
    font-family: 'KaiTi', 'æ¥·ä½“', 'STKaiti', 'åæ–‡æ¥·ä½“', 'STKaiti', 'SimKai', serif;
    color: transparent;
    -webkit-text-stroke: 0.5px #000;
  }
  
  .tianzi-char.trace {
    color: transparent;
    -webkit-text-stroke: 0.5px #000;
  }
  
  .tianzi-stroke-order {
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 8px;
    color: #666;
    line-height: 1;
  }
  
  .print-page {
    width: 210mm;
    min-height: 297mm;
    margin: 0 auto;
    padding: 20mm;
    background: white;
    font-family: 'SimSun', 'å®‹ä½“', serif;
    font-size: 12pt;
    line-height: 1.5;
    box-sizing: border-box;
  }
  
  .print-header {
    text-align: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #000;
    padding-bottom: 10px;
  }
  
  .print-title {
    font-size: 18pt;
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .print-subtitle {
    font-size: 12pt;
    color: #666;
  }
  
  .print-grid-container {
    display: block;
    margin-bottom: 20px;
    line-height: 0;
  }
  
  .print-section {
    margin-bottom: 30px;
  }
  
  .print-section-title {
    font-size: 14pt;
    font-weight: bold;
    margin-bottom: 10px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 5px;
  }
  
  @media print {
    body * {
      visibility: hidden;
    }
    
    .print-page, .print-page * {
      visibility: visible;
    }
    
    .print-page {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      margin: 0;
      padding: 20mm;
    }
    
    .tianzi-grid {
      break-inside: avoid;
    }
    
    .tianzi-char {
      color: transparent !important;
      -webkit-text-stroke: 0.5px #000 !important;
      font-weight: normal !important;
    }
  }

  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 480px) {
    .card{
      width: 260px;
      height: 260px;
    }
    .hanzi{
      font-size: 76px;
    }
    .pinyin{
      font-size: 30px;
    }
    .main-container{
      padding: 16px 12px;
    }
    .dialog{
      padding: 20px;
      margin: 10px;
      width: min(380px, 95vw);
      max-height: 90vh;
    }
    .modal{
      padding: 10px;
    }
    .controls{
      gap: 12px;
    }
    button{
      padding: 12px 20px;
      font-size: 13px;
    }
    
    /* å¬å†™ç•Œé¢ç§»åŠ¨ç«¯ä¼˜åŒ– */
    .dictation-card {
      padding: 20px;
      margin: 0 8px;
    }
    
    .audio-visual {
      padding: 16px;
    }
    
    .current-pinyin {
      font-size: 20px;
    }
    
    .input-area input {
      font-size: 28px;
      padding: 14px 16px;
    }
    
    .correct-answer {
      font-size: 24px;
      padding: 6px 12px;
    }
    
    .correct-pinyin {
      font-size: 16px;
    }
  }
  
  @media (max-width: 360px) {
    .card{
      width: 240px;
      height: 240px;
    }
    .hanzi{
      font-size: 68px;
    }
    .pinyin{
      font-size: 26px;
    }
    
    /* å°å±å¹•å¬å†™ç•Œé¢ä¼˜åŒ– */
    .dictation-card {
      padding: 16px;
    }
    
    .dictation-header {
      margin-bottom: 20px;
    }
    
    .play-btn {
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .audio-visual {
      padding: 12px;
      margin-bottom: 20px;
    }
    
    .current-pinyin {
      font-size: 18px;
    }
    
    .input-area input {
      font-size: 24px;
      padding: 12px 14px;
      max-width: 160px;
    }
    
    .correct-answer {
      font-size: 20px;
      padding: 4px 8px;
    }
    
    .correct-pinyin {
      font-size: 14px;
    }
    
    .result-icon {
      font-size: 24px;
    }
    
    .result-text {
      font-size: 14px;
    }
  }
</style>
</head>
<body>
  <header>
    <h1>è¯†å­—å¡</h1>
    <div style="display: flex; gap: 8px; align-items: center;">
      <button id="btnPrint" class="settings-btn" style="padding: 8px 12px; font-size: 12px;">ğŸ–¨ï¸ æ‰“å°</button>
      <button id="btnSettings" class="settings-btn">âš™ï¸ è®¾ç½®</button>
    </div>
  </header>

  <div class="main-container">
    <!-- è¿›åº¦ä¿¡æ¯ -->
    <div class="progress" id="progressInfo">ç‚¹å‡»"å¼€å§‹å­¦ä¹ "å¼€å§‹è¯†å­—</div>
    
    <!-- å•å¡ç‰‡æ˜¾ç¤º -->
    <div class="card-container">
      <div id="currentCard" class="card">
        <div class="card-inner">
          <div class="face front">
            <div class="tag">ç”Ÿå­—</div>
            <div class="hanzi" id="currentHanzi">å­—</div>
            <div class="hint">ç‚¹å‡»ç¿»é¢çœ‹æ‹¼éŸ³</div>
          </div>
          <div class="face back">
            <div class="tag">æ‹¼éŸ³</div>
            <div class="pinyin" id="currentPinyin">zÃ¬</div>
            <div class="hint">ç‚¹å‡»ç¿»é¢çœ‹ç”Ÿå­—</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å¬å†™ç•Œé¢ -->
    <div id="dictationContainer" class="dictation-container" style="display:none;">
      <div class="dictation-card">
        <div class="dictation-header">
          <div class="tag">å¬å†™ç»ƒä¹ </div>
          <button id="btnPlayAudio" class="play-btn">ğŸ”Š æ’­æ”¾</button>
        </div>
        
        <div class="dictation-content">
          <div class="audio-visual">
            <div class="sound-waves" id="soundWaves">
              <span></span><span></span><span></span><span></span><span></span>
            </div>
            <div class="current-pinyin" id="dictationPinyin">ç‚¹å‡»æ’­æ”¾å¬å£°éŸ³</div>
          </div>
          
          <div class="input-area">
            <input type="text" id="dictationInput" placeholder="è¯·è¾“å…¥å¬åˆ°çš„æ±‰å­—" autocomplete="off" maxlength="1">
            <div class="input-hint">å¬æ¸…æ¥šåï¼Œè¾“å…¥å¯¹åº”çš„æ±‰å­—</div>
          </div>
          
          <div class="result-area" id="resultArea" style="display:none;">
            <div class="result-icon" id="resultIcon"></div>
            <div class="result-text" id="resultText"></div>
            <div class="answer-display">
              <span class="correct-answer" id="correctAnswer"></span>
              <span class="correct-pinyin" id="correctPinyin"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="controls">
      <button id="btnStart" class="secondary">å¼€å§‹å­¦ä¹ </button>
      <button id="btnPrev" class="ghost" style="display:none;">ä¸Šä¸€ä¸ª</button>
      <button id="btnNext" class="ghost" style="display:none;">ä¸‹ä¸€ä¸ª</button>
      <button id="btnShuffle" class="ghost" style="display:none;">ğŸ”€ éšæœº</button>
      
      <!-- å¬å†™ä¸“ç”¨æŒ‰é’® -->
      <button id="btnCheck" class="secondary" style="display:none;">æ£€æŸ¥ç­”æ¡ˆ</button>
      <button id="btnNextDictation" class="ghost" style="display:none;">ä¸‹ä¸€ä¸ª</button>
      <button id="btnReplay" class="ghost" style="display:none;">ğŸ”Š é‡æ’­</button>
    </div>
    
    <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
    <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
      <div style="font-size: 11px; color: var(--text-muted); opacity: 0.7;">
        v<span id="footerVersion">2.1.0</span>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®å¼¹çª— -->
  <div class="modal" id="settingsModal">
    <div class="dialog">
      <h3>å­¦ä¹ è®¾ç½®</h3>
      
      <div class="setting-group">
        <label>é€‰æ‹©å†Œåˆ«ï¼š</label>
        <select id="bookSelect">
          <option value="1ä¸Š">ä¸€å¹´çº§ä¸Š</option>
          <option value="1ä¸‹">ä¸€å¹´çº§ä¸‹</option>
          <option value="2ä¸Š" selected>äºŒå¹´çº§ä¸Š</option>
          <option value="2ä¸‹">äºŒå¹´çº§ä¸‹</option>
          <option value="3ä¸Š">ä¸‰å¹´çº§ä¸Š</option>
          <option value="3ä¸‹">ä¸‰å¹´çº§ä¸‹</option>
        </select>
      </div>
      
      <div class="setting-group">
        <label>é€‰æ‹©è¯¾æ–‡ï¼š</label>
        <div id="lessonList" class="lessons"></div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="btnSelectAll" class="ghost" style="flex:1;">å…¨é€‰</button>
          <button id="btnClear" class="ghost" style="flex:1;">æ¸…ç©º</button>
        </div>
      </div>
      
      <div class="setting-group">
        <label>å­¦ä¹ æ¨¡å¼ï¼š</label>
        <select id="studyMode">
          <option value="random">éšæœºé¡ºåº</option>
          <option value="sequential">æŒ‰è¯¾æ–‡é¡ºåº</option>
        </select>
      </div>
      
      <div class="setting-group">
        <label>ç»ƒä¹ æ–¹å¼ï¼š</label>
        <select id="practiceMode">
          <option value="flashcard">è¯†å­—å¡æ¨¡å¼</option>
          <option value="dictation">å¬å†™æ¨¡å¼</option>
        </select>
      </div>
      
      
      <div class="btn-group">
        <button id="btnCloseSettings" class="secondary">å…³é—­</button>
        <button id="btnStartStudy">å¼€å§‹å­¦ä¹ </button>
      </div>
      
      <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
        <div style="font-size: 12px; color: var(--text-muted);">
          ç‰ˆæœ¬ v<span id="appVersion">2.1.0</span> | æ›´æ–°æ—¥æœŸ <span id="versionDate">2025-09-07</span>
        </div>
      </div>
    </div>
  </div>

  <!-- æ‰“å°è®¾ç½®å¼¹çª— -->
  <div class="modal" id="printModal">
    <div class="dialog">
      <h3>ç”°å­—æ ¼ç”Ÿå­—æ‰“å°</h3>
      
      <div class="setting-group">
        <label>æ‰“å°èŒƒå›´ï¼š</label>
        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
          å°†æ‰“å°å½“å‰é€‰æ‹©çš„è¯¾æ–‡èŒƒå›´å†…çš„æ‰€æœ‰ç”Ÿå­—
        </div>
        <div id="printCharsList" style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-top: 8px; min-height: 40px; font-size: 14px; line-height: 1.6;">
          æ­£åœ¨åŠ è½½ç”Ÿå­—åˆ—è¡¨...
        </div>
      </div>
      
      <div class="setting-group">
        <label>æ‰“å°é€‰é¡¹ï¼š</label>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
            <input type="checkbox" id="printTraceMode">
            <span>ä»…æ‰“å°æå­—ï¼ˆç©ºå¿ƒå­—ï¼‰</span>
          </label>
        </div>
      </div>
      
      <div class="btn-group">
        <button id="btnCancelPrint" class="secondary">å–æ¶ˆ</button>
        <button id="btnConfirmPrint">æ‰“å°</button>
      </div>
    </div>
  </div>

  <!-- æ•°æ®ç¼–è¾‘å™¨ï¼ˆå¯¼å…¥/å¯¼å‡º JSONï¼‰ -->
  <div class="modal" id="editModal">
    <div class="dialog">
      <h3>ç¼–è¾‘å½“å‰å†Œåˆ«çš„æ•°æ®ï¼ˆJSONï¼‰</h3>
      <div class="editor">
        <textarea id="jsonArea" spellcheck="false" style="min-height:200px;width:100%;padding:10px;border:1px solid #e0e0e0;border-radius:8px;font-family:monospace;font-size:12px;"></textarea>
        <div style="font-size:12px;color:#666;margin:8px 0;">
          è¯´æ˜ï¼šä¸€ä¸ªæ¡ç›®å½¢å¦‚
          <code>{"unit":1,"id":"1-1","title":"è¯¾æ–‡æ ‡é¢˜","chars":"å­— å­— å­—"}</code>ã€‚
          <br>ç²˜è´´ä½ æ‰‹å¤´æ›´å‡†ç¡®çš„å®˜æ–¹ç”Ÿå­—è¡¨åï¼Œç‚¹"ä¿å­˜"ã€‚ä»…å½±å“å½“å‰é€‰æ‹©çš„å†Œåˆ«ã€‚
        </div>
        <div class="btn-group">
          <button id="btnDownload" class="secondary">å¯¼å‡ºJSON</button>
          <button id="btnCancelEdit" class="ghost">å–æ¶ˆ</button>
          <button id="btnSave">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- pinyin-proï¼ˆæ‹¼éŸ³åº“ï¼ŒCDNï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pinyin-pro/3.27.0/index.js"></script>
  <script>
    // ========== ç‰ˆæœ¬ä¿¡æ¯ ==========
    const APP_VERSION = '2.1.0';
    const VERSION_DATE = '2025-09-07';
    
    // ========== æ•°æ®åŒº ==========
    // ç»“æ„ï¼šDATA[å†Œåˆ«] = LESSONS[]
    // å…¶ä¸­ LESSONS[]: {unit:æ•°å­—,id:"å•å…ƒ-åºå·",title:"è¯¾æ–‡æ ‡é¢˜",chars:"ç©ºæ ¼åˆ†éš”çš„å•å­—åˆ—è¡¨"}
    
    // ç¬”ç”»é¡ºåºæ•°æ®ï¼ˆå¸¸ç”¨æ±‰å­—çš„ç¬”ç”»æ•°ï¼‰
    const STROKE_ORDER = {
      // ä¸€å¹´çº§ä¸Š
      'äº†': 2, 'å­': 3, 'äºº': 2, 'å¤§': 3, 'æœˆ': 4, 'å„¿': 2, 'å¤´': 5, 'é‡Œ': 7, 'å¯': 5, 'ä¸œ': 5, 'è¥¿': 6,
      'å¤©': 4, 'å››': 5, 'æ˜¯': 9, 'åœ¨': 6, 'å': 6, 'æˆ‘': 7, 'å¥½': 6, 'é•¿': 4, 'æ¯”': 4, 'å·´': 4, 'æŠŠ': 7,
      'ä¸‹': 3, 'ä¸ª': 3, 'é›¨': 8, 'ä»¬': 5, 'é—®': 6, 'æœ‰': 6, 'åŠ': 5, 'ä»': 4, 'ä½ ': 7, 'æ‰': 3, 'æ˜': 8,
      'åŒ': 6, 'å­¦': 8, 'è‡ª': 6, 'å·±': 3, 'è¡£': 6, 'ç™½': 5, 'çš„': 8, 'åˆ': 2, 'å’Œ': 8, 'ç«¹': 6, 'ç‰™': 4,
      'é©¬': 3, 'ç”¨': 5, 'å‡ ': 2, 'åª': 5, 'çŸ³': 5, 'å¤š': 6, 'å‡º': 5, 'è§': 4, 'å¯¹': 5, 'å¦ˆ': 6, 'å…¨': 6, 'å›': 6,
      
      // ä¸€å¹´çº§ä¸‹
      'åƒ': 6, 'å«': 5, 'ä¸»': 5, 'æ±Ÿ': 6, 'ä½': 7, 'æ²¡': 7, 'ä»¥': 4, 'ä¼š': 6, 'èµ°': 7, 'åŒ—': 5, 'äº¬': 8, 'é—¨': 3, 'å¹¿': 3,
      'è¿‡': 6, 'å„': 6, 'ç§': 9, 'æ ·': 10, 'ä¼™': 6, 'ä¼´': 7, 'è¿™': 7, 'å¤ª': 4, 'é˜³': 6, 'æ ¡': 10, 'é‡‘': 8, 'ç§‹': 9, 'å› ': 6, 'ä¸º': 4,
      'ä»–': 6, 'æ²³': 8, 'è¯´': 9, 'ä¹Ÿ': 3, 'åœ°': 6, 'å¬': 7, 'å“¥': 10, 'ä¹': 5, 'å•': 8, 'å‘¼': 8, 'å±…': 8, 'æ‹›': 8, 'å¿«': 7,
      'è®²': 6, 'è®¸': 6, 'å¾ˆ': 9, 'å½“': 6, 'ç©': 8, 'è¡Œ': 6, 'éŸ³': 9, 'ä¹¡': 3, 'å‰': 9, 'å…‰': 6, 'ä½': 7, 'åºŠ': 7, 'æ•…': 9, 'æ€': 9,
      'å†': 6, 'å¤–': 5, 'çˆ¸': 8, 'æ™š': 11, 'çœ‹': 9, 'è‰²': 6, 'ç¬‘': 10, 'åˆ': 4, 'èŠ‚': 5, 'å¶': 5, 'çœŸ': 10, 'ç±³': 6, 'è±†': 7, 'åˆ†': 4,
      'å…´': 6, 'åˆ°': 8, 'é‚£': 6, 'åƒ': 3, 'æˆ': 6, 'ç€': 11, 'é«˜': 10, 'æ— ': 4, 'å°–': 6, 'æ ‘': 9, 'çˆ±': 10, 'é‡‡': 8, 'è§’': 7, 'é¦–': 9,
      'ç¾': 9, 'äº®': 9, 'å°': 5, 'æœµ': 6, 'æœº': 6, 'æ”¾': 8, 'é±¼': 8, 'åŠ ': 5, 'è¾¹': 5, 'å—': 6, 'å§': 7, 'å‘€': 7, 'å‘¢': 8, 'ç›´': 8,
      'ç—…': 10, 'åŒ»': 7, 'åˆ«': 7, 'å¹²': 3, 'å¥‡': 8, 'ä¸ƒ': 2, 'æ˜Ÿ': 9, 'å“': 6, 'æ€•': 8, 'è·Ÿ': 13, 'å®¶': 10, 'ç¾Š': 6, 'è±¡': 11, 'éƒ½': 10,
      'æ‰': 10, 'æ¡': 7, 'çˆ¬': 8, 'å§': 8, 'æ‚¨': 11, 'è‰': 9, 'æˆ¿': 8,
      
      // äºŒå¹´çº§ä¸Š
      'ä¸¤': 7, 'å“ª': 9, 'å®½': 10, 'å°±': 12, 'å­©': 9, 'æ™´': 12, 'è‚š': 7, 'çš®': 5, 'è·³': 13, 'é¡¶': 8, 'ä½œ': 7, 'å‚': 12, 'å˜': 8, 'å¸¦': 9,
      'æ´‹': 9, 'æµ·': 9, 'ç»™': 9, 'å': 7, 'æ': 7, 'ç‰‡': 4, 'è¯†': 7, 'å®ƒ': 5, 'å¦‚': 6, 'å¥¹': 6, 'å¨ƒ': 9, 'æ³•': 8, 'æ¯›': 4, 'æ›´': 7, 'è„š': 11, 'çŸ¥': 8,
      'åš': 11, 'åº•': 8, 'å²': 6, 'ç„¶': 12, 'æ†': 7, 'æŸ±': 9, 'ç§°': 10, 'ç§¤': 10, 'ç«™': 10, 'èˆ¹': 11, 'å€™': 10, 'è¯„': 7, 'åŠ': 3, 'å¥–': 9, 'å¹¶': 6, 'å¹…': 12, 'å¦': 5, 'æŠ¥': 7, 'æ‹¿': 9, 'ç”»': 8,
      'å†™': 5, 'ä»Š': 4, 'ä¿¡': 9, 'å°': 9, 'åœ†': 10, 'ç¯': 6, 'ç¬”': 10, 'ç ': 10, 'æ”¯': 4, 'ç”µ': 5, 'äº‹': 8, 'å…ˆ': 6, 'å‘': 5, 'å“„': 9, 'é—­': 6, 'æ²‰': 7, 'è„¸': 11, 'çª—': 12,
      'ä¾': 8, 'å·': 3, 'å°½': 6, 'å±‚': 7, 'æŒ‚': 9, 'ç…§': 13, 'ç‚‰': 8, 'çƒŸ': 10, 'æ¥¼': 13, 'é»„': 11, 'äº›': 8, 'éƒ¨': 10, 'ä½': 7, 'å‡': 4, 'å—': 9, 'å·¨': 4, 'é—ª': 5, 'æ¯': 7,
      'ä¸½': 7, 'å': 6, 'è¿¹': 9, 'å¤®': 5, 'å': 6, 'å±•': 10, 'æŠ«': 8, 'ç°': 8, 'èƒœ': 9, 'åˆ©': 7, 'å¸‚': 5, 'å®¢': 9, 'å¡': 8, 'åŸ': 9, 'è€': 6, 'æ': 8, 'æ”¶': 6, 'èµ·': 10, 'ä»½': 6,
      'äº•': 4, 'é™…': 7, 'è¯': 8, 'å–': 12, 'æ²¿': 8, 'æ¸´': 12, 'è§‚': 6, 'ç­”': 12, 'é˜µ': 6, 'å´': 7, 'å°†': 9, 'å¤œ': 8, 'æ¯': 9, 'æœ—': 10, 'é¢': 9, 'çº·': 7,
      'é‚»': 7, 'è°¢': 12, 'æ²»': 8, 'æ€ª': 8, 'æ£µ': 12, 'æƒ³': 13, 'ç›¯': 7, 'è¨€': 7, 'ä¸š': 5, 'äº§': 6, 'è®¤': 4, 'é“': 12, 'æ´ª': 9, 'ç¾': 7, 'è¢«': 10, 'éš¾': 10,
      'å†›': 6, 'ä¼': 6, 'å¸ˆ': 6, 'å£«': 3, 'æ‹…': 8, 'æ‰': 9, 'å¿—': 7, 'ç«™': 10, 'åº¦': 9, 'æ³¼': 8, 'ç‚®': 9, 'å¿˜': 7, 'é¾™': 5, 'é˜´': 6, 'ä¼¼': 6, 'è‹': 7, 'èŒ«': 9, 'æƒŠ': 11, 'å±': 6, 'æ•¢': 11, 'é‡': 11,
      'ä¹…': 3, 'åˆ‡': 4, 'äº': 3, 'è®º': 6, 'å²¸': 8, 'å±‹': 9, 'æ•£': 12, 'æ­¥': 7,
      
      // äºŒå¹´çº§ä¸‹
      'è¯—': 8, 'æ‘': 7, 'ç«¥': 12, 'ç¢§': 14, 'å¦†': 6, 'ç»¿': 11, 'ä¸': 5, 'å‰ª': 11, 'å†²': 6, 'å¯»': 6, 'å§‘': 8, 'å¨˜': 10, 'å': 6, 'æŸ³': 9, 'è¡': 9, 'æ¡ƒ': 10, 'æ': 7,
      'é²œ': 14, 'é‚®': 7, 'é€’': 10, 'å‘˜': 7, 'åŸ': 10, 'å”': 8, 'å±€': 7, 'å †': 11, 'ç¤¼': 5, 'é‚“': 4, 'æ¤': 12, 'æ ¼': 10, 'å¼•': 4, 'æ³¨': 8, 'æ»¡': 13, 'ä¼‘': 6, 'æ¯': 10,
      'é”‹': 12, 'æ˜¨': 9, 'å†’': 9, 'ç•™': 10, 'å¼¯': 9, 'èƒŒ': 9, 'æ´’': 9, 'æ¸©': 12, 'æš–': 13, 'èƒ½': 10, 'æ¡Œ': 10, 'å‘³': 8, 'ä¹°': 6, 'å…·': 8, 'ç”˜': 5, 'ç”œ': 11, 'èœ': 11, 'åŠ³': 7,
      'åŒ¹': 4, 'å¦¹': 8, 'æ³¢': 8, 'çº¹': 7, 'åƒ': 14, 'æ™¯': 12, 'æ‹': 10, 'èˆ': 8, 'æ±‚': 7, 'å·': 6, 'æ¹¾': 12, 'å²›': 7, 'å³¡': 9, 'æ°‘': 5, 'æ—': 11, 'è°Š': 10, 'é½': 6, 'å¥‹': 8,
      'è´´': 9, 'è¡—': 12, 'èˆŸ': 6, 'è‰¾': 5, 'æ•¬': 12, 'è½¬': 8, 'å›¢': 6, 'çƒ­': 10, 'é—¹': 8, 'è´': 4, 'å£³': 7, 'ç”²': 5, 'éª¨': 9, 'é’±': 10, 'å¸': 4, 'ä¸': 3, 'è´¢': 7, 'å…³': 6,
      'çƒ§': 10, 'èŒ„': 8, 'çƒ¤': 10, 'é¸­': 10, 'è‚‰': 6, 'é¸¡': 7, 'è›‹': 11, 'ç‚’': 8, 'é¥­': 7, 'å½©': 11, 'æ¢¦': 11, 'æ£®': 12, 'æ‹‰': 8, 'ç»“': 9, 'è‹¹': 8, 'èˆ¬': 10, 'ç²¾': 14, 'çµ': 7,
      'ä¼': 6, 'å§¨': 9, 'å¼Ÿ': 7, 'ä¾¿': 9, 'æ•™': 11, 'æ¸¸': 12, 'æˆ': 6, 'æ¯': 5, 'å‘¨': 8, 'å›´': 7, 'å¥': 5, 'è¡¥': 7, 'å……': 6, 'è¯': 9, 'åˆ': 6, 'æ­»': 6, 'è®°': 5, 'å±': 7, 'è‚¡': 8, 'å°¿': 7, 'å‡€': 8, 'å±': 9, 'å¹¸': 8, 'ä½¿': 8, 'åŠ²': 7,
      'äº¡': 3, 'ç‰¢': 7, 'é’»': 10, 'åŠ': 4, 'ä¸¢': 6, 'å‘Š': 7, 'ç­‹': 12, 'ç–²': 10, 'å›¾': 8, 'è¯¾': 10, 'æ‘†': 13, 'åº§': 10, 'äº¤': 6, 'å“ˆ': 9, 'é¡µ': 6, 'æŠ¢': 7, 'å˜»': 15, 'æ„¿': 14, 'æ„': 13, 'éº¦': 7, 'è¯¥': 8, 'ä¼¯': 7, 'åˆ»': 8, 'çª': 9, 'æ‰': 11,
      'æ¹–': 12, 'è²': 10, 'ç©·': 7, 'è·': 10, 'ç»': 9, 'å«': 7, 'å²­': 8, 'å´': 7, 'é›·': 13, 'ä¹Œ': 4, 'é»‘': 12, 'å‹': 6, 'å‚': 8, 'æˆ·': 4, 'è¿': 7, 'æ‰‘': 5, 'æŒ‡': 9, 'é’ˆ': 10, 'å¸®': 9, 'åŠ©': 7, 'å¯¼': 6, 'æ°¸': 5, 'ç¢°': 13, 'ç‰¹': 10, 'ç§¯': 10,
      'å®‡': 6, 'å®™': 8, 'æ¯': 8, 'å¤±': 5, 'æ¿': 8, 'å®¢': 9, 'æ˜“': 8, 'æµ´': 10, 'å®¤': 9, 'æ‰‡': 10, 'æ…¢': 14, 'é‡': 12, 'å…”': 8, 'å®‰': 6, 'æ ¹': 10, 'ç—›': 12, 'æœ€': 12, 'åº—': 8, 'å†³': 6, 'å®š': 8, 'å•†': 11, 'å¤«': 4, 'ç»ˆ': 8, 'å®Œ': 7, 'æ¢': 10, 'æœŸ': 12, 'è›™': 12, 'å–': 8, 'æ¬': 13, 'å€’': 10, 'ç±½': 9
    };
    const DATA = {
              "1ä¸Š": [
          {unit:1,id:"1-1",title:"ç§‹å¤©",chars:"äº† å­ äºº å¤§"},
          {unit:1,id:"1-2",title:"å°å°çš„èˆ¹",chars:"æœˆ å„¿ å¤´ é‡Œ"},
          {unit:1,id:"1-3",title:"æ±Ÿå—",chars:"å¯ ä¸œ è¥¿"},
          {unit:1,id:"1-4",title:"å››å­£",chars:"å¤© å›› æ˜¯"},
          {unit:2,id:"2-5",title:"å½±å­",chars:"åœ¨ å æˆ‘ å¥½"},
          {unit:2,id:"2-6",title:"æ¯”å°¾å·´",chars:"é•¿ æ¯” å·´ æŠŠ"},
          {unit:2,id:"2-7",title:"é’è›™å†™è¯—",chars:"ä¸‹ ä¸ª é›¨ ä»¬"},
          {unit:2,id:"2-8",title:"é›¨ç‚¹å„¿",chars:"é—® æœ‰ åŠ ä» ä½ "},
          {unit:3,id:"3-9",title:"æ˜å¤©è¦è¿œè¶³",chars:"æ‰ æ˜ åŒ å­¦"},
          {unit:3,id:"3-10",title:"å¤§è¿˜æ˜¯å°",chars:"è‡ª å·± è¡£"},
          {unit:3,id:"3-11",title:"é¡¹é“¾",chars:"ç™½ çš„ åˆ å’Œ"},
          {unit:4,id:"4-12",title:"é›ªåœ°é‡Œçš„å°ç”»å®¶",chars:"ç«¹ ç‰™ é©¬ ç”¨ å‡ "},
          {unit:4,id:"4-13",title:"ä¹Œé¸¦å–æ°´",chars:"åª çŸ³ å¤š å‡º è§"},
          {unit:4,id:"4-14",title:"å°èœ—ç‰›",chars:"å¯¹ å¦ˆ å…¨ å›"}
        ],
      "1ä¸‹": [
          {unit:1,id:"1-1",title:"åƒæ°´ä¸å¿˜æŒ–äº•äºº",chars:"åƒ å« ä¸» æ±Ÿ ä½ æ²¡ ä»¥"},
          {unit:1,id:"1-2",title:"æˆ‘å¤šæƒ³å»çœ‹çœ‹",chars:"ä¼š èµ° åŒ— äº¬ é—¨ å¹¿"},
          {unit:1,id:"1-3",title:"ä¸€ä¸ªæ¥ä¸€ä¸ª",chars:"è¿‡ å„ ç§ æ · ä¼™ ä¼´ è¿™"},
          {unit:1,id:"1-4",title:"å››ä¸ªå¤ªé˜³",chars:"å¤ª é˜³ æ ¡ é‡‘ ç§‹ å›  ä¸º"},
          {unit:2,id:"2-5",title:"å°å…¬é¸¡å’Œå°é¸­å­",chars:"ä»– æ²³ è¯´ ä¹Ÿ åœ° å¬ å“¥"},
          {unit:2,id:"2-6",title:"æ ‘å’Œå–œé¹Š",chars:"ä¹ å• å‘¼ å±… æ‹› å¿«"},
          {unit:2,id:"2-7",title:"æ€ä¹ˆéƒ½å¿«ä¹",chars:"è®² è®¸ å¾ˆ å½“ ç© è¡Œ éŸ³"},
          {unit:3,id:"3-8",title:"é™å¤œæ€",chars:"ä¹¡ å‰ å…‰ ä½ åºŠ æ•… æ€"},
          {unit:3,id:"3-9",title:"å¤œè‰²",chars:"å† å¤– çˆ¸ æ™š çœ‹ è‰² ç¬‘"},
          {unit:3,id:"3-10",title:"ç«¯åˆç²½",chars:"åˆ èŠ‚ å¶ çœŸ ç±³ è±† åˆ†"},
          {unit:3,id:"3-11",title:"å½©è™¹",chars:"å…´ åˆ° é‚£ åƒ æˆ ç€ é«˜"},
          {unit:4,id:"4-12",title:"å¤è¯—äºŒé¦–",chars:"æ—  å°– æ ‘ çˆ± é‡‡ è§’ é¦–"},
          {unit:4,id:"4-13",title:"è·å¶åœ†åœ†",chars:"ç¾ äº® å° æœµ æœº æ”¾ é±¼"},
          {unit:4,id:"4-14",title:"è¦ä¸‹é›¨äº†",chars:"åŠ  è¾¹ å— å§ å‘€ å‘¢ ç›´"},
          {unit:5,id:"5-15",title:"æ£‰èŠ±å§‘å¨˜",chars:"ç—… åŒ» åˆ« å¹² å¥‡ ä¸ƒ æ˜Ÿ"},
          {unit:5,id:"5-16",title:"å’•å’š",chars:"å“ æ€• è·Ÿ å®¶ ç¾Š è±¡ éƒ½"},
          {unit:5,id:"5-17",title:"å°å£è™å€Ÿå°¾å·´",chars:"æ‰ æ¡ çˆ¬ å§ æ‚¨ è‰ æˆ¿"}
        ],
              "2ä¸Š": [
         {unit:1,id:"1-1",title:"å°èŒèšªæ‰¾å¦ˆå¦ˆ",chars:"ä¸¤ å“ª å®½ å°± å­© æ™´ è‚š çš® è·³ é¡¶"},
         {unit:1,id:"1-2",title:"æˆ‘æ˜¯ä»€ä¹ˆ",chars:"ä½œ å‚ å˜ å¸¦ æ´‹ æµ· ç»™ å æ ç‰‡"},
         {unit:1,id:"1-3",title:"æ¤ç‰©å¦ˆå¦ˆæœ‰åŠæ³•",chars:"è¯† å®ƒ å¦‚ å¥¹ å¨ƒ æ³• æ¯› æ›´ è„š çŸ¥"},
         {unit:2,id:"2-4",title:"æ›¹å†²ç§°è±¡",chars:"åš åº• å² ç„¶ æ† æŸ± ç§° ç§¤ ç«™ èˆ¹"},
         {unit:2,id:"2-5",title:"ç²ç²çš„ç”»",chars:"å€™ è¯„ åŠ å¥– å¹¶ å¹… å¦ æŠ¥ æ‹¿ ç”»"},
         {unit:2,id:"2-6",title:"ä¸€å°ä¿¡",chars:"å†™ ä»Š ä¿¡ å° åœ† ç¯ ç¬” ç  æ”¯ ç”µ"},
         {unit:3,id:"3-7",title:"å¦ˆå¦ˆç¡äº†",chars:"äº‹ å…ˆ å‘ å“„ é—­ æ²‰ è„¸ çª—"},
         {unit:3,id:"3-8",title:"å¤è¯—äºŒé¦–",chars:"ä¾ å· å°½ å±‚ æŒ‚ ç…§ ç‚‰ çƒŸ æ¥¼ é»„"},
         {unit:4,id:"4-9",title:"é»„å±±å¥‡çŸ³",chars:"äº› éƒ¨ ä½ å‡ å— å·¨ é—ª æ¯"},
         {unit:4,id:"4-10",title:"æ—¥æœˆæ½­",chars:"ä¸½ å è¿¹ å¤® å å±• æŠ« ç° èƒœ"},
         {unit:4,id:"4-11",title:"è‘¡è„æ²Ÿ",chars:"åˆ© å¸‚ å®¢ å¡ åŸ è€ æ æ”¶ èµ· ä»½"},
         {unit:5,id:"5-12",title:"åäº•è§‚å¤©",chars:"äº• é™… è¯ å– æ²¿ æ¸´ è§‚ ç­”"},
         {unit:5,id:"5-13",title:"å¯’å·é¸Ÿ",chars:"é˜µ å´ å°† å¤œ æ¯ æœ— é¢ çº·"},
         {unit:5,id:"5-14",title:"æˆ‘è¦çš„æ˜¯è‘«èŠ¦",chars:"é‚» è°¢ æ²» æ€ª æ£µ æƒ³ ç›¯ è¨€"},
         {unit:6,id:"6-15",title:"å¤§ç¦¹æ²»æ°´",chars:"ä¸š äº§ è®¤ é“ æ´ª ç¾ è¢« éš¾"},
         {unit:6,id:"6-16",title:"æœ±å¾·çš„æ‰æ‹…",chars:"å†› ä¼ å¸ˆ å£« æ‹… æ‰ å¿— ç«™"},
         {unit:7,id:"7-17",title:"éš¾å¿˜çš„æ³¼æ°´èŠ‚",chars:"åº¦ æ³¼ ç‚® å¿˜ é¾™"},
         {unit:7,id:"7-18",title:"å¤è¯—äºŒé¦–",chars:"é˜´ ä¼¼ è‹ èŒ« æƒŠ å± æ•¢ é‡"},
         {unit:7,id:"7-19",title:"é›¾åœ¨å“ªé‡Œ",chars:"ä¹… åˆ‡ äº è®º å²¸ å±‹ æ•£ æ­¥"}
        ],
      "2ä¸‹": [
        {unit:1,id:"1-1",title:"å¤è¯—äºŒé¦–ï¼ˆæ‘å±…/å’æŸ³ï¼‰",chars:"è¯— æ‘ ç«¥ ç¢§ å¦† ç»¿ ä¸ å‰ª"},
        {unit:1,id:"1-2",title:"æ‰¾æ˜¥å¤©",chars:"å†² å¯» å§‘ å¨˜ å æŸ³ è¡ æ¡ƒ æ"},
        {unit:1,id:"1-3",title:"å¼€æ»¡é²œèŠ±çš„å°è·¯",chars:"é²œ é‚® é€’ å‘˜ åŸ å” å±€ å † ç¤¼"},
        {unit:1,id:"1-4",title:"é‚“å°å¹³çˆ·çˆ·æ¤æ ‘",chars:"é‚“ æ¤ æ ¼ å¼• æ³¨ æ»¡ ä¼‘ æ¯"},
        {unit:2,id:"2-5",title:"é›·é”‹å”å”ï¼Œä½ åœ¨å“ªé‡Œ",chars:"é”‹ æ˜¨ å†’ ç•™ å¼¯ èƒŒ æ´’ æ¸© æš–"},
        {unit:2,id:"2-6",title:"åƒäººç³•",chars:"èƒ½ æ¡Œ å‘³ ä¹° å…· ç”˜ ç”œ èœ åŠ³"},
        {unit:2,id:"2-7",title:"ä¸€åŒ¹å‡ºè‰²çš„é©¬",chars:"åŒ¹ å¦¹ æ³¢ çº¹ åƒ æ™¯ æ‹ èˆ æ±‚"},
        {unit:3,id:"3-8",title:"è¯†å­—1 ç¥å·è°£",chars:"å· æ¹¾ å²› å³¡ æ°‘ æ— è°Š é½ å¥‹"},
        {unit:3,id:"3-9",title:"è¯†å­—2 ä¼ ç»ŸèŠ‚æ—¥",chars:"è´´ è¡— èˆŸ è‰¾ æ•¬ è½¬ å›¢ çƒ­ é—¹"},
        {unit:3,id:"3-10",title:"è¯†å­—3 è´çš„æ•…äº‹",chars:"è´ å£³ ç”² éª¨ é’± å¸ ä¸ è´¢ å…³"},
        {unit:3,id:"3-11",title:"è¯†å­—4 ä¸­å›½ç¾é£Ÿ",chars:"çƒ§ èŒ„ çƒ¤ é¸­ è‚‰ é¸¡ è›‹ ç‚’ é¥­"},
        {unit:4,id:"4-12",title:"å½©è‰²çš„æ¢¦",chars:"å½© æ¢¦ æ£® æ‹‰ ç»“ è‹¹ èˆ¬ ç²¾ çµ"},
        {unit:4,id:"4-13",title:"æ«æ ‘ä¸Šçš„å–œé¹Š",chars:"ä¼ å§¨ å¼Ÿ ä¾¿ æ•™ æ¸¸ æˆ æ¯"},
        {unit:4,id:"4-14",title:"æ²™æ»©ä¸Šçš„ç«¥è¯",chars:"å‘¨ å›´ å¥ è¡¥ å…… è¯ åˆ æ­» è®°"},
        {unit:4,id:"4-15",title:"æˆ‘æ˜¯ä¸€åªå°è™«å­",chars:"å± è‚¡ å°¿ å‡€ å± å¹¸ ä½¿ åŠ²"},
        {unit:5,id:"5-16",title:"å¯“è¨€äºŒåˆ™ï¼ˆäº¡ç¾Šè¡¥ç‰¢/æ è‹—åŠ©é•¿ï¼‰",chars:"äº¡ ç‰¢ é’» åŠ ä¸¢ å‘Š ç­‹ ç–²"},
        {unit:5,id:"5-17",title:"ç”»æ¨æ¡ƒ",chars:"å›¾ è¯¾ æ‘† åº§ äº¤ å“ˆ é¡µ æŠ¢ å˜»"},
        {unit:5,id:"5-18",title:"å°é©¬è¿‡æ²³",chars:"æ„¿ æ„ éº¦ è¯¥ ä¼¯ åˆ» çª æ‰"},
        {unit:6,id:"6-19",title:"å¤è¯—äºŒé¦–ï¼ˆæ™“å‡ºå‡€æ…ˆå¯ºé€æ—å­æ–¹/ç»å¥ï¼‰",chars:"æ¹– è² ç©· è· ç» å« å²­ å´"},
        {unit:6,id:"6-20",title:"é›·é›¨",chars:"é›· ä¹Œ é»‘ å‹ å‚ æˆ· è¿ æ‰‘"},
        {unit:6,id:"6-21",title:"è¦æ˜¯ä½ åœ¨é‡å¤–è¿·äº†è·¯",chars:"æŒ‡ é’ˆ å¸® åŠ© å¯¼ æ°¸ ç¢° ç‰¹ ç§¯"},
        {unit:6,id:"6-22",title:"å¤ªç©ºç”Ÿæ´»è¶£äº‹å¤š",chars:"å®‡ å®™ æ¯ å¤± æ¿ å®¢ æ˜“ æµ´ å®¤"},
        {unit:7,id:"7-23",title:"å¤§è±¡çš„è€³æœµ",chars:"æ‰‡ æ…¢ é‡ å…” å®‰ æ ¹ ç—› æœ€"},
        {unit:7,id:"7-24",title:"èœ˜è››å¼€åº—",chars:"åº— å†³ å®š å•† å¤« ç»ˆ å®Œ æ¢ æœŸ"},
        {unit:7,id:"7-25",title:"é’è›™å–æ³¥å¡˜",chars:"è›™ å– æ¬ å€’ ç±½"}
      ],
      "3ä¸Š": [
        // â˜… ä¸‰å¹´çº§ä¸Šï¼ˆæŒ‰äººæ•™ç‰ˆå¸¸è§ç›®å½•æ•´ç†ï¼›å¯åœ¨"ç¼–è¾‘"é‡Œå¾®è°ƒï¼‰
        { unit: 1, id: "1-1", title: "å¤§é’æ ‘ä¸‹çš„å°å­¦", chars: "æ™¨ ç»’ çƒ æ±‰ è‰³ æœ è£… æ‰® é™ åœ å­” é›€ ç²—" },
        { unit: 1, id: "1-2", title: "èŠ±çš„å­¦æ ¡", chars: "è½ è’ ç¬› èˆ ç‹‚ ç½š å‡ äº’ æ‰€ å¤Ÿ çŒœ æ‰¬ è‡‚" },
        { unit: 2, id: "2-3", title: "å¤è¯—ä¸‰é¦–", chars: "å¯’ å¾„ æ–œ éœœ èµ  åˆ˜ ç›– èŠ æ®‹ å› æ©™ é€ æŒ‘" },
        { unit: 2, id: "2-4", title: "é“ºæ»¡é‡‘è‰²å·´æŒçš„æ°´æ³¥é“", chars: "é“º æ³¥ æ™¶ é™¢ å¢™ å° æ’ åˆ— è§„ åˆ™ ä¹± æ£• è¿Ÿ" },
        { unit: 2, id: "2-5", title: "ç§‹å¤©çš„é›¨", chars: "ç›’ é¢œ æ–™ ç¥¨ é£˜ äº‰ ä»™ æ·¡ é—» æ¢¨ å‹¾ æ›² ä¸°" },
        { unit: 3, id: "3-6", title: "å»å¹´çš„æ ‘", chars: "å†· ç¦» ç­‰ æ–§ ç  è°· æŸ´ ç…¤ æ²¹ è¯‰ ç æ¥" },
        { unit: 3, id: "3-7", title: "åœ¨ç‰›è‚šå­é‡Œæ—…è¡Œ", chars: "æ—… å’± æ€œ æ•‘ å‘½ æ‹¼ æ‰« èƒƒ ç®¡ åˆš æµ æ³ª ç®—" },
        { unit: 4, id: "4-8", title: "æ€»ä¹Ÿå€’ä¸äº†çš„è€å±‹", chars: "æ´ å‡† å¤‡ æš´ å¢™ å£ é¥¿ èœ˜ è›› æ¼‚ æ’ é¥± æ™’" },
        { unit: 5, id: "5-9", title: "æ­èˆ¹çš„é¸Ÿ", chars: "æ­ äº² çˆ¶ æ²™ å•¦ å“ ç¾½ ç¿  å˜´ æ‚„ å å“¦ æ•" },
        { unit: 5, id: "5-10", title: "é‡‘è‰²çš„è‰åœ°", chars: "è’² è‹± ç›› è€ å–Š æ¬  é’“ è€Œ å¯Ÿ æ‹¢ è¶£ å–œ ç¡" },
        { unit: 6, id: "6-11", title: "å¤è¯—ä¸‰é¦–", chars: "æ–­ æ¥š è‡³ å­¤ å¸† é¥® åˆ é•œ æœª ç£¨ é¥ é“¶ ç›˜" },
        { unit: 6, id: "6-12", title: "å¯Œé¥¶çš„è¥¿æ²™ç¾¤å²›", chars: "å¯Œ ä¼˜ æµ… é”™ å²© è™¾ æŒº é¼“ æ•° åš å® è´µ" },
        { unit: 6, id: "6-13", title: "æµ·æ»¨å°åŸ", chars: "æ»¨ ç° æ¸” é èºº è½½ é  æ ½ äºš å¤ é™¤ è¸© æ´" },
        { unit: 6, id: "6-14", title: "ç¾ä¸½çš„å°å…´å®‰å²­", chars: "è„‘ è¢‹ ä¸¥ å® æŒ¡ è§† çº¿ å› æ˜¾ æ è½¯ åˆ® åº“" },
        { unit: 7, id: "7-15", title: "å¤§è‡ªç„¶çš„å£°éŸ³", chars: "å¦™ æ¼” å¥ ç´ æŸ” æ„Ÿ å— æ¿€ å‡» å™¨ æ»´ æ•² é¸£" },
        { unit: 7, id: "7-16", title: "çˆ¶äº²ã€æ ‘æ—å’Œé¸Ÿ", chars: "æœ é›¾ è’™ é¼» æ€» æŠ– éœ² æ¹¿ å¸ çŒ ç¿… è†€ é‡" },
        { unit: 7, id: "7-17", title: "å¸¦åˆºçš„æœ‹å‹", chars: "åˆº æ£ é¢— å¿½ ä¹ æš— ä¼¸ åŒ† æ²Ÿ èª å· è¿½ è…°" },
        { unit: 8, id: "8-18", title: "å¸é©¬å…‰", chars: "å¸ åº­ ç™» è·Œ ä¼— å¼ƒ æŒ" },
        { unit: 8, id: "8-19", title: "æŒå£°", chars: "æŒ ç­ é»˜ è…¿ è½® æŠ• è°ƒ æ‘‡ æ™ƒ çƒˆ å‹‡" },
        { unit: 8, id: "8-20", title: "ç°é›€", chars: "é›€ éƒŠ å…» ç²‰ ç²’ ç”· æˆ– è€… å†» æƒœ è‚¯ è¯š" }
      ],

      "3ä¸‹": [
        // â˜… ä¸‰å¹´çº§ä¸‹ï¼ˆæŒ‰äººæ•™ç‰ˆå¸¸è§ç›®å½•æ•´ç†ï¼›å¯åœ¨â€œç¼–è¾‘â€é‡Œå¾®è°ƒï¼‰
        // ç¬¬ä¸€å•å…ƒ
        {unit:1,id:"1-1",title:"å¤è¯—ä¸‰é¦–",chars:"é¸³ é¸¯ æƒ  å´‡ è±š å‡"},
        {unit:1,id:"1-2",title:"ç‡•å­",chars:"ä¼¶ ä¿ ç¿¼ æ¼¾ å€¦ é—² æ•£ çº¤ æ† ç—•"},
        {unit:1,id:"1-3",title:"è·èŠ±",chars:"æŒ¨ è“¬ èƒ€ ç¿© è¹ˆ"},
        {unit:1,id:"1-4",title:"æ˜†è™«å¤‡å¿˜å½•",chars:"å½• å‡¡ è· æ¬¾ ç»¸ è†œ ç ç›Š çº¦ èš‚ æ–‘"},

        // ç¬¬äºŒå•å…ƒ
        {unit:2,id:"2-5",title:"å®ˆæ ªå¾…å…”",chars:"å®‹ è€• é‡Š å†€"},
        {unit:2,id:"2-6",title:"é™¶ç½å’Œé“ç½",chars:"é™¶ ç½ éª„ è°¦ è™š æ‡¦ å¼± æ¼ ä»£ ä»·"},
        {unit:2,id:"2-7",title:"é¹¿è§’å’Œé¹¿è…¿",chars:"ç§° ç¦ çš± é… æ€¨ ç‹® é€¼ æ’’ æŒ£"},
        {unit:2,id:"2-8",title:"æ± å­ä¸æ²³æµ",chars:"æ»” æ¶¯ å¦‡ ç¢Œ éµ å¾ª å°Š éªŒ"},

        // ç¬¬ä¸‰å•å…ƒ
        {unit:3,id:"3-9",title:"å¤è¯—ä¸‰é¦–",chars:"å±  è‹ é­‚ é…’ ç‰§ å…„ å€"},
        {unit:3,id:"3-10",title:"çº¸çš„å‘æ˜",chars:"åˆ› æº å­˜ åˆ¶ éº» è”¡ ä¼¦ ç´¯ åˆ‡ é²œ æ¬§ æ´² ç¤¾"},
        {unit:3,id:"3-11",title:"èµµå·æ¡¥",chars:"å¿ æ‹± æµ åŒ  è®¡ å² çˆª æ™º æ…§ å†"},
        {unit:3,id:"3-12",title:"ä¸€å¹…åæ‰¬ä¸­å¤–çš„ç”»",chars:"æ‹© éƒ½ å®« æ‘Š è´© å ä½œ æ€ é©´ å¯¸ ä¹˜ ç¬¼ æ  è²Œ"},

        // ç¬¬å››å•å…ƒ
        {unit:4,id:"4-13",title:"èŠ±é’Ÿ",chars:"èŠ¬ èŠ³ å†… ä½œ ç‡¥ ç¼ é€‚ é›… å» ç»„"},
        {unit:4,id:"4-14",title:"èœœèœ‚",chars:"æ¦‚ é˜» æ‹¬ è¯¯ é€† é€” é™Œ è¶…"},
        {unit:4,id:"4-15",title:"å°è™¾",chars:"ç¼¸ éš™ æ€ æœ« å‰¯ é’³ æ è¾ƒ è…¹"},

        // ç¬¬äº”å•å…ƒ
        {unit:5,id:"5-16",title:"å®‡å®™çš„å¦ä¸€è¾¹",chars:"æ·Œ ç§˜ æ ‹ å ç»ª ç¯‡"},
        {unit:5,id:"5-17",title:"æˆ‘å˜æˆäº†ä¸€æ£µæ ‘",chars:"å¸Œ ç—’ é³„ ä¸ é›¶ è‚  é†‹"},

        // ç¬¬å…­å•å…ƒ
        {unit:6,id:"6-18",title:"ç«¥å¹´çš„æ°´å¢¨ç”»",chars:"å¢¨ æŸ“ ç¢ æµª æº… çˆ½"},
        {unit:6,id:"6-19",title:"å‰ƒå¤´å¤§å¸ˆ",chars:"å‰ƒ æ‰§ å¦ éª‚ ä»‡ æƒ¯ åˆ‘ æ›¿ å˜ æ‘¸"},
        {unit:6,id:"6-20",title:"è‚¥çš‚æ³¡",chars:"å»Š å’Œ æ‚  è‹¥ å¨‡ è–„ é¢¤ å· å·… å©´"},
        {unit:6,id:"6-21",title:"æˆ‘ä¸èƒ½å¤±ä¿¡",chars:"è€€ åº† ç›¼ å  æ­‰"},

        // ç¬¬ä¸ƒå•å…ƒ
        {unit:7,id:"7-22",title:"æˆ‘ä»¬å¥‡å¦™çš„ä¸–ç•Œ",chars:"å‘ˆ é›• å¹» è¾‰ èŠ’ å‰‘ å‹"},
        {unit:7,id:"7-23",title:"æµ·åº•ä¸–ç•Œ",chars:"çªƒ ç§ è­¦ è‚Œ ç«  èƒ è¾¾ ç…¤ å‚¨ å±"},
        {unit:7,id:"7-24",title:"ç«çƒ§äº‘",chars:"æª€ å–‚ ç›ˆ å½¤ è·ª åº™ æ¨¡ æ‰"},

        // ç¬¬å…«å•å…ƒ
        {unit:8,id:"8-25",title:"æ…¢æ€§å­è£ç¼å’Œæ€¥æ€§å­é¡¾å®¢",chars:"ç¼ ç®± å¤¸ æ­ª æ‰¿ è¢– è¡¬ è¡« è´Ÿ æ³„ è‰º"},
        {unit:8,id:"8-26",title:"æ–¹å¸½å­åº—",chars:"æ©± æ”¹ è•‰ æ‰£ åš· æºœ ç­’ è‘£"},
        {unit:8,id:"8-27",title:"æ¼",chars:"å©† è„Š è´¼ è« é¢  èƒ¶ æ—‹ çºµ"},
        {unit:8,id:"8-28",title:"æ£æ ¸",chars:"æ ¸ å¦» çˆ¹ çŠ æŠ˜ å›° ç‰² åºœ ç½¢ æ¶¨"},
        ],
    };

    // ========== åº”ç”¨é€»è¾‘ ==========
    const bookSelect = document.getElementById('bookSelect');
    const listEl = document.getElementById('lessonList');
    const progressInfoEl = document.getElementById('progressInfo');
    const currentCardEl = document.getElementById('currentCard');
    const currentHanziEl = document.getElementById('currentHanzi');
    const currentPinyinEl = document.getElementById('currentPinyin');
    
    // å­¦ä¹ çŠ¶æ€
    let currentDeck = [];
    let currentIndex = 0;
    let isStudyMode = false;
    let isDictationMode = false;
    let speechSynthesis = null;
    let currentUtterance = null;

    function groupBy(arr, key){return arr.reduce((m,it)=>((m[it[key]]??=[]).push(it),m),{})}
    function unique(arr){return [...new Set(arr)]}
    function shuffle(arr){const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
    function getPinyinForChar(ch){
      try{
        // æ£€æŸ¥ pinyinPro æ˜¯å¦å¯ç”¨
        if (typeof pinyinPro === 'undefined') {
          console.warn('pinyinPro åº“æœªåŠ è½½');
          return '';
        }
        
        // ä½¿ç”¨ pinyin-pro åº“è·å–æ‹¼éŸ³
        const py = pinyinPro.pinyin(ch, { 
          toneType: 'mark',  // ä½¿ç”¨å£°è°ƒæ ‡è®°
          type: 'string',    // è¿”å›å­—ç¬¦ä¸²è€Œä¸æ˜¯æ•°ç»„
          multiple: false    // åªè¿”å›ç¬¬ä¸€ä¸ªè¯»éŸ³
        });
        
        console.log(`å­—ç¬¦ "${ch}" çš„æ‹¼éŸ³:`, py);
        return py || '';
      }catch(e){ 
        console.warn('è·å–æ‹¼éŸ³å¤±è´¥:', ch, e);
        return ''; 
      }
    }

    function renderLessonList(){
      const book = bookSelect.value;
      const LESSONS = DATA[book] || [];
      const grouped = groupBy(LESSONS,'unit');
      let html = '';
      Object.keys(grouped).sort((a,b)=>+a-+b).forEach(u=>{
        html += `<h4>ç¬¬${u}å•å…ƒ</h4>`;
        grouped[u].forEach(l=>{
          html += `
            <label class="lesson-item">
              <input type="checkbox" data-id="${l.id}" checked>
              <span>${l.title}</span>
            </label>`;
        });
      });
      listEl.innerHTML = html || '<div style="color:#999;padding:6px 4px;">æœ¬å†Œæš‚æ— æ•°æ®</div>';
    }

    function collectChars(){
      const book = bookSelect.value;
      const LESSONS = DATA[book] || [];
      const checks = [...listEl.querySelectorAll('input[type="checkbox"]')].filter(c=>c.checked);
      const chosenIds = new Set(checks.map(c=>c.dataset.id));
      const pool = [];
      
      console.log('å½“å‰å†Œåˆ«:', book); // è°ƒè¯•ä¿¡æ¯
      console.log('é€‰ä¸­çš„è¯¾æ–‡:', chosenIds); // è°ƒè¯•ä¿¡æ¯
      
      LESSONS.forEach(l=>{
        if(chosenIds.size===0 || chosenIds.has(l.id)){
          const chars = (l.chars||'').split(/\s+/).filter(Boolean);
          pool.push(...chars);
        }
      });
      return unique(pool);
    }

    function buildDeck(){
      const pool = collectChars();
      if(pool.length===0){
        progressInfoEl.textContent = 'æ²¡æœ‰å¯ç”¨ç”Ÿå­—ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­é€‰æ‹©è¯¾æ–‡';
        return false;
      }
      
      const studyMode = document.getElementById('studyMode').value;
      if(studyMode === 'random') {
        currentDeck = shuffle(pool).map(ch=>({ch, py:getPinyinForChar(ch)}));
      } else {
        currentDeck = pool.map(ch=>({ch, py:getPinyinForChar(ch)}));
      }
      
      currentIndex = 0;
      isStudyMode = true;
      return true;
    }

    function showCurrentCard(){
      if(!isStudyMode || currentDeck.length === 0) return;
      
      const current = currentDeck[currentIndex];
      currentHanziEl.textContent = current.ch;
      currentPinyinEl.textContent = current.py || 'æš‚æ— æ‹¼éŸ³';
      
      // é‡ç½®å¡ç‰‡çŠ¶æ€
      currentCardEl.classList.remove('flipped');
      
      // æ›´æ–°è¿›åº¦ä¿¡æ¯
      progressInfoEl.textContent = `${currentIndex + 1} / ${currentDeck.length}`;
      
      // æ˜¾ç¤º/éšè—æ§åˆ¶æŒ‰é’®
      document.getElementById('btnNext').style.display = currentIndex < currentDeck.length - 1 ? 'block' : 'none';
      document.getElementById('btnPrev').style.display = currentIndex > 0 ? 'block' : 'none';
    }

    function nextCard(){
      if(currentIndex < currentDeck.length - 1) {
        currentIndex++;
        showCurrentCard();
      }
    }

    function prevCard(){
      if(currentIndex > 0) {
        currentIndex--;
        showCurrentCard();
      }
    }

    function startStudy(){
      if(buildDeck()) {
        const practiceMode = document.getElementById('practiceMode').value;
        
        if(practiceMode === 'dictation') {
          startDictationMode();
        } else {
          showCurrentCard();
          document.getElementById('btnStart').style.display = 'none';
          document.getElementById('btnNext').style.display = 'block';
          document.getElementById('btnPrev').style.display = 'block';
          document.getElementById('btnShuffle').style.display = 'block';
          progressInfoEl.textContent = `1 / ${currentDeck.length}`;
        }
      }
    }

    // ========== å¬å†™åŠŸèƒ½ ==========
    
    // è¯­éŸ³åˆæˆé…ç½®
    let VOICE_CONFIG = {
      // é¢„å½•éŸ³æ–¹æ¡ˆï¼šä½¿ç”¨åœ¨çº¿æ±‰å­—è¯»éŸ³åº“
      usePreRecorded: true,
      // åœ¨çº¿TTS APIé…ç½®
      onlineTTS: {
        provider: 'edge', // 'baidu', 'aliyun', 'tencent', 'edge'
        fallbackToNative: true
      }
    };

    // æ ¹æ®ç”¨æˆ·é€‰æ‹©æ›´æ–°è¯­éŸ³é…ç½®
    function updateVoiceConfig() {
      // å›ºå®šä½¿ç”¨ä¸­ç­‰è´¨é‡ï¼šä¼˜åŒ–TTS
      VOICE_CONFIG.usePreRecorded = false;
      console.log('ğŸ¯ å¯ç”¨ä¸­ç­‰è´¨é‡è¯­éŸ³ï¼ˆä¼˜åŒ–TTSï¼‰');
    }

    function initSpeechSynthesis() {
      if ('speechSynthesis' in window) {
        speechSynthesis = window.speechSynthesis;
        
        // ç­‰å¾…è¯­éŸ³åˆ—è¡¨åŠ è½½
        if (speechSynthesis.getVoices().length === 0) {
          speechSynthesis.addEventListener('voiceschanged', () => {
            console.log('è¯­éŸ³åˆ—è¡¨å·²åŠ è½½');
          });
        }
        
        return true;
      } else {
        console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½');
        return false;
      }
    }

    // è·å–æœ€ä½³ä¸­æ–‡è¯­éŸ³ï¼ˆæµ·å¤–ä¼˜åŒ–ç‰ˆæœ¬ï¼‰
    function getBestChineseVoice() {
      const voices = speechSynthesis.getVoices();
      
      // æµ·å¤–å‹å¥½çš„è¯­éŸ³é€‰æ‹©ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
      const preferredVoices = [
        // Microsoft Edge è¯­éŸ³ï¼ˆæµ·å¤–è´¨é‡æœ€ä½³ï¼‰
        'Microsoft Xiaoxiao Online (Natural) - Chinese (Mainland)',
        'Microsoft Xiaoxiao - Chinese (Simplified, PRC)',
        'Microsoft Yunyang - Chinese (Mainland)',
        'Microsoft Kangkang - Chinese (Mainland)',
        
        // Google Chrome è¯­éŸ³
        'Google æ™®é€šè¯ï¼ˆä¸­å›½å¤§é™†ï¼‰',
        'Google ä¸­æ–‡ï¼ˆä¸­å›½ï¼‰',
        'Chinese (China)',
        
        // Safari è¯­éŸ³ï¼ˆmacOS/iOSï¼‰
        'Ting-Ting (Enhanced)', // macOSå¢å¼ºç‰ˆ
        'Ting-Ting', // macOS
        'Sin-ji', // iOS
        'Mei-Jia', // å°æ¹¾ä¸­æ–‡
        
        // å…¶ä»–ä¸­æ–‡è¯­éŸ³
        'Chinese (Taiwan)',
        'Chinese (Hong Kong)',
        'zh-CN',
        'zh-TW',
        'zh-HK'
      ];
      
      console.log('å¯ç”¨è¯­éŸ³åˆ—è¡¨:', voices.map(v => `${v.name} (${v.lang})`));
      
      for (const preferred of preferredVoices) {
        const voice = voices.find(v => 
          v.name.includes(preferred) || 
          v.name === preferred ||
          (v.lang && (v.lang.includes('zh-CN') || v.lang.includes('zh-TW') || v.lang.includes('zh')))
        );
        if (voice) {
          console.log('âœ… é€‰æ‹©è¯­éŸ³:', voice.name, 'è¯­è¨€:', voice.lang);
          return voice;
        }
      }
      
      // æœ€åå°è¯•ä»»ä½•åŒ…å«ä¸­æ–‡çš„è¯­éŸ³
      const anyChineseVoice = voices.find(v => 
        v.lang && (v.lang.toLowerCase().includes('zh') || v.lang.toLowerCase().includes('chinese'))
      );
      
      if (anyChineseVoice) {
        console.log('âœ… æ‰¾åˆ°ä¸­æ–‡è¯­éŸ³:', anyChineseVoice.name);
        return anyChineseVoice;
      }
      
      console.warn('âš ï¸ æœªæ‰¾åˆ°ä¸­æ–‡è¯­éŸ³ï¼Œä½¿ç”¨é»˜è®¤è¯­éŸ³');
      return voices[0] || null;
    }

    // ä½¿ç”¨é¢„å½•éŸ³æ–¹æ¡ˆï¼ˆæµ·å¤–å‹å¥½çš„åœ¨çº¿è¯­éŸ³æºï¼‰
    async function playPreRecordedAudio(character) {
      // æµ·å¤–å¯ç”¨çš„è¯­éŸ³æºï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
      const audioSources = [
        // Googleç¿»è¯‘è¯­éŸ³ï¼ˆæµ·å¤–å‹å¥½ï¼Œæ— éœ€APIå¯†é’¥ï¼‰
        `https://translate.google.com/translate_tts?ie=UTF-8&tl=zh&client=tw-ob&q=${encodeURIComponent(character)}`,
        
        // æœ‰é“è¯å…¸è¯­éŸ³ï¼ˆé€šå¸¸æµ·å¤–å¯ç”¨ï¼‰
        `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(character)}&type=1`,
        
        // Microsoftç¿»è¯‘è¯­éŸ³ï¼ˆæµ·å¤–å‹å¥½ï¼‰
        `https://www.bing.com/translator/api/language/Speak?locale=zh-Hans&gender=female&media=audio/mp3&text=${encodeURIComponent(character)}`,
        
        // Voice RSSï¼ˆå…è´¹TTSæœåŠ¡ï¼Œæµ·å¤–å¯ç”¨ï¼‰
        `https://api.voicerss.org/?key=demo&hl=zh-cn&c=MP3&f=44khz_16bit_stereo&src=${encodeURIComponent(character)}`,
      ];

      const playBtn = document.getElementById('btnPlayAudio');
      const soundWaves = document.getElementById('soundWaves');

      for (let i = 0; i < audioSources.length; i++) {
        try {
          console.log(`å°è¯•è¯­éŸ³æº ${i + 1}: ${audioSources[i]}`);
          
          const audio = new Audio();
          audio.src = audioSources[i];
          audio.volume = 1.0;
          
          // æ·»åŠ æ’­æ”¾çŠ¶æ€æŒ‡ç¤º
          playBtn.textContent = 'ğŸ”Š æ’­æ”¾ä¸­...';
          playBtn.disabled = true;
          soundWaves.classList.add('playing');
          
          // ç­‰å¾…éŸ³é¢‘åŠ è½½å¹¶æ’­æ”¾
          await new Promise((resolve, reject) => {
            audio.oncanplaythrough = async () => {
              try {
                await audio.play();
                resolve();
              } catch (error) {
                reject(error);
              }
            };
            
            audio.onended = () => {
              playBtn.textContent = 'ğŸ”Š æ’­æ”¾';
              playBtn.disabled = false;
              soundWaves.classList.remove('playing');
              resolve();
            };
            
            audio.onerror = () => {
              playBtn.textContent = 'ğŸ”Š æ’­æ”¾';
              playBtn.disabled = false;
              soundWaves.classList.remove('playing');
              reject(new Error('éŸ³é¢‘åŠ è½½å¤±è´¥'));
            };
            
            // è®¾ç½®è¶…æ—¶
            setTimeout(() => {
              reject(new Error('éŸ³é¢‘åŠ è½½è¶…æ—¶'));
            }, 5000);
          });
          
          console.log(`âœ… è¯­éŸ³æº ${i + 1} æ’­æ”¾æˆåŠŸ`);
          return true;
          
        } catch (error) {
          console.warn(`è¯­éŸ³æº ${i + 1} å¤±è´¥:`, error);
          
          // é‡ç½®çŠ¶æ€
          playBtn.textContent = 'ğŸ”Š æ’­æ”¾';
          playBtn.disabled = false;
          soundWaves.classList.remove('playing');
          
          // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªæºï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
          if (i < audioSources.length - 1) {
            console.log('å°è¯•ä¸‹ä¸€ä¸ªè¯­éŸ³æº...');
            continue;
          }
        }
      }
      
      console.warn('æ‰€æœ‰åœ¨çº¿è¯­éŸ³æºéƒ½å¤±è´¥äº†');
      return false;
    }

    // ä½¿ç”¨é«˜è´¨é‡TTSï¼ˆæµ·å¤–ä¼˜åŒ–ç‰ˆæœ¬ï¼‰
    async function playWithEdgeTTS(character) {
      return new Promise((resolve, reject) => {
        try {
          const utterance = new SpeechSynthesisUtterance(character);
          const voice = getBestChineseVoice();
          
          if (voice) {
            utterance.voice = voice;
            console.log(`ğŸ¯ ä½¿ç”¨è¯­éŸ³: ${voice.name}`);
          } else {
            console.warn('âš ï¸ æœªæ‰¾åˆ°åˆé€‚çš„ä¸­æ–‡è¯­éŸ³');
          }
          
          // é’ˆå¯¹æµ·å¤–ç”¨æˆ·ä¼˜åŒ–çš„è¯­éŸ³è®¾ç½®
          utterance.lang = voice ? voice.lang : 'zh-CN';
          utterance.rate = 0.5; // éå¸¸æ…¢çš„è¯­é€Ÿï¼Œé€‚åˆå„¿ç«¥å­¦ä¹ 
          utterance.pitch = 1.2; // ç¨é«˜éŸ³è°ƒï¼Œæ›´æ¸…æ™°
          utterance.volume = 1.0;
          
          // æ·»åŠ æ’­æ”¾çŠ¶æ€
          const playBtn = document.getElementById('btnPlayAudio');
          const soundWaves = document.getElementById('soundWaves');
          
          utterance.onstart = () => {
            playBtn.textContent = 'ğŸ”Š æ’­æ”¾ä¸­...';
            playBtn.disabled = true;
            soundWaves.classList.add('playing');
          };
          
          utterance.onend = () => {
            playBtn.textContent = 'ğŸ”Š æ’­æ”¾';
            playBtn.disabled = false;
            soundWaves.classList.remove('playing');
            resolve(true);
          };
          
          utterance.onerror = (event) => {
            console.error('ä¼˜åŒ–TTSæ’­æ”¾å¤±è´¥:', event);
            playBtn.textContent = 'ğŸ”Š æ’­æ”¾';
            playBtn.disabled = false;
            soundWaves.classList.remove('playing');
            reject(new Error('TTSæ’­æ”¾å¤±è´¥'));
          };
          
          // ç¡®ä¿åœæ­¢ä¹‹å‰çš„æ’­æ”¾
          speechSynthesis.cancel();
          
          // ç­‰å¾…ä¸€å°æ®µæ—¶é—´å†æ’­æ”¾ï¼Œç¡®ä¿cancelç”Ÿæ•ˆ
          setTimeout(() => {
            speechSynthesis.speak(utterance);
          }, 100);
          
        } catch (error) {
          console.warn('ä¼˜åŒ–TTSåˆå§‹åŒ–å¤±è´¥:', error);
          reject(error);
        }
      });
    }

    // æ·»åŠ ç‰¹æ®Šçš„è¯­éŸ³å¢å¼ºå‡½æ•°ï¼ˆé’ˆå¯¹æµ·å¤–ç”¨æˆ·ï¼‰
    async function playWithEnhancedTTS(character) {
      return new Promise((resolve, reject) => {
        try {
          // ä¸ºå•ä¸ªæ±‰å­—æ·»åŠ é€‚å½“çš„åœé¡¿å’Œé‡éŸ³
          const enhancedText = character;
          
          const utterance = new SpeechSynthesisUtterance(enhancedText);
          const voice = getBestChineseVoice();
          
          if (voice) {
            utterance.voice = voice;
          }
          
          // ç‰¹åˆ«ä¼˜åŒ–çš„è®¾ç½®
          utterance.lang = 'zh-CN';
          utterance.rate = 0.4; // ææ…¢è¯­é€Ÿ
          utterance.pitch = 1.3; // é«˜éŸ³è°ƒ
          utterance.volume = 1.0;
          
          const playBtn = document.getElementById('btnPlayAudio');
          const soundWaves = document.getElementById('soundWaves');
          
          utterance.onstart = () => {
            playBtn.textContent = 'ğŸ”Š æ’­æ”¾ä¸­...';
            playBtn.disabled = true;
            soundWaves.classList.add('playing');
          };
          
          utterance.onend = () => {
            playBtn.textContent = 'ğŸ”Š æ’­æ”¾';
            playBtn.disabled = false;
            soundWaves.classList.remove('playing');
            resolve(true);
          };
          
          utterance.onerror = (event) => {
            playBtn.textContent = 'ğŸ”Š æ’­æ”¾';
            playBtn.disabled = false;
            soundWaves.classList.remove('playing');
            reject(new Error('å¢å¼ºTTSæ’­æ”¾å¤±è´¥'));
          };
          
          speechSynthesis.cancel();
          setTimeout(() => {
            speechSynthesis.speak(utterance);
          }, 150);
          
        } catch (error) {
          reject(error);
        }
      });
    }

    // æ™ºèƒ½è¯­éŸ³æ’­æ”¾å‡½æ•°ï¼ˆæµ·å¤–ä¼˜åŒ–å¤šæ–¹æ¡ˆé™çº§ï¼‰
    async function speakText(text) {
      // é˜²æ­¢é‡å¤æ’­æ”¾
      const playBtn = document.getElementById('btnPlayAudio');
      if (playBtn.textContent.includes('æ’­æ”¾ä¸­')) {
        return;
      }

      const quality = 'medium'; // å›ºå®šä½¿ç”¨ä¸­ç­‰è´¨é‡
      let success = false;

      console.log(`ğŸ¯ å¼€å§‹è¯­éŸ³æ’­æ”¾ï¼Œè´¨é‡è®¾ç½®: ${quality}ï¼Œå­—ç¬¦: ${text}`);

      // æ–¹æ¡ˆ1: ä½¿ç”¨åœ¨çº¿é¢„å½•éŸ³ï¼ˆä»…åœ¨é«˜è´¨é‡æ¨¡å¼ä¸‹ï¼‰
      if (quality === 'high' && VOICE_CONFIG.usePreRecorded) {
        try {
          console.log('ğŸŒ å°è¯•åœ¨çº¿è¯­éŸ³æœåŠ¡...');
          success = await playPreRecordedAudio(text);
          if (success) {
            console.log('âœ… åœ¨çº¿è¯­éŸ³æ’­æ”¾æˆåŠŸ');
            return;
          }
        } catch (error) {
          console.warn('åœ¨çº¿è¯­éŸ³å¤±è´¥:', error);
        }
      }

      // æ–¹æ¡ˆ2: ä½¿ç”¨å¢å¼ºTTSï¼ˆä¸­é«˜è´¨é‡æ¨¡å¼ï¼‰
      if (!success && (quality === 'high' || quality === 'medium')) {
        try {
          console.log('ğŸ¯ å°è¯•å¢å¼ºTTS...');
          success = await playWithEnhancedTTS(text);
          if (success) {
            console.log('âœ… å¢å¼ºTTSæ’­æ”¾æˆåŠŸ');
            return;
          }
        } catch (error) {
          console.warn('å¢å¼ºTTSå¤±è´¥:', error);
        }
      }

      // æ–¹æ¡ˆ3: ä½¿ç”¨ä¼˜åŒ–TTS
      if (!success) {
        try {
          console.log('ğŸ® å°è¯•ä¼˜åŒ–TTS...');
          success = await playWithEdgeTTS(text);
          if (success) {
            console.log('âœ… ä¼˜åŒ–TTSæ’­æ”¾æˆåŠŸ');
            return;
          }
        } catch (error) {
          console.warn('ä¼˜åŒ–TTSå¤±è´¥:', error);
        }
      }

      // æ–¹æ¡ˆ4: é™çº§åˆ°åŸºç¡€Web Speech API
      if (!success) {
        try {
          console.log('ğŸ”„ ä½¿ç”¨åŸºç¡€TTS...');
          await playWithNativeTTS(text);
          console.log('âœ… åŸºç¡€TTSæ’­æ”¾æˆåŠŸ');
        } catch (error) {
          console.error('âŒ æ‰€æœ‰è¯­éŸ³æ–¹æ¡ˆéƒ½å¤±è´¥äº†:', error);
          
          // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
          const playBtn = document.getElementById('btnPlayAudio');
          const soundWaves = document.getElementById('soundWaves');
          
          playBtn.textContent = 'ğŸ”Š æ’­æ”¾å¤±è´¥';
          playBtn.disabled = false;
          soundWaves.classList.remove('playing');
          
          // æ˜¾ç¤ºç”¨æˆ·æç¤º
          setTimeout(() => {
            playBtn.textContent = 'ğŸ”Š æ’­æ”¾';
            alert('è¯­éŸ³æ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼š\n\n1. ç½‘ç»œè¿æ¥é—®é¢˜\n2. æµè§ˆå™¨ä¸æ”¯æŒä¸­æ–‡è¯­éŸ³\n3. ç³»ç»Ÿæœªå®‰è£…ä¸­æ–‡è¯­éŸ³åŒ…\n\nå»ºè®®ï¼š\nâ€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥\nâ€¢ ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨\nâ€¢ åœ¨è®¾ç½®ä¸­é™ä½è¯­éŸ³è´¨é‡');
          }, 2000);
        }
      }
    }

    // åŸºç¡€Web Speech APIæ’­æ”¾ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
    async function playWithNativeTTS(text) {
      return new Promise((resolve, reject) => {
        if (!speechSynthesis) {
          if (!initSpeechSynthesis()) {
            reject(new Error('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½'));
            return;
          }
        }

        // åœæ­¢å½“å‰æ’­æ”¾çš„è¯­éŸ³
        speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        const voice = getBestChineseVoice();
        
        if (voice) {
          utterance.voice = voice;
        }
        
        // ä¼˜åŒ–çš„è¯­éŸ³è®¾ç½®
        utterance.lang = 'zh-CN';
        utterance.rate = 0.6; // æ›´æ…¢çš„è¯­é€Ÿ
        utterance.pitch = 1.1; // ç¨é«˜éŸ³è°ƒï¼Œæ›´æ¸…æ™°
        utterance.volume = 1.0;

        // æ’­æ”¾çŠ¶æ€ç®¡ç†
        const playBtn = document.getElementById('btnPlayAudio');
        const soundWaves = document.getElementById('soundWaves');

        utterance.onstart = () => {
          soundWaves.classList.add('playing');
          playBtn.textContent = 'ğŸ”Š æ’­æ”¾ä¸­...';
          playBtn.disabled = true;
        };

        utterance.onend = () => {
          soundWaves.classList.remove('playing');
          playBtn.textContent = 'ğŸ”Š æ’­æ”¾';
          playBtn.disabled = false;
          resolve();
        };

        utterance.onerror = (event) => {
          console.error('åŸç”ŸTTSæ’­æ”¾é”™è¯¯:', event);
          soundWaves.classList.remove('playing');
          playBtn.textContent = 'ğŸ”Š æ’­æ”¾';
          playBtn.disabled = false;
          reject(new Error('åŸç”ŸTTSæ’­æ”¾å¤±è´¥'));
        };

        speechSynthesis.speak(utterance);
      });
    }

    function startDictationMode() {
      isDictationMode = true;
      
      // æ›´æ–°è¯­éŸ³é…ç½®
      updateVoiceConfig();
      
      // æ˜¾ç¤ºå¬å†™ç•Œé¢ï¼Œéšè—è¯†å­—å¡
      document.getElementById('dictationContainer').style.display = 'block';
      document.getElementById('currentCard').parentElement.style.display = 'none';
      
      // æ˜¾ç¤ºå¬å†™æ§åˆ¶æŒ‰é’®ï¼Œéšè—è¯†å­—å¡æŒ‰é’®
      document.getElementById('btnStart').style.display = 'none';
      document.getElementById('btnNext').style.display = 'none';
      document.getElementById('btnPrev').style.display = 'none';
      document.getElementById('btnShuffle').style.display = 'none';
      
      document.getElementById('btnCheck').style.display = 'block';
      document.getElementById('btnNextDictation').style.display = 'none';
      document.getElementById('btnReplay').style.display = 'block';
      
      // åˆå§‹åŒ–è¯­éŸ³åŠŸèƒ½
      initSpeechSynthesis();
      
      // æ˜¾ç¤ºè¯­éŸ³è´¨é‡æç¤º
      const quality = 'medium'; // å›ºå®šä½¿ç”¨ä¸­ç­‰è´¨é‡
      const qualityText = {
        'medium': 'ä¸­ç­‰è´¨é‡ç³»ç»Ÿè¯­éŸ³'
      };
      
      console.log(`ğŸ¯ å¬å†™æ¨¡å¼å¯åŠ¨ï¼Œä½¿ç”¨ ${qualityText[quality]}`);
      
      // æ˜¾ç¤ºå½“å‰é¢˜ç›®
      showCurrentDictation();
      
      // è‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€ä¸ªå­—çš„è¯»éŸ³
      setTimeout(() => {
        playCurrentCharAudio();
      }, 500);
    }

    function showCurrentDictation() {
      if(!isDictationMode || currentDeck.length === 0) return;
      
      const current = currentDeck[currentIndex];
      
      // æ¸…ç©ºè¾“å…¥æ¡†å’Œç»“æœåŒºåŸŸ
      const inputEl = document.getElementById('dictationInput');
      const resultEl = document.getElementById('resultArea');
      
      inputEl.value = '';
      inputEl.className = '';
      resultEl.style.display = 'none';
      resultEl.className = 'result-area';
      
      // é‡ç½®æ‹¼éŸ³æ˜¾ç¤º
      document.getElementById('dictationPinyin').textContent = 'ç‚¹å‡»æ’­æ”¾å¬å£°éŸ³';
      
      // æ›´æ–°è¿›åº¦
      progressInfoEl.textContent = `å¬å†™ç»ƒä¹  ${currentIndex + 1} / ${currentDeck.length}`;
      
      // æ§åˆ¶æŒ‰é’®çŠ¶æ€
      document.getElementById('btnCheck').style.display = 'block';
      document.getElementById('btnNextDictation').style.display = 'none';
      
      // èšç„¦è¾“å…¥æ¡†
      inputEl.focus();
    }

    function playCurrentCharAudio() {
      if(!isDictationMode || currentDeck.length === 0) return;
      
      const current = currentDeck[currentIndex];
      
      // æ˜¾ç¤ºæ‹¼éŸ³æç¤ºï¼ˆæ’­æ”¾åæ˜¾ç¤ºï¼‰
      setTimeout(() => {
        document.getElementById('dictationPinyin').textContent = current.py || 'æš‚æ— æ‹¼éŸ³';
      }, 100);
      
      // æ’­æ”¾æ±‰å­—è¯»éŸ³
      speakText(current.ch);
    }

    function checkDictationAnswer() {
      const inputEl = document.getElementById('dictationInput');
      const resultEl = document.getElementById('resultArea');
      const userAnswer = inputEl.value.trim();
      const correctAnswer = currentDeck[currentIndex].ch;
      const correctPinyin = currentDeck[currentIndex].py;
      
      if(!userAnswer) {
        alert('è¯·å…ˆè¾“å…¥ç­”æ¡ˆ');
        return;
      }
      
      const isCorrect = userAnswer === correctAnswer;
      
      // æ˜¾ç¤ºç»“æœ
      resultEl.style.display = 'block';
      
      if(isCorrect) {
        resultEl.className = 'result-area correct';
        document.getElementById('resultIcon').textContent = 'âœ“';
        document.getElementById('resultText').textContent = 'å›ç­”æ­£ç¡®ï¼';
        inputEl.className = 'correct';
      } else {
        resultEl.className = 'result-area incorrect';
        document.getElementById('resultIcon').textContent = 'âœ—';
        document.getElementById('resultText').textContent = 'ç­”æ¡ˆä¸å¯¹ï¼Œå†è¯•è¯•å§';
        inputEl.className = 'incorrect';
      }
      
      // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
      document.getElementById('correctAnswer').textContent = correctAnswer;
      document.getElementById('correctPinyin').textContent = correctPinyin || '';
      
      // æ§åˆ¶æŒ‰é’®çŠ¶æ€
      document.getElementById('btnCheck').style.display = 'none';
      if(currentIndex < currentDeck.length - 1) {
        document.getElementById('btnNextDictation').style.display = 'block';
      } else {
        document.getElementById('btnNextDictation').textContent = 'å®Œæˆç»ƒä¹ ';
        document.getElementById('btnNextDictation').style.display = 'block';
      }
    }

    function nextDictation() {
      if(currentIndex < currentDeck.length - 1) {
        currentIndex++;
        showCurrentDictation();
        // è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ªå­—
        setTimeout(() => {
          playCurrentCharAudio();
        }, 300);
      } else {
        // ç»ƒä¹ å®Œæˆ
        finishDictation();
      }
    }

    function finishDictation() {
      // è®¡ç®—æ­£ç¡®ç‡ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥è®°å½•æ¯ä¸ªå­—çš„æ­£ç¡®æ€§ï¼‰
      const totalChars = currentDeck.length;
      alert(`ğŸ‰ å¬å†™ç»ƒä¹ å®Œæˆï¼\n\nğŸ“Š ç»ƒä¹ ç»Ÿè®¡ï¼š\nâ€¢ æ€»å­—æ•°ï¼š${totalChars} ä¸ª\nâ€¢ ç»ƒä¹ æ¨¡å¼ï¼šå¬å†™è®­ç»ƒ\n\nğŸ’¡ æç¤ºï¼šå¯ä»¥å¤šæ¬¡ç»ƒä¹ æ¥åŠ æ·±è®°å¿†ï¼\n\nç‚¹å‡»ç¡®å®šè¿”å›ä¸»ç•Œé¢ã€‚`);
      resetStudy();
    }

    // æ·»åŠ è§¦æ‘¸è®¾å¤‡çš„ä¼˜åŒ–
    function optimizeForTouch() {
      // æ£€æµ‹è§¦æ‘¸è®¾å¤‡
      if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
        // ä¸ºè§¦æ‘¸è®¾å¤‡æ·»åŠ é¢å¤–çš„äº¤äº’æ”¹è¿›
        const inputEl = document.getElementById('dictationInput');
        
        // é˜²æ­¢ç§»åŠ¨ç«¯é”®ç›˜é®æŒ¡
        inputEl.addEventListener('focus', () => {
          setTimeout(() => {
            inputEl.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'center',
              inline: 'nearest'
            });
          }, 300);
        });
        
        // ä¼˜åŒ–è½¯é”®ç›˜ä½“éªŒ
        inputEl.addEventListener('blur', () => {
          // è½¯é”®ç›˜æ”¶èµ·åé‡æ–°è°ƒæ•´è§†å›¾
          setTimeout(() => {
            window.scrollTo(0, 0);
          }, 100);
        });
      }
    }

    function shuffleCurrentDeck(){
      if(!isStudyMode || currentDeck.length === 0) return;
      
      // æ‰“ä¹±é¡ºåº
      currentDeck = shuffle(currentDeck);
      
      // è‡ªåŠ¨å›åˆ°ç¬¬ä¸€ä¸ªç”Ÿå­—
      currentIndex = 0;
      
      // æ˜¾ç¤ºå½“å‰å¡ç‰‡
      showCurrentCard();
      
      // æ˜¾ç¤ºæç¤º
      progressInfoEl.textContent = `1 / ${currentDeck.length} (å·²éšæœº)`;
      setTimeout(() => {
        progressInfoEl.textContent = `1 / ${currentDeck.length}`;
      }, 2000);
    }

    // ========== æ‰“å°åŠŸèƒ½ ==========
    
    // è·å–ç¬”ç”»æ•°
    function getStrokeCount(char) {
      return STROKE_ORDER[char] || '?';
    }
    
    // æ›´æ–°æ‰“å°ç”Ÿå­—åˆ—è¡¨æ˜¾ç¤º
    function updatePrintCharsList() {
      const charsListEl = document.getElementById('printCharsList');
      
      if (!charsListEl) {
        console.error('æ‰¾ä¸åˆ° printCharsList å…ƒç´ ');
        return;
      }
      
      // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      charsListEl.innerHTML = '<span style="color: #666;">æ­£åœ¨æ”¶é›†ç”Ÿå­—...</span>';
      
      // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²å‡†å¤‡å¥½
      setTimeout(() => {
        const chars = collectChars();
        
        console.log('æ”¶é›†åˆ°çš„ç”Ÿå­—:', chars); // è°ƒè¯•ä¿¡æ¯
        
        if (!chars || chars.length === 0) {
          charsListEl.innerHTML = '<span style="color: #ff6b6b;">âš ï¸ æ²¡æœ‰å¯æ‰“å°çš„ç”Ÿå­—ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­é€‰æ‹©è¯¾æ–‡</span>';
          return;
        }
        
        // æŒ‰æ¯è¡Œæ˜¾ç¤º10ä¸ªå­—ç¬¦
        let html = `<div style="margin-bottom: 8px;"><strong>å…± ${chars.length} ä¸ªç”Ÿå­—ï¼š</strong></div>`;
        html += '<div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">';
        
        chars.forEach((char, index) => {
          const strokeCount = getStrokeCount(char);
          html += `<span style="display: inline-block; padding: 4px 8px; background: #fff; border: 1px solid var(--border); border-radius: 4px; font-size: 16px; font-weight: bold;">${char}</span>`;
          
          // æ¯è¡Œæ˜¾ç¤º10ä¸ªå­—ç¬¦åæ¢è¡Œ
          if ((index + 1) % 10 === 0) {
            html += '<br>';
          }
        });
        
        html += '</div>';
        
        // æ·»åŠ ç¬”ç”»æ•°ç»Ÿè®¡
        const strokeCounts = chars.map(char => getStrokeCount(char)).filter(count => count !== '?');
        if (strokeCounts.length > 0) {
          const avgStrokes = (strokeCounts.reduce((sum, count) => sum + count, 0) / strokeCounts.length).toFixed(1);
          html += `<div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">å¹³å‡ç¬”ç”»æ•°ï¼š${avgStrokes}ç”»</div>`;
        }
        
        charsListEl.innerHTML = html;
      }, 100);
    }
    
    // ç”Ÿæˆç”°å­—æ ¼HTML
    function generateTianziGrid(char, showStrokeOrder = false, isTraceMode = false) {
      const strokeCount = getStrokeCount(char);
      const strokeOrderHtml = showStrokeOrder ? `<div class="tianzi-stroke-order">${strokeCount}</div>` : '';
      const traceClass = isTraceMode ? ' trace' : '';
      
      return `
        <div class="tianzi-grid">
          <div class="tianzi-char${traceClass}">${char}</div>
          ${strokeOrderHtml}
        </div>
      `;
    }
    
    // ç”Ÿæˆæ‰“å°å†…å®¹
    function generatePrintContent() {
      const chars = collectChars();
      if (chars.length === 0) {
        alert('æ²¡æœ‰å¯æ‰“å°çš„ç”Ÿå­—ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­é€‰æ‹©è¯¾æ–‡');
        return null;
      }
      
      const isTraceMode = document.getElementById('printTraceMode').checked;
      
      let html = `
        <div class="print-page">
          <div class="print-grid-container">
      `;
      
      if (isTraceMode) {
        // æå­—æ¨¡å¼ï¼šæ¯è¡Œ9ä¸ªç”°å­—æ ¼éƒ½å†™ç”Ÿå­—ï¼ˆç©ºå¿ƒå­—ï¼‰
        chars.forEach((char, index) => {
          // æ¯è¡Œ9ä¸ªç”°å­—æ ¼éƒ½å†™ç”Ÿå­—
          for (let i = 0; i < 9; i++) {
            html += generateTianziGrid(char, false, true);
          }
          
          // æ¯è¡Œ9ä¸ªç”°å­—æ ¼åæ¢è¡Œ
          html += '<br>';
        });
      } else {
        // é»˜è®¤æ¨¡å¼ï¼šæ¯è¡Œç¬¬ä¸€ä¸ªç”°å­—æ ¼å†™ç”Ÿå­—ï¼Œå‰©ä¸‹8ä¸ªéƒ½æ˜¯ç©ºçš„
        chars.forEach((char, index) => {
          // ç¬¬ä¸€ä¸ªç”°å­—æ ¼å†™ç”Ÿå­—
          html += generateTianziGrid(char, false, false);
          
          // å‰©ä¸‹8ä¸ªç”°å­—æ ¼éƒ½æ˜¯ç©ºçš„
          for (let i = 0; i < 8; i++) {
            html += generateTianziGrid('', false, false);
          }
          
          // æ¯è¡Œ9ä¸ªç”°å­—æ ¼åæ¢è¡Œ
          html += '<br>';
        });
      }
      
      html += `
          </div>
        </div>
      `;
      
      return html;
    }
    
    // æ‰§è¡Œæ‰“å°
    function executePrint() {
      const printHtml = generatePrintContent();
      if (!printHtml) return;
      
      // åˆ›å»ºæ‰“å°çª—å£
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>ç”°å­—æ ¼ç”Ÿå­—ç»ƒä¹ </title>
          <style>
            body { margin: 0; padding: 0; font-family: 'SimSun', 'å®‹ä½“', serif; }
            .tianzi-grid {
              display: inline-block;
              width: 18mm;
              height: 18mm;
              border: 1px solid #000;
              position: relative;
              margin: 0;
              vertical-align: top;
              box-sizing: border-box;
            }
            .tianzi-grid::before {
              content: '';
              position: absolute;
              top: 50%;
              left: 0;
              right: 0;
              height: 1px;
              background: #000;
              border-top: 1px dashed #000;
              transform: translateY(-50%);
            }
            .tianzi-grid::after {
              content: '';
              position: absolute;
              left: 50%;
              top: 0;
              bottom: 0;
              width: 1px;
              background: #000;
              border-left: 1px dashed #000;
              transform: translateX(-50%);
            }
            .tianzi-char {
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              font-size: 14mm;
              font-weight: normal;
              line-height: 1;
              font-family: 'KaiTi', 'æ¥·ä½“', 'STKaiti', 'åæ–‡æ¥·ä½“', 'STKaiti', 'SimKai', serif;
              color: transparent;
              -webkit-text-stroke: 0.5px #000;
            }
            .tianzi-char.trace {
              color: transparent;
              -webkit-text-stroke: 0.5px #000;
            }
            .tianzi-stroke-order {
              position: absolute;
              top: 2px;
              right: 2px;
              font-size: 8px;
              color: #666;
              line-height: 1;
            }
            .print-page {
              width: 210mm;
              min-height: 297mm;
              margin: 0 auto;
              padding: 20mm;
              background: white;
              font-family: 'SimSun', 'å®‹ä½“', serif;
              font-size: 12pt;
              line-height: 1.5;
              box-sizing: border-box;
            }
            .print-grid-container {
              display: block;
              margin-bottom: 20px;
              line-height: 0;
            }
            @media print {
              body { margin: 0; padding: 0; }
              .print-page {
                width: 100%;
                margin: 0;
                padding: 20mm;
                box-sizing: border-box;
              }
              .tianzi-grid {
                break-inside: avoid;
              }
              .tianzi-char {
                color: transparent !important;
                -webkit-text-stroke: 0.5px #000 !important;
                font-weight: normal !important;
              }
            }
          </style>
        </head>
        <body>
          ${printHtml}
        </body>
        </html>
      `);
      
      printWindow.document.close();
      
      // ç­‰å¾…å†…å®¹åŠ è½½å®Œæˆåæ‰“å°
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 500);
      };
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.getElementById('btnSelectAll').onclick = ()=>{listEl.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=true)};
    document.getElementById('btnClear').onclick = ()=>{listEl.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false)};
    document.getElementById('btnStart').onclick = startStudy;
    document.getElementById('btnNext').onclick = nextCard;
    document.getElementById('btnPrev').onclick = prevCard;
    document.getElementById('btnShuffle').onclick = shuffleCurrentDeck;
    document.getElementById('btnStartStudy').onclick = ()=>{startStudy(); document.getElementById('settingsModal').classList.remove('show');};
    document.getElementById('btnSettings').onclick = ()=>{document.getElementById('settingsModal').classList.add('show');};
    document.getElementById('btnCloseSettings').onclick = ()=>{document.getElementById('settingsModal').classList.remove('show');};
    currentCardEl.addEventListener('click', ()=>{currentCardEl.classList.toggle('flipped')});
    bookSelect.addEventListener('change', ()=>{renderLessonList(); resetStudy()});
    
    // æ‰“å°åŠŸèƒ½äº‹ä»¶ç»‘å®š
    console.log('å¼€å§‹ç»‘å®šæ‰“å°æŒ‰é’®äº‹ä»¶...');
    const printBtn = document.getElementById('btnPrint');
    console.log('æ‰“å°æŒ‰é’®å…ƒç´ :', printBtn);
    if (printBtn) {
      printBtn.onclick = ()=>{
      console.log('æ‰“å°æŒ‰é’®è¢«ç‚¹å‡»');
      // ç¡®ä¿è¯¾æ–‡åˆ—è¡¨å·²ç»æ¸²æŸ“
      if (listEl.innerHTML.includes('æœ¬å†Œæš‚æ— æ•°æ®') || listEl.querySelectorAll('input[type="checkbox"]').length === 0) {
        renderLessonList();
      }
      updatePrintCharsList();
      const printModal = document.getElementById('printModal');
      console.log('æ‰¾åˆ°printModalå…ƒç´ :', printModal);
      if (printModal) {
        printModal.classList.add('show');
        printModal.style.display = 'flex';
        printModal.style.visibility = 'visible';
        console.log('å·²æ·»åŠ showç±»å¹¶è®¾ç½®display');
      } else {
        console.error('æœªæ‰¾åˆ°printModalå…ƒç´ ');
      }
      };
    } else {
      console.error('æœªæ‰¾åˆ°æ‰“å°æŒ‰é’®å…ƒç´ ');
    }
    document.getElementById('btnCancelPrint').onclick = ()=>{
      const printModal = document.getElementById('printModal');
      printModal.classList.remove('show');
      printModal.style.display = 'none';
      printModal.style.visibility = 'hidden';
    };
    document.getElementById('btnConfirmPrint').onclick = ()=>{executePrint(); document.getElementById('printModal').classList.remove('show');};
    
    // å¬å†™åŠŸèƒ½äº‹ä»¶ç»‘å®š
    document.getElementById('btnPlayAudio').onclick = playCurrentCharAudio;
    document.getElementById('btnCheck').onclick = checkDictationAnswer;
    document.getElementById('btnNextDictation').onclick = nextDictation;
    document.getElementById('btnReplay').onclick = playCurrentCharAudio;
    
    // å¬å†™è¾“å…¥æ¡†å›è½¦é”®æ£€æŸ¥ç­”æ¡ˆ
    document.getElementById('dictationInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const checkBtn = document.getElementById('btnCheck');
        const nextBtn = document.getElementById('btnNextDictation');
        
        if (checkBtn.style.display !== 'none') {
          checkDictationAnswer();
        } else if (nextBtn.style.display !== 'none') {
          nextDictation();
        }
      }
    });
    
    function resetStudy(){
      isStudyMode = false;
      isDictationMode = false;
      currentDeck = [];
      currentIndex = 0;
      
      // åœæ­¢è¯­éŸ³æ’­æ”¾
      if(speechSynthesis) {
        speechSynthesis.cancel();
      }
      
      // é‡ç½®ç•Œé¢æ˜¾ç¤º
      document.getElementById('dictationContainer').style.display = 'none';
      document.getElementById('currentCard').parentElement.style.display = 'flex';
      
      // é‡ç½®æŒ‰é’®çŠ¶æ€
      document.getElementById('btnStart').style.display = 'block';
      document.getElementById('btnNext').style.display = 'none';
      document.getElementById('btnPrev').style.display = 'none';
      document.getElementById('btnShuffle').style.display = 'none';
      
      // éšè—å¬å†™æŒ‰é’®
      document.getElementById('btnCheck').style.display = 'none';
      document.getElementById('btnNextDictation').style.display = 'none';
      document.getElementById('btnReplay').style.display = 'none';
      
      progressInfoEl.textContent = 'ç‚¹å‡»"å¼€å§‹å­¦ä¹ "å¼€å§‹è¯†å­—';
      currentHanziEl.textContent = 'å­—';
      currentPinyinEl.textContent = 'zÃ¬';
      currentCardEl.classList.remove('flipped');
    }

    // ========== æ•°æ®ç¼–è¾‘å™¨ ==========
    const editModal = document.getElementById('editModal');
    const jsonArea = document.getElementById('jsonArea');
    const btnCancelEdit = document.getElementById('btnCancelEdit');
    const btnSave = document.getElementById('btnSave');
    const btnDownload = document.getElementById('btnDownload');

    // æ·»åŠ ç¼–è¾‘æŒ‰é’®åˆ°è®¾ç½®å¼¹çª—
    function addEditButton(){
      const settingsDialog = document.querySelector('#settingsModal .dialog');
      const editBtn = document.createElement('button');
      editBtn.textContent = 'ç¼–è¾‘æ•°æ®';
      editBtn.className = 'ghost';
      editBtn.style.marginTop = '10px';
      editBtn.onclick = ()=>{
        const book = bookSelect.value;
        const src = (DATA[book]||[]).map(x=>({unit:x.unit,id:x.id,title:x.title,chars:x.chars}));
        jsonArea.value = JSON.stringify(src, null, 2);
        editModal.classList.add('show');
      };
      settingsDialog.appendChild(editBtn);
    }

    btnCancelEdit.onclick = ()=> editModal.classList.remove('show');
    btnSave.onclick = ()=>{
      try{
        const parsed = JSON.parse(jsonArea.value);
        if(!Array.isArray(parsed)) throw new Error('JSON é¡¶å±‚åº”ä¸ºæ•°ç»„');
        const ok = parsed.every(it=>typeof it.unit==='number' && typeof it.id==='string' && typeof it.title==='string' && typeof it.chars==='string');
        if(!ok) throw new Error('æ¯é¡¹éœ€åŒ…å« {unit:number,id:string,title:string,chars:string}');
        DATA[bookSelect.value] = parsed;
        editModal.classList.remove('show');
        renderLessonList();
        resetStudy();
        alert('æ•°æ®å·²æ›´æ–°ï¼Œè¯·é‡æ–°å¼€å§‹å­¦ä¹ ');
      }catch(err){
        alert('è§£æå¤±è´¥ï¼š'+err.message);
      }
    };
    btnDownload.onclick = ()=>{
      const blob = new Blob([jsonArea.value], {type:'application/json;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `ç”Ÿå­—æ•°æ®-${bookSelect.value}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    };

    // ç­‰å¾…åº“åŠ è½½å®Œæˆåå†åˆå§‹åŒ–
    function initializeApp() {
      if (typeof pinyinPro === 'undefined') {
        console.warn('pinyinPro åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        // å»¶è¿Ÿé‡è¯•
        setTimeout(initializeApp, 1000);
        return;
      }
      
      console.log('pinyinPro åº“å·²æˆåŠŸåŠ è½½');
      renderLessonList();
      addEditButton();
      resetStudy();
      optimizeForTouch();
      
      // ç»‘å®šæ‰€æœ‰äº‹ä»¶
      console.log('å¼€å§‹ç»‘å®šäº‹ä»¶...');
      
      // åŸºæœ¬åŠŸèƒ½äº‹ä»¶ç»‘å®š
      const btnSelectAll = document.getElementById('btnSelectAll');
      if (btnSelectAll) btnSelectAll.onclick = ()=>{listEl.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=true)};
      
      const btnClear = document.getElementById('btnClear');
      if (btnClear) btnClear.onclick = ()=>{listEl.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false)};
      
      const btnStart = document.getElementById('btnStart');
      if (btnStart) btnStart.onclick = startStudy;
      
      const btnNext = document.getElementById('btnNext');
      if (btnNext) btnNext.onclick = nextCard;
      
      const btnPrev = document.getElementById('btnPrev');
      if (btnPrev) btnPrev.onclick = prevCard;
      
      const btnShuffle = document.getElementById('btnShuffle');
      if (btnShuffle) btnShuffle.onclick = shuffleCurrentDeck;
      
      const btnStartStudy = document.getElementById('btnStartStudy');
      if (btnStartStudy) btnStartStudy.onclick = ()=>{startStudy(); document.getElementById('settingsModal').classList.remove('show');};
      
      const btnSettings = document.getElementById('btnSettings');
      if (btnSettings) btnSettings.onclick = ()=>{document.getElementById('settingsModal').classList.add('show');};
      
      const btnCloseSettings = document.getElementById('btnCloseSettings');
      if (btnCloseSettings) btnCloseSettings.onclick = ()=>{document.getElementById('settingsModal').classList.remove('show');};
      
      if (currentCardEl) currentCardEl.addEventListener('click', ()=>{currentCardEl.classList.toggle('flipped')});
      if (bookSelect) bookSelect.addEventListener('change', ()=>{renderLessonList(); resetStudy()});
      
      // æ‰“å°åŠŸèƒ½äº‹ä»¶ç»‘å®š
      console.log('å¼€å§‹ç»‘å®šæ‰“å°æŒ‰é’®äº‹ä»¶...');
      const printBtn = document.getElementById('btnPrint');
      console.log('æ‰“å°æŒ‰é’®å…ƒç´ :', printBtn);
      if (printBtn) {
        printBtn.onclick = ()=>{
          console.log('æ‰“å°æŒ‰é’®è¢«ç‚¹å‡»');
          // ç¡®ä¿è¯¾æ–‡åˆ—è¡¨å·²ç»æ¸²æŸ“
          if (listEl.innerHTML.includes('æœ¬å†Œæš‚æ— æ•°æ®') || listEl.querySelectorAll('input[type="checkbox"]').length === 0) {
            renderLessonList();
          }
          updatePrintCharsList();
          const printModal = document.getElementById('printModal');
          console.log('æ‰¾åˆ°printModalå…ƒç´ :', printModal);
          if (printModal) {
            printModal.classList.add('show');
            printModal.style.display = 'flex';
            printModal.style.visibility = 'visible';
            console.log('å·²æ·»åŠ showç±»å¹¶è®¾ç½®display');
          } else {
            console.error('æœªæ‰¾åˆ°printModalå…ƒç´ ');
          }
        };
      } else {
        console.error('æœªæ‰¾åˆ°æ‰“å°æŒ‰é’®å…ƒç´ ');
      }
      
      const btnCancelPrint = document.getElementById('btnCancelPrint');
      if (btnCancelPrint) {
        btnCancelPrint.onclick = ()=>{
          const printModal = document.getElementById('printModal');
          if (printModal) {
            printModal.classList.remove('show');
            printModal.style.display = 'none';
            printModal.style.visibility = 'hidden';
          }
        };
      }
      
      const btnConfirmPrint = document.getElementById('btnConfirmPrint');
      if (btnConfirmPrint) {
        btnConfirmPrint.onclick = ()=>{executePrint(); document.getElementById('printModal').classList.remove('show');};
      }
      
      // å¬å†™åŠŸèƒ½äº‹ä»¶ç»‘å®š
      const btnPlayAudio = document.getElementById('btnPlayAudio');
      if (btnPlayAudio) btnPlayAudio.onclick = playCurrentCharAudio;
      
      const btnCheck = document.getElementById('btnCheck');
      if (btnCheck) btnCheck.onclick = checkDictationAnswer;
      
      const btnNextDictation = document.getElementById('btnNextDictation');
      if (btnNextDictation) btnNextDictation.onclick = nextDictation;
      
      const btnReplay = document.getElementById('btnReplay');
      if (btnReplay) btnReplay.onclick = playCurrentCharAudio;
      
      // å¬å†™è¾“å…¥æ¡†å›è½¦é”®æ£€æŸ¥ç­”æ¡ˆ
      const dictationInput = document.getElementById('dictationInput');
      if (dictationInput) {
        dictationInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            checkDictationAnswer();
          }
        });
      }
      
      // å¬å†™æ¨¡å¼åˆ‡æ¢
      const btnDictationMode = document.getElementById('btnDictationMode');
      if (btnDictationMode) {
        btnDictationMode.onclick = ()=>{
          document.getElementById('settingsModal').classList.remove('show');
          startDictationMode();
        };
      }
      
      // å¬å†™è®¾ç½®
      const btnDictationSettings = document.getElementById('btnDictationSettings');
      if (btnDictationSettings) {
        btnDictationSettings.onclick = ()=>{
          document.getElementById('settingsModal').classList.remove('show');
          showDictationSettings();
        };
      }
      
      // å¬å†™è®¾ç½®å¼¹çª—äº‹ä»¶
      const btnCloseDictationSettings = document.getElementById('btnCloseDictationSettings');
      if (btnCloseDictationSettings) btnCloseDictationSettings.onclick = ()=>{document.getElementById('dictationSettingsModal').classList.remove('show');};
      
      const btnSaveDictationSettings = document.getElementById('btnSaveDictationSettings');
      if (btnSaveDictationSettings) btnSaveDictationSettings.onclick = saveDictationSettings;
      
      // æ•°æ®ç¼–è¾‘åŠŸèƒ½
      const btnEditData = document.getElementById('btnEditData');
      if (btnEditData) {
        btnEditData.onclick = ()=>{
          const book = bookSelect.value;
          const LESSONS = DATA[book] || [];
          jsonArea.value = JSON.stringify(LESSONS, null, 2);
          editModal.classList.add('show');
        };
      }
      
      const btnCancelEdit = document.getElementById('btnCancelEdit');
      if (btnCancelEdit) btnCancelEdit.onclick = ()=>{editModal.classList.remove('show');};
      
      const btnSave = document.getElementById('btnSave');
      if (btnSave) {
        btnSave.onclick = ()=>{
          try{
            const parsed = JSON.parse(jsonArea.value);
            if(!Array.isArray(parsed)) throw new Error('JSON é¡¶å±‚åº”ä¸ºæ•°ç»„');
            const ok = parsed.every(it=>typeof it.unit==='number' && typeof it.id==='string' && typeof it.title==='string' && typeof it.chars==='string');
            if(!ok) throw new Error('æ¯é¡¹éœ€åŒ…å« {unit:number,id:string,title:string,chars:string}');
            DATA[bookSelect.value] = parsed;
            editModal.classList.remove('show');
            renderLessonList();
            resetStudy();
            alert('æ•°æ®å·²æ›´æ–°ï¼Œè¯·é‡æ–°å¼€å§‹å­¦ä¹ ');
          }catch(err){
            alert('è§£æå¤±è´¥ï¼š'+err.message);
          }
        };
      }
      
      const btnDownload = document.getElementById('btnDownload');
      if (btnDownload) {
        btnDownload.onclick = ()=>{
          const blob = new Blob([jsonArea.value], {type:'application/json;charset=utf-8'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `ç”Ÿå­—æ•°æ®-${bookSelect.value}.json`;
          a.click();
          URL.revokeObjectURL(a.href);
        };
      }
      
      console.log('æ‰€æœ‰äº‹ä»¶ç»‘å®šå®Œæˆ');
      
      // æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
      const versionEl = document.getElementById('appVersion');
      const dateEl = document.getElementById('versionDate');
      const footerVersionEl = document.getElementById('footerVersion');
      
      if (versionEl) versionEl.textContent = APP_VERSION;
      if (dateEl) dateEl.textContent = VERSION_DATE;
      if (footerVersionEl) footerVersionEl.textContent = APP_VERSION;
      
      console.log(`åº”ç”¨ç‰ˆæœ¬: v${APP_VERSION} (${VERSION_DATE})`);
      
      // æ˜¾ç¤ºå¬å†™åŠŸèƒ½ä»‹ç»ï¼ˆä»…é¦–æ¬¡è®¿é—®ï¼‰
      if (!localStorage.getItem('dictation-intro-shown-v2')) {
        setTimeout(() => {
          alert('ğŸ‰ å¬å†™åŠŸèƒ½å…¨æ–°å‡çº§ï¼\n\nâœ¨ ä¼˜åŒ–è¯­éŸ³æ”¯æŒï¼š\nâ€¢ ğŸ¯ ä¸­ç­‰è´¨é‡ç³»ç»Ÿè¯­éŸ³\nâ€¢ ğŸ“± å¤šé‡é™çº§ä¿éšœæœºåˆ¶\n\nğŸš€ ä½¿ç”¨æ–¹æ³•ï¼š\n1ï¸âƒ£ ç‚¹å‡»"è®¾ç½®"â†’é€‰æ‹©"å¬å†™æ¨¡å¼"\n2ï¸âƒ£ å¼€å§‹å­¦ä¹ ï¼Œäº«å—ç¨³å®šä¸­æ–‡å‘éŸ³');
          localStorage.setItem('dictation-intro-shown-v2', 'true');
        }, 1000);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>
