<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="version" content="2.1.0" />
<title>识字卡｜人教版 一～二年级（上/下）</title>
<style>
  :root {
    /* 日式配色方案 */
    --bg-primary: #faf8f5;     /* 米白色背景 */
    --bg-secondary: #f5f2ed;   /* 浅米色 */
    --card: #ffffff;           /* 纯白卡片 */
    --text-primary: #2c2c2c;   /* 深灰色文字 */
    --text-secondary: #6b6b6b; /* 中灰色 */
    --text-muted: #9a9a9a;     /* 浅灰色 */
    --accent: #8b7355;         /* 日式棕色 */
    --accent-light: #a68b5b;   /* 浅棕色 */
    --border: #e8e3dd;         /* 浅棕色边框 */
    --shadow: 0 8px 32px rgba(139, 115, 85, 0.08);
    --radius: 12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    color: var(--text-primary);
    font: 16px/1.6 "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", "Noto Sans CJK JP", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
    min-height: 100vh;
    letter-spacing: 0.02em;
  }
  
  /* 移动端优化的头部 */
  header{
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    box-shadow: 0 2px 8px rgba(139, 115, 85, 0.05);
  }
  h1{
    margin: 0;
    font-size: 20px;
    font-weight: 500;
    color: var(--text-primary);
    letter-spacing: 0.05em;
  }
  .settings-btn{
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 24px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(139, 115, 85, 0.2);
  }
  .settings-btn:hover{
    background: var(--accent-light);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3);
  }
  
  /* 主容器 */
  .main-container{padding:20px 16px;max-width:480px;margin:0 auto;min-height:calc(100vh - 60px);display:flex;flex-direction:column;justify-content:center}
  
  /* 单卡片显示 */
  .card-container{display:flex;justify-content:center;margin:24px 0}
  .card{
    perspective: 1000px;
    width: 300px;
    height: 300px;
    position: relative;
  }
  .card-inner{
    position: absolute;
    inset: 0;
    border-radius: var(--radius);
    transform-style: preserve-3d;
    transition: transform 0.7s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: var(--shadow);
    background: var(--card);
    border: 1px solid var(--border);
  }
  .card.flipped .card-inner{transform: rotateY(180deg)}
  .face{
    position: absolute;
    inset: 0;
    backface-visibility: hidden;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 24px;
  }
  .front{
    background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
    border: 1px solid var(--border);
  }
  .back{
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
    color: #fff;
    transform: rotateY(180deg);
  }
  .hanzi{
    font-size: 88px;
    font-weight: 400;
    letter-spacing: 0.1em;
    margin-bottom: 12px;
    color: var(--text-primary);
    text-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .pinyin{
    font-size: 36px;
    font-weight: 300;
    letter-spacing: 0.15em;
    margin-bottom: 12px;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .tag{
    position: absolute;
    top: 16px;
    left: 16px;
    background: rgba(139, 115, 85, 0.1);
    color: var(--accent);
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.05em;
    border: 1px solid rgba(139, 115, 85, 0.2);
  }
  .hint{
    font-size: 13px;
    color: var(--text-muted);
    text-align: center;
    margin-top: 8px;
    letter-spacing: 0.02em;
  }
  
  /* 控制按钮 */
  .controls{
    display: flex;
    justify-content: center;
    gap: 16px;
    margin: 24px 0;
  }
  button{
    appearance: none;
    border: none;
    background: var(--accent);
    color: #fff;
    padding: 14px 24px;
    border-radius: 28px;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    letter-spacing: 0.02em;
    box-shadow: 0 4px 16px rgba(139, 115, 85, 0.2);
    transition: all 0.3s ease;
    border: 1px solid transparent;
  }
  button:hover{
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(139, 115, 85, 0.3);
    background: var(--accent-light);
  }
  button.secondary{
    background: #fff;
    color: var(--accent);
    border: 1px solid var(--accent);
    box-shadow: 0 2px 8px rgba(139, 115, 85, 0.1);
  }
  button.secondary:hover{
    background: var(--accent);
    color: #fff;
    box-shadow: 0 4px 16px rgba(139, 115, 85, 0.2);
  }
  button.ghost{
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border);
    box-shadow: none;
  }
  button.ghost:hover{
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-color: var(--accent);
  }
  
  /* 进度信息 */
  .progress{
    text-align: center;
    margin: 20px 0;
    color: var(--text-secondary);
    font-size: 15px;
    font-weight: 400;
    letter-spacing: 0.02em;
  }
  
  /* 设置弹窗 */
  .modal{
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 1000;
    backdrop-filter: blur(4px);
  }
  .modal.show{display: flex !important}
  .dialog{
    width: min(420px, 90vw);
    background: #fff;
    border-radius: 24px;
    box-shadow: 0 24px 64px rgba(139, 115, 85, 0.15);
    padding: 28px;
    max-height: 85vh;
    overflow-y: auto;
    border: 1px solid var(--border);
  }
  .dialog h3{
    margin: 0 0 20px;
    font-size: 20px;
    text-align: center;
    color: var(--text-primary);
    font-weight: 500;
    letter-spacing: 0.02em;
  }
  
  /* 设置内容 */
  .setting-group{margin-bottom: 24px}
  .setting-group label{
    display: block;
    margin-bottom: 10px;
    font-weight: 500;
    color: var(--text-primary);
    font-size: 15px;
    letter-spacing: 0.01em;
  }
  select, input[type="number"]{
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 14px;
    background: #fff;
    color: var(--text-primary);
    transition: all 0.2s ease;
    font-family: inherit;
  }
  select:focus, input[type="number"]:focus{
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
  }
  
  /* 课文选择 */
  .lessons{
    max-height: 220px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    background: var(--bg-primary);
  }
  .lessons h4{
    margin: 12px 0 8px;
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
    letter-spacing: 0.01em;
  }
  .lesson-item{
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
    color: var(--text-primary);
  }
  .lesson-item:hover{
    background: var(--bg-secondary);
  }
  .lesson-item input{
    transform: scale(1.1);
    accent-color: var(--accent);
  }
  
  /* 按钮组 */
  .btn-group{
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }
  .btn-group button{flex: 1}
  
  /* 听写界面样式 */
  .dictation-container {
    display: flex;
    justify-content: center;
    margin: 24px 0;
  }
  
  .dictation-card {
    width: 100%;
    max-width: 400px;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    padding: 28px;
  }
  
  .dictation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  
  .play-btn {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .play-btn:hover {
    background: var(--accent-light);
    transform: scale(1.05);
  }
  
  .play-btn:active {
    transform: scale(0.95);
  }
  
  .dictation-content {
    text-align: center;
  }
  
  .audio-visual {
    margin-bottom: 28px;
    padding: 20px;
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  
  .sound-waves {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px;
    height: 40px;
    margin-bottom: 16px;
  }
  
  .sound-waves span {
    width: 4px;
    height: 20px;
    background: var(--accent);
    border-radius: 2px;
    opacity: 0.3;
    transition: all 0.3s ease;
  }
  
  .sound-waves.playing span {
    animation: soundWave 1.2s ease-in-out infinite;
  }
  
  .sound-waves.playing span:nth-child(1) { animation-delay: 0s; }
  .sound-waves.playing span:nth-child(2) { animation-delay: 0.1s; }
  .sound-waves.playing span:nth-child(3) { animation-delay: 0.2s; }
  .sound-waves.playing span:nth-child(4) { animation-delay: 0.3s; }
  .sound-waves.playing span:nth-child(5) { animation-delay: 0.4s; }
  
  @keyframes soundWave {
    0%, 100% { height: 20px; opacity: 0.3; }
    50% { height: 35px; opacity: 1; }
  }
  
  .current-pinyin {
    font-size: 24px;
    color: var(--accent);
    font-weight: 500;
    letter-spacing: 0.1em;
  }
  
  .input-area {
    margin-bottom: 24px;
  }
  
  .input-area input {
    width: 100%;
    max-width: 200px;
    padding: 16px 20px;
    font-size: 32px;
    text-align: center;
    border: 2px solid var(--border);
    border-radius: 12px;
    background: #fff;
    color: var(--text-primary);
    transition: all 0.3s ease;
    font-weight: 400;
    letter-spacing: 0.1em;
  }
  
  .input-area input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
    transform: scale(1.02);
  }
  
  .input-area input.correct {
    border-color: #10b981;
    background: rgba(16, 185, 129, 0.05);
  }
  
  .input-area input.incorrect {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.05);
    animation: shake 0.5s ease-in-out;
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  
  .input-hint {
    margin-top: 12px;
    font-size: 14px;
    color: var(--text-muted);
    letter-spacing: 0.02em;
  }
  
  .result-area {
    padding: 20px;
    border-radius: 12px;
    margin-top: 20px;
    transition: all 0.3s ease;
  }
  
  .result-area.correct {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
  }
  
  .result-area.incorrect {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
  }
  
  .result-icon {
    font-size: 32px;
    margin-bottom: 8px;
  }
  
  .result-text {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 12px;
    letter-spacing: 0.02em;
  }
  
  .result-area.correct .result-text {
    color: #059669;
  }
  
  .result-area.incorrect .result-text {
    color: #dc2626;
  }
  
  .answer-display {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .correct-answer {
    font-size: 28px;
    font-weight: 500;
    color: var(--text-primary);
    padding: 8px 16px;
    background: rgba(139, 115, 85, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(139, 115, 85, 0.2);
  }
  
  .correct-pinyin {
    font-size: 18px;
    color: var(--accent);
    font-weight: 400;
    letter-spacing: 0.1em;
  }

  /* 田字格打印样式 */
  .tianzi-grid {
    display: inline-block;
    width: 14mm;
    height: 14mm;
    border: 1px solid #000;
    position: relative;
    margin: 0;
    vertical-align: top;
    box-sizing: border-box;
  }
  
  .tianzi-grid::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #000;
    border-top: 1px dashed #000;
    transform: translateY(-50%);
  }
  
  .tianzi-grid::after {
    content: '';
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 1px;
    background: #000;
    border-left: 1px dashed #000;
    transform: translateX(-50%);
  }
  
  .tianzi-char {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 14mm;
    font-weight: normal;
    line-height: 1;
    font-family: 'KaiTi', '楷体', 'STKaiti', '华文楷体', 'STKaiti', 'SimKai', serif;
    color: transparent;
    -webkit-text-stroke: 0.5px #000;
  }
  
  .tianzi-char.trace {
    color: transparent;
    -webkit-text-stroke: 0.5px #000;
  }
  
  .tianzi-stroke-order {
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 8px;
    color: #666;
    line-height: 1;
  }
  
  .print-page {
    width: 210mm;
    min-height: 297mm;
    margin: 0 auto;
    padding: 20mm;
    background: white;
    font-family: 'SimSun', '宋体', serif;
    font-size: 12pt;
    line-height: 1.5;
    box-sizing: border-box;
  }
  
  .print-header {
    text-align: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #000;
    padding-bottom: 10px;
  }
  
  .print-title {
    font-size: 18pt;
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .print-subtitle {
    font-size: 12pt;
    color: #666;
  }
  
  .print-grid-container {
    display: block;
    margin-bottom: 20px;
    line-height: 0;
  }
  
  .print-section {
    margin-bottom: 30px;
  }
  
  .print-section-title {
    font-size: 14pt;
    font-weight: bold;
    margin-bottom: 10px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 5px;
  }
  
  @media print {
    body * {
      visibility: hidden;
    }
    
    .print-page, .print-page * {
      visibility: visible;
    }
    
    .print-page {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      margin: 0;
      padding: 20mm;
    }
    
    .tianzi-grid {
      break-inside: avoid;
    }
    
    .tianzi-char {
      color: transparent !important;
      -webkit-text-stroke: 0.5px #000 !important;
      font-weight: normal !important;
    }
  }

  /* 响应式调整 */
  @media (max-width: 480px) {
    .card{
      width: 260px;
      height: 260px;
    }
    .hanzi{
      font-size: 76px;
    }
    .pinyin{
      font-size: 30px;
    }
    .main-container{
      padding: 16px 12px;
    }
    .dialog{
      padding: 20px;
      margin: 10px;
      width: min(380px, 95vw);
      max-height: 90vh;
    }
    .modal{
      padding: 10px;
    }
    .controls{
      gap: 12px;
    }
    button{
      padding: 12px 20px;
      font-size: 13px;
    }
    
    /* 听写界面移动端优化 */
    .dictation-card {
      padding: 20px;
      margin: 0 8px;
    }
    
    .audio-visual {
      padding: 16px;
    }
    
    .current-pinyin {
      font-size: 20px;
    }
    
    .input-area input {
      font-size: 28px;
      padding: 14px 16px;
    }
    
    .correct-answer {
      font-size: 24px;
      padding: 6px 12px;
    }
    
    .correct-pinyin {
      font-size: 16px;
    }
  }
  
  @media (max-width: 360px) {
    .card{
      width: 240px;
      height: 240px;
    }
    .hanzi{
      font-size: 68px;
    }
    .pinyin{
      font-size: 26px;
    }
    
    /* 小屏幕听写界面优化 */
    .dictation-card {
      padding: 16px;
    }
    
    .dictation-header {
      margin-bottom: 20px;
    }
    
    .play-btn {
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .audio-visual {
      padding: 12px;
      margin-bottom: 20px;
    }
    
    .current-pinyin {
      font-size: 18px;
    }
    
    .input-area input {
      font-size: 24px;
      padding: 12px 14px;
      max-width: 160px;
    }
    
    .correct-answer {
      font-size: 20px;
      padding: 4px 8px;
    }
    
    .correct-pinyin {
      font-size: 14px;
    }
    
    .result-icon {
      font-size: 24px;
    }
    
    .result-text {
      font-size: 14px;
    }
  }
</style>
</head>
<body>
  <header>
    <h1>识字卡</h1>
    <div style="display: flex; gap: 8px; align-items: center;">
      <button id="btnPrint" class="settings-btn" style="padding: 8px 12px; font-size: 12px;">🖨️ 打印</button>
      <button id="btnSettings" class="settings-btn">⚙️ 设置</button>
    </div>
  </header>

  <div class="main-container">
    <!-- 进度信息 -->
    <div class="progress" id="progressInfo">点击"开始学习"开始识字</div>
    
    <!-- 单卡片显示 -->
    <div class="card-container">
      <div id="currentCard" class="card">
        <div class="card-inner">
          <div class="face front">
            <div class="tag">生字</div>
            <div class="hanzi" id="currentHanzi">字</div>
            <div class="hint">点击翻面看拼音</div>
          </div>
          <div class="face back">
            <div class="tag">拼音</div>
            <div class="pinyin" id="currentPinyin">zì</div>
            <div class="hint">点击翻面看生字</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 听写界面 -->
    <div id="dictationContainer" class="dictation-container" style="display:none;">
      <div class="dictation-card">
        <div class="dictation-header">
          <div class="tag">听写练习</div>
          <button id="btnPlayAudio" class="play-btn">🔊 播放</button>
        </div>
        
        <div class="dictation-content">
          <div class="audio-visual">
            <div class="sound-waves" id="soundWaves">
              <span></span><span></span><span></span><span></span><span></span>
            </div>
            <div class="current-pinyin" id="dictationPinyin">点击播放听声音</div>
          </div>
          
          <div class="input-area">
            <input type="text" id="dictationInput" placeholder="请输入听到的汉字" autocomplete="off" maxlength="1">
            <div class="input-hint">听清楚后，输入对应的汉字</div>
          </div>
          
          <div class="result-area" id="resultArea" style="display:none;">
            <div class="result-icon" id="resultIcon"></div>
            <div class="result-text" id="resultText"></div>
            <div class="answer-display">
              <span class="correct-answer" id="correctAnswer"></span>
              <span class="correct-pinyin" id="correctPinyin"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 控制按钮 -->
    <div class="controls">
      <button id="btnStart" class="secondary">开始学习</button>
      <button id="btnPrev" class="ghost" style="display:none;">上一个</button>
      <button id="btnNext" class="ghost" style="display:none;">下一个</button>
      <button id="btnShuffle" class="ghost" style="display:none;">🔀 随机</button>
      
      <!-- 听写专用按钮 -->
      <button id="btnCheck" class="secondary" style="display:none;">检查答案</button>
      <button id="btnNextDictation" class="ghost" style="display:none;">下一个</button>
      <button id="btnReplay" class="ghost" style="display:none;">🔊 重播</button>
    </div>
    
    <!-- 版本信息 -->
    <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
      <div style="font-size: 11px; color: var(--text-muted); opacity: 0.7;">
        v<span id="footerVersion">2.1.0</span>
      </div>
    </div>
  </div>

  <!-- 设置弹窗 -->
  <div class="modal" id="settingsModal">
    <div class="dialog">
      <h3>学习设置</h3>
      
      <div class="setting-group">
        <label>选择册别：</label>
        <select id="bookSelect">
          <option value="1上">一年级上</option>
          <option value="1下">一年级下</option>
          <option value="2上" selected>二年级上</option>
          <option value="2下">二年级下</option>
          <option value="3上">三年级上</option>
          <option value="3下">三年级下</option>
        </select>
      </div>
      
      <div class="setting-group">
        <label>选择课文：</label>
        <div id="lessonList" class="lessons"></div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="btnSelectAll" class="ghost" style="flex:1;">全选</button>
          <button id="btnClear" class="ghost" style="flex:1;">清空</button>
        </div>
      </div>
      
      <div class="setting-group">
        <label>学习模式：</label>
        <select id="studyMode">
          <option value="random">随机顺序</option>
          <option value="sequential">按课文顺序</option>
        </select>
      </div>
      
      <div class="setting-group">
        <label>练习方式：</label>
        <select id="practiceMode">
          <option value="flashcard">识字卡模式</option>
          <option value="dictation">听写模式</option>
        </select>
      </div>
      
      
      <div class="btn-group">
        <button id="btnCloseSettings" class="secondary">关闭</button>
        <button id="btnStartStudy">开始学习</button>
      </div>
      
      <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
        <div style="font-size: 12px; color: var(--text-muted);">
          版本 v<span id="appVersion">2.1.0</span> | 更新日期 <span id="versionDate">2025-09-07</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 打印设置弹窗 -->
  <div class="modal" id="printModal">
    <div class="dialog">
      <h3>田字格生字打印</h3>
      
      <div class="setting-group">
        <label>打印范围：</label>
        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
          将打印当前选择的课文范围内的所有生字
        </div>
        <div id="printCharsList" style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-top: 8px; min-height: 40px; font-size: 14px; line-height: 1.6;">
          正在加载生字列表...
        </div>
      </div>
      
      <div class="setting-group">
        <label>打印选项：</label>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
            <input type="checkbox" id="printTraceMode">
            <span>仅打印描字（空心字）</span>
          </label>
        </div>
      </div>
      
      <div class="btn-group">
        <button id="btnCancelPrint" class="secondary">取消</button>
        <button id="btnConfirmPrint">打印</button>
      </div>
    </div>
  </div>

  <!-- 数据编辑器（导入/导出 JSON） -->
  <div class="modal" id="editModal">
    <div class="dialog">
      <h3>编辑当前册别的数据（JSON）</h3>
      <div class="editor">
        <textarea id="jsonArea" spellcheck="false" style="min-height:200px;width:100%;padding:10px;border:1px solid #e0e0e0;border-radius:8px;font-family:monospace;font-size:12px;"></textarea>
        <div style="font-size:12px;color:#666;margin:8px 0;">
          说明：一个条目形如
          <code>{"unit":1,"id":"1-1","title":"课文标题","chars":"字 字 字"}</code>。
          <br>粘贴你手头更准确的官方生字表后，点"保存"。仅影响当前选择的册别。
        </div>
        <div class="btn-group">
          <button id="btnDownload" class="secondary">导出JSON</button>
          <button id="btnCancelEdit" class="ghost">取消</button>
          <button id="btnSave">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- pinyin-pro（拼音库，CDN） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pinyin-pro/3.27.0/index.js"></script>
  <script>
    // ========== 版本信息 ==========
    const APP_VERSION = '2.1.0';
    const VERSION_DATE = '2025-09-07';
    
    // ========== 数据区 ==========
    // 结构：DATA[册别] = LESSONS[]
    // 其中 LESSONS[]: {unit:数字,id:"单元-序号",title:"课文标题",chars:"空格分隔的单字列表"}
    
    // 笔画顺序数据（常用汉字的笔画数）
    const STROKE_ORDER = {
      // 一年级上
      '了': 2, '子': 3, '人': 2, '大': 3, '月': 4, '儿': 2, '头': 5, '里': 7, '可': 5, '东': 5, '西': 6,
      '天': 4, '四': 5, '是': 9, '在': 6, '后': 6, '我': 7, '好': 6, '长': 4, '比': 4, '巴': 4, '把': 7,
      '下': 3, '个': 3, '雨': 8, '们': 5, '问': 6, '有': 6, '半': 5, '从': 4, '你': 7, '才': 3, '明': 8,
      '同': 6, '学': 8, '自': 6, '己': 3, '衣': 6, '白': 5, '的': 8, '又': 2, '和': 8, '竹': 6, '牙': 4,
      '马': 3, '用': 5, '几': 2, '只': 5, '石': 5, '多': 6, '出': 5, '见': 4, '对': 5, '妈': 6, '全': 6, '回': 6,
      
      // 一年级下
      '吃': 6, '叫': 5, '主': 5, '江': 6, '住': 7, '没': 7, '以': 4, '会': 6, '走': 7, '北': 5, '京': 8, '门': 3, '广': 3,
      '过': 6, '各': 6, '种': 9, '样': 10, '伙': 6, '伴': 7, '这': 7, '太': 4, '阳': 6, '校': 10, '金': 8, '秋': 9, '因': 6, '为': 4,
      '他': 6, '河': 8, '说': 9, '也': 3, '地': 6, '听': 7, '哥': 10, '乐': 5, '单': 8, '呼': 8, '居': 8, '招': 8, '快': 7,
      '讲': 6, '许': 6, '很': 9, '当': 6, '玩': 8, '行': 6, '音': 9, '乡': 3, '前': 9, '光': 6, '低': 7, '床': 7, '故': 9, '思': 9,
      '再': 6, '外': 5, '爸': 8, '晚': 11, '看': 9, '色': 6, '笑': 10, '午': 4, '节': 5, '叶': 5, '真': 10, '米': 6, '豆': 7, '分': 4,
      '兴': 6, '到': 8, '那': 6, '千': 3, '成': 6, '着': 11, '高': 10, '无': 4, '尖': 6, '树': 9, '爱': 10, '采': 8, '角': 7, '首': 9,
      '美': 9, '亮': 9, '台': 5, '朵': 6, '机': 6, '放': 8, '鱼': 8, '加': 5, '边': 5, '吗': 6, '吧': 7, '呀': 7, '呢': 8, '直': 8,
      '病': 10, '医': 7, '别': 7, '干': 3, '奇': 8, '七': 2, '星': 9, '吓': 6, '怕': 8, '跟': 13, '家': 10, '羊': 6, '象': 11, '都': 10,
      '捉': 10, '条': 7, '爬': 8, '姐': 8, '您': 11, '草': 9, '房': 8,
      
      // 二年级上
      '两': 7, '哪': 9, '宽': 10, '就': 12, '孩': 9, '晴': 12, '肚': 7, '皮': 5, '跳': 13, '顶': 8, '作': 7, '傍': 12, '变': 8, '带': 9,
      '洋': 9, '海': 9, '给': 9, '坏': 7, '极': 7, '片': 4, '识': 7, '它': 5, '如': 6, '她': 6, '娃': 9, '法': 8, '毛': 4, '更': 7, '脚': 11, '知': 8,
      '做': 11, '底': 8, '岁': 6, '然': 12, '杆': 7, '柱': 9, '称': 10, '秤': 10, '站': 10, '船': 11, '候': 10, '评': 7, '及': 3, '奖': 9, '并': 6, '幅': 12, '另': 5, '报': 7, '拿': 9, '画': 8,
      '写': 5, '今': 4, '信': 9, '封': 9, '圆': 10, '灯': 6, '笔': 10, '珠': 10, '支': 4, '电': 5, '事': 8, '先': 6, '发': 5, '哄': 9, '闭': 6, '沉': 7, '脸': 11, '窗': 12,
      '依': 8, '川': 3, '尽': 6, '层': 7, '挂': 9, '照': 13, '炉': 8, '烟': 10, '楼': 13, '黄': 11, '些': 8, '部': 10, '位': 7, '升': 4, '南': 9, '巨': 4, '闪': 5, '每': 7,
      '丽': 7, '华': 6, '迹': 9, '央': 5, '名': 6, '展': 10, '披': 8, '现': 8, '胜': 9, '利': 7, '市': 5, '客': 9, '坡': 8, '城': 9, '老': 6, '枝': 8, '收': 6, '起': 10, '份': 6,
      '井': 4, '际': 7, '话': 8, '喝': 12, '沿': 8, '渴': 12, '观': 6, '答': 12, '阵': 6, '却': 7, '将': 9, '夜': 8, '枯': 9, '朗': 10, '面': 9, '纷': 7,
      '邻': 7, '谢': 12, '治': 8, '怪': 8, '棵': 12, '想': 13, '盯': 7, '言': 7, '业': 5, '产': 6, '认': 4, '道': 12, '洪': 9, '灾': 7, '被': 10, '难': 10,
      '军': 6, '伍': 6, '师': 6, '士': 3, '担': 8, '扁': 9, '志': 7, '站': 10, '度': 9, '泼': 8, '炮': 9, '忘': 7, '龙': 5, '阴': 6, '似': 6, '苍': 7, '茫': 9, '惊': 11, '危': 6, '敢': 11, '野': 11,
      '久': 3, '切': 4, '于': 3, '论': 6, '岸': 8, '屋': 9, '散': 12, '步': 7,
      
      // 二年级下
      '诗': 8, '村': 7, '童': 12, '碧': 14, '妆': 6, '绿': 11, '丝': 5, '剪': 11, '冲': 6, '寻': 6, '姑': 8, '娘': 10, '吐': 6, '柳': 9, '荡': 9, '桃': 10, '杏': 7,
      '鲜': 14, '邮': 7, '递': 10, '员': 7, '原': 10, '叔': 8, '局': 7, '堆': 11, '礼': 5, '邓': 4, '植': 12, '格': 10, '引': 4, '注': 8, '满': 13, '休': 6, '息': 10,
      '锋': 12, '昨': 9, '冒': 9, '留': 10, '弯': 9, '背': 9, '洒': 9, '温': 12, '暖': 13, '能': 10, '桌': 10, '味': 8, '买': 6, '具': 8, '甘': 5, '甜': 11, '菜': 11, '劳': 7,
      '匹': 4, '妹': 8, '波': 8, '纹': 7, '像': 14, '景': 12, '恋': 10, '舍': 8, '求': 7, '州': 6, '湾': 12, '岛': 7, '峡': 9, '民': 5, '族': 11, '谊': 10, '齐': 6, '奋': 8,
      '贴': 9, '街': 12, '舟': 6, '艾': 5, '敬': 12, '转': 8, '团': 6, '热': 10, '闹': 8, '贝': 4, '壳': 7, '甲': 5, '骨': 9, '钱': 10, '币': 4, '与': 3, '财': 7, '关': 6,
      '烧': 10, '茄': 8, '烤': 10, '鸭': 10, '肉': 6, '鸡': 7, '蛋': 11, '炒': 8, '饭': 7, '彩': 11, '梦': 11, '森': 12, '拉': 8, '结': 9, '苹': 8, '般': 10, '精': 14, '灵': 7,
      '伞': 6, '姨': 9, '弟': 7, '便': 9, '教': 11, '游': 12, '戏': 6, '母': 5, '周': 8, '围': 7, '句': 5, '补': 7, '充': 6, '药': 9, '合': 6, '死': 6, '记': 5, '屁': 7, '股': 8, '尿': 7, '净': 8, '屎': 9, '幸': 8, '使': 8, '劲': 7,
      '亡': 3, '牢': 7, '钻': 10, '劝': 4, '丢': 6, '告': 7, '筋': 12, '疲': 10, '图': 8, '课': 10, '摆': 13, '座': 10, '交': 6, '哈': 9, '页': 6, '抢': 7, '嘻': 15, '愿': 14, '意': 13, '麦': 7, '该': 8, '伯': 7, '刻': 8, '突': 9, '掉': 11,
      '湖': 12, '莲': 10, '穷': 7, '荷': 10, '绝': 9, '含': 7, '岭': 8, '吴': 7, '雷': 13, '乌': 4, '黑': 12, '压': 6, '垂': 8, '户': 4, '迎': 7, '扑': 5, '指': 9, '针': 10, '帮': 9, '助': 7, '导': 6, '永': 5, '碰': 13, '特': 10, '积': 10,
      '宇': 6, '宙': 8, '杯': 8, '失': 5, '板': 8, '客': 9, '易': 8, '浴': 10, '室': 9, '扇': 10, '慢': 14, '遇': 12, '兔': 8, '安': 6, '根': 10, '痛': 12, '最': 12, '店': 8, '决': 6, '定': 8, '商': 11, '夫': 4, '终': 8, '完': 7, '换': 10, '期': 12, '蛙': 12, '卖': 8, '搬': 13, '倒': 10, '籽': 9
    };
    const DATA = {
              "1上": [
          {unit:1,id:"1-1",title:"秋天",chars:"了 子 人 大"},
          {unit:1,id:"1-2",title:"小小的船",chars:"月 儿 头 里"},
          {unit:1,id:"1-3",title:"江南",chars:"可 东 西"},
          {unit:1,id:"1-4",title:"四季",chars:"天 四 是"},
          {unit:2,id:"2-5",title:"影子",chars:"在 后 我 好"},
          {unit:2,id:"2-6",title:"比尾巴",chars:"长 比 巴 把"},
          {unit:2,id:"2-7",title:"青蛙写诗",chars:"下 个 雨 们"},
          {unit:2,id:"2-8",title:"雨点儿",chars:"问 有 半 从 你"},
          {unit:3,id:"3-9",title:"明天要远足",chars:"才 明 同 学"},
          {unit:3,id:"3-10",title:"大还是小",chars:"自 己 衣"},
          {unit:3,id:"3-11",title:"项链",chars:"白 的 又 和"},
          {unit:4,id:"4-12",title:"雪地里的小画家",chars:"竹 牙 马 用 几"},
          {unit:4,id:"4-13",title:"乌鸦喝水",chars:"只 石 多 出 见"},
          {unit:4,id:"4-14",title:"小蜗牛",chars:"对 妈 全 回"}
        ],
      "1下": [
          {unit:1,id:"1-1",title:"吃水不忘挖井人",chars:"吃 叫 主 江 住 没 以"},
          {unit:1,id:"1-2",title:"我多想去看看",chars:"会 走 北 京 门 广"},
          {unit:1,id:"1-3",title:"一个接一个",chars:"过 各 种 样 伙 伴 这"},
          {unit:1,id:"1-4",title:"四个太阳",chars:"太 阳 校 金 秋 因 为"},
          {unit:2,id:"2-5",title:"小公鸡和小鸭子",chars:"他 河 说 也 地 听 哥"},
          {unit:2,id:"2-6",title:"树和喜鹊",chars:"乐 单 呼 居 招 快"},
          {unit:2,id:"2-7",title:"怎么都快乐",chars:"讲 许 很 当 玩 行 音"},
          {unit:3,id:"3-8",title:"静夜思",chars:"乡 前 光 低 床 故 思"},
          {unit:3,id:"3-9",title:"夜色",chars:"再 外 爸 晚 看 色 笑"},
          {unit:3,id:"3-10",title:"端午粽",chars:"午 节 叶 真 米 豆 分"},
          {unit:3,id:"3-11",title:"彩虹",chars:"兴 到 那 千 成 着 高"},
          {unit:4,id:"4-12",title:"古诗二首",chars:"无 尖 树 爱 采 角 首"},
          {unit:4,id:"4-13",title:"荷叶圆圆",chars:"美 亮 台 朵 机 放 鱼"},
          {unit:4,id:"4-14",title:"要下雨了",chars:"加 边 吗 吧 呀 呢 直"},
          {unit:5,id:"5-15",title:"棉花姑娘",chars:"病 医 别 干 奇 七 星"},
          {unit:5,id:"5-16",title:"咕咚",chars:"吓 怕 跟 家 羊 象 都"},
          {unit:5,id:"5-17",title:"小壁虎借尾巴",chars:"捉 条 爬 姐 您 草 房"}
        ],
              "2上": [
         {unit:1,id:"1-1",title:"小蝌蚪找妈妈",chars:"两 哪 宽 就 孩 晴 肚 皮 跳 顶"},
         {unit:1,id:"1-2",title:"我是什么",chars:"作 傍 变 带 洋 海 给 坏 极 片"},
         {unit:1,id:"1-3",title:"植物妈妈有办法",chars:"识 它 如 她 娃 法 毛 更 脚 知"},
         {unit:2,id:"2-4",title:"曹冲称象",chars:"做 底 岁 然 杆 柱 称 秤 站 船"},
         {unit:2,id:"2-5",title:"玲玲的画",chars:"候 评 及 奖 并 幅 另 报 拿 画"},
         {unit:2,id:"2-6",title:"一封信",chars:"写 今 信 封 圆 灯 笔 珠 支 电"},
         {unit:3,id:"3-7",title:"妈妈睡了",chars:"事 先 发 哄 闭 沉 脸 窗"},
         {unit:3,id:"3-8",title:"古诗二首",chars:"依 川 尽 层 挂 照 炉 烟 楼 黄"},
         {unit:4,id:"4-9",title:"黄山奇石",chars:"些 部 位 升 南 巨 闪 每"},
         {unit:4,id:"4-10",title:"日月潭",chars:"丽 华 迹 央 名 展 披 现 胜"},
         {unit:4,id:"4-11",title:"葡萄沟",chars:"利 市 客 坡 城 老 枝 收 起 份"},
         {unit:5,id:"5-12",title:"坐井观天",chars:"井 际 话 喝 沿 渴 观 答"},
         {unit:5,id:"5-13",title:"寒号鸟",chars:"阵 却 将 夜 枯 朗 面 纷"},
         {unit:5,id:"5-14",title:"我要的是葫芦",chars:"邻 谢 治 怪 棵 想 盯 言"},
         {unit:6,id:"6-15",title:"大禹治水",chars:"业 产 认 道 洪 灾 被 难"},
         {unit:6,id:"6-16",title:"朱德的扁担",chars:"军 伍 师 士 担 扁 志 站"},
         {unit:7,id:"7-17",title:"难忘的泼水节",chars:"度 泼 炮 忘 龙"},
         {unit:7,id:"7-18",title:"古诗二首",chars:"阴 似 苍 茫 惊 危 敢 野"},
         {unit:7,id:"7-19",title:"雾在哪里",chars:"久 切 于 论 岸 屋 散 步"}
        ],
      "2下": [
        {unit:1,id:"1-1",title:"古诗二首（村居/咏柳）",chars:"诗 村 童 碧 妆 绿 丝 剪"},
        {unit:1,id:"1-2",title:"找春天",chars:"冲 寻 姑 娘 吐 柳 荡 桃 杏"},
        {unit:1,id:"1-3",title:"开满鲜花的小路",chars:"鲜 邮 递 员 原 叔 局 堆 礼"},
        {unit:1,id:"1-4",title:"邓小平爷爷植树",chars:"邓 植 格 引 注 满 休 息"},
        {unit:2,id:"2-5",title:"雷锋叔叔，你在哪里",chars:"锋 昨 冒 留 弯 背 洒 温 暖"},
        {unit:2,id:"2-6",title:"千人糕",chars:"能 桌 味 买 具 甘 甜 菜 劳"},
        {unit:2,id:"2-7",title:"一匹出色的马",chars:"匹 妹 波 纹 像 景 恋 舍 求"},
        {unit:3,id:"3-8",title:"识字1 神州谣",chars:"州 湾 岛 峡 民 族 谊 齐 奋"},
        {unit:3,id:"3-9",title:"识字2 传统节日",chars:"贴 街 舟 艾 敬 转 团 热 闹"},
        {unit:3,id:"3-10",title:"识字3 贝的故事",chars:"贝 壳 甲 骨 钱 币 与 财 关"},
        {unit:3,id:"3-11",title:"识字4 中国美食",chars:"烧 茄 烤 鸭 肉 鸡 蛋 炒 饭"},
        {unit:4,id:"4-12",title:"彩色的梦",chars:"彩 梦 森 拉 结 苹 般 精 灵"},
        {unit:4,id:"4-13",title:"枫树上的喜鹊",chars:"伞 姨 弟 便 教 游 戏 母"},
        {unit:4,id:"4-14",title:"沙滩上的童话",chars:"周 围 句 补 充 药 合 死 记"},
        {unit:4,id:"4-15",title:"我是一只小虫子",chars:"屁 股 尿 净 屎 幸 使 劲"},
        {unit:5,id:"5-16",title:"寓言二则（亡羊补牢/揠苗助长）",chars:"亡 牢 钻 劝 丢 告 筋 疲"},
        {unit:5,id:"5-17",title:"画杨桃",chars:"图 课 摆 座 交 哈 页 抢 嘻"},
        {unit:5,id:"5-18",title:"小马过河",chars:"愿 意 麦 该 伯 刻 突 掉"},
        {unit:6,id:"6-19",title:"古诗二首（晓出净慈寺送林子方/绝句）",chars:"湖 莲 穷 荷 绝 含 岭 吴"},
        {unit:6,id:"6-20",title:"雷雨",chars:"雷 乌 黑 压 垂 户 迎 扑"},
        {unit:6,id:"6-21",title:"要是你在野外迷了路",chars:"指 针 帮 助 导 永 碰 特 积"},
        {unit:6,id:"6-22",title:"太空生活趣事多",chars:"宇 宙 杯 失 板 客 易 浴 室"},
        {unit:7,id:"7-23",title:"大象的耳朵",chars:"扇 慢 遇 兔 安 根 痛 最"},
        {unit:7,id:"7-24",title:"蜘蛛开店",chars:"店 决 定 商 夫 终 完 换 期"},
        {unit:7,id:"7-25",title:"青蛙卖泥塘",chars:"蛙 卖 搬 倒 籽"}
      ],
      "3上": [
        // ★ 三年级上（按人教版常见目录整理；可在"编辑"里微调）
        { unit: 1, id: "1-1", title: "大青树下的小学", chars: "晨 绒 球 汉 艳 服 装 扮 静 停 孔 雀 粗" },
        { unit: 1, id: "1-2", title: "花的学校", chars: "落 荒 笛 舞 狂 罚 假 互 所 够 猜 扬 臂" },
        { unit: 2, id: "2-3", title: "古诗三首", chars: "寒 径 斜 霜 赠 刘 盖 菊 残 君 橙 送 挑" },
        { unit: 2, id: "2-4", title: "铺满金色巴掌的水泥道", chars: "铺 泥 晶 院 墙 印 排 列 规 则 乱 棕 迟" },
        { unit: 2, id: "2-5", title: "秋天的雨", chars: "盒 颜 料 票 飘 争 仙 淡 闻 梨 勾 曲 丰" },
        { unit: 3, id: "3-6", title: "去年的树", chars: "冷 离 等 斧 砍 谷 柴 煤 油 诉 睁 接" },
        { unit: 3, id: "3-7", title: "在牛肚子里旅行", chars: "旅 咱 怜 救 命 拼 扫 胃 管 刚 流 泪 算" },
        { unit: 4, id: "4-8", title: "总也倒不了的老屋", chars: "洞 准 备 暴 墙 壁 饿 蜘 蛛 漂 撞 饱 晒" },
        { unit: 5, id: "5-9", title: "搭船的鸟", chars: "搭 亲 父 沙 啦 响 羽 翠 嘴 悄 吞 哦 捕" },
        { unit: 5, id: "5-10", title: "金色的草地", chars: "蒲 英 盛 耍 喊 欠 钓 而 察 拢 趣 喜 睡" },
        { unit: 6, id: "6-11", title: "古诗三首", chars: "断 楚 至 孤 帆 饮 初 镜 未 磨 遥 银 盘" },
        { unit: 6, id: "6-12", title: "富饶的西沙群岛", chars: "富 优 浅 错 岩 虾 挺 鼓 数 厚 宝 贵" },
        { unit: 6, id: "6-13", title: "海滨小城", chars: "滨 灰 渔 遍 躺 载 靠 栽 亚 夏 除 踩 洁" },
        { unit: 6, id: "6-14", title: "美丽的小兴安岭", chars: "脑 袋 严 实 挡 视 线 坛 显 材 软 刮 库" },
        { unit: 7, id: "7-15", title: "大自然的声音", chars: "妙 演 奏 琴 柔 感 受 激 击 器 滴 敲 鸣" },
        { unit: 7, id: "7-16", title: "父亲、树林和鸟", chars: "朝 雾 蒙 鼻 总 抖 露 湿 吸 猎 翅 膀 重" },
        { unit: 7, id: "7-17", title: "带刺的朋友", chars: "刺 枣 颗 忽 乎 暗 伸 匆 沟 聪 偷 追 腰" },
        { unit: 8, id: "8-18", title: "司马光", chars: "司 庭 登 跌 众 弃 持" },
        { unit: 8, id: "8-19", title: "掌声", chars: "掌 班 默 腿 轮 投 调 摇 晃 烈 勇" },
        { unit: 8, id: "8-20", title: "灰雀", chars: "雀 郊 养 粉 粒 男 或 者 冻 惜 肯 诚" }
      ],

      "3下": [
        // ★ 三年级下（按人教版常见目录整理；可在“编辑”里微调）
        // 第一单元
        {unit:1,id:"1-1",title:"古诗三首",chars:"鸳 鸯 惠 崇 豚 减"},
        {unit:1,id:"1-2",title:"燕子",chars:"伶 俐 翼 漾 倦 闲 散 纤 杆 痕"},
        {unit:1,id:"1-3",title:"荷花",chars:"挨 蓬 胀 翩 蹈"},
        {unit:1,id:"1-4",title:"昆虫备忘录",chars:"录 凡 距 款 绸 膜 瞎 益 约 蚂 斑"},

        // 第二单元
        {unit:2,id:"2-5",title:"守株待兔",chars:"宋 耕 释 冀"},
        {unit:2,id:"2-6",title:"陶罐和铁罐",chars:"陶 罐 骄 谦 虚 懦 弱 恼 代 价"},
        {unit:2,id:"2-7",title:"鹿角和鹿腿",chars:"称 禁 皱 配 怨 狮 逼 撒 挣"},
        {unit:2,id:"2-8",title:"池子与河流",chars:"滔 涯 妇 碌 遵 循 尊 验"},

        // 第三单元
        {unit:3,id:"3-9",title:"古诗三首",chars:"屠 苏 魂 酒 牧 兄 倍"},
        {unit:3,id:"3-10",title:"纸的发明",chars:"创 携 存 制 麻 蔡 伦 累 切 鲜 欧 洲 社"},
        {unit:3,id:"3-11",title:"赵州桥",chars:"县 拱 济 匠 计 史 爪 智 慧 历"},
        {unit:3,id:"3-12",title:"一幅名扬中外的画",chars:"择 都 宫 摊 贩 吏 作 态 驴 寸 乘 笼 栏 貌"},

        // 第四单元
        {unit:4,id:"4-13",title:"花钟",chars:"芬 芳 内 作 燥 灼 适 雅 吻 组"},
        {unit:4,id:"4-14",title:"蜜蜂",chars:"概 阻 括 误 逆 途 陌 超"},
        {unit:4,id:"4-15",title:"小虾",chars:"缸 隙 掀 末 副 钳 搏 较 腹"},

        // 第五单元
        {unit:5,id:"5-16",title:"宇宙的另一边",chars:"淌 秘 栋 吁 绪 篇"},
        {unit:5,id:"5-17",title:"我变成了一棵树",chars:"希 痒 鳄 丁 零 肠 醋"},

        // 第六单元
        {unit:6,id:"6-18",title:"童年的水墨画",chars:"墨 染 碎 浪 溅 爽"},
        {unit:6,id:"6-19",title:"剃头大师",chars:"剃 执 否 骂 仇 惯 刑 替 厘 摸"},
        {unit:6,id:"6-20",title:"肥皂泡",chars:"廊 和 悠 若 娇 薄 颤 巍 巅 婴"},
        {unit:6,id:"6-21",title:"我不能失信",chars:"耀 庆 盼 叠 歉"},

        // 第七单元
        {unit:7,id:"7-22",title:"我们奇妙的世界",chars:"呈 雕 幻 辉 芒 剑 型"},
        {unit:7,id:"7-23",title:"海底世界",chars:"窃 私 警 肌 章 胞 达 煤 储 属"},
        {unit:7,id:"7-24",title:"火烧云",chars:"檀 喂 盈 彤 跪 庙 模 揉"},

        // 第八单元
        {unit:8,id:"8-25",title:"慢性子裁缝和急性子顾客",chars:"缝 箱 夸 歪 承 袖 衬 衫 负 泄 艺"},
        {unit:8,id:"8-26",title:"方帽子店",chars:"橱 改 蕉 扣 嚷 溜 筒 董"},
        {unit:8,id:"8-27",title:"漏",chars:"婆 脊 贼 莫 颠 胶 旋 纵"},
        {unit:8,id:"8-28",title:"枣核",chars:"核 妻 爹 犁 折 困 牲 府 罢 涨"},
        ],
    };

    // ========== 应用逻辑 ==========
    const bookSelect = document.getElementById('bookSelect');
    const listEl = document.getElementById('lessonList');
    const progressInfoEl = document.getElementById('progressInfo');
    const currentCardEl = document.getElementById('currentCard');
    const currentHanziEl = document.getElementById('currentHanzi');
    const currentPinyinEl = document.getElementById('currentPinyin');
    
    // 学习状态
    let currentDeck = [];
    let currentIndex = 0;
    let isStudyMode = false;
    let isDictationMode = false;
    let speechSynthesis = null;
    let currentUtterance = null;

    function groupBy(arr, key){return arr.reduce((m,it)=>((m[it[key]]??=[]).push(it),m),{})}
    function unique(arr){return [...new Set(arr)]}
    function shuffle(arr){const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
    function getPinyinForChar(ch){
      try{
        // 检查 pinyinPro 是否可用
        if (typeof pinyinPro === 'undefined') {
          console.warn('pinyinPro 库未加载');
          return '';
        }
        
        // 使用 pinyin-pro 库获取拼音
        const py = pinyinPro.pinyin(ch, { 
          toneType: 'mark',  // 使用声调标记
          type: 'string',    // 返回字符串而不是数组
          multiple: false    // 只返回第一个读音
        });
        
        console.log(`字符 "${ch}" 的拼音:`, py);
        return py || '';
      }catch(e){ 
        console.warn('获取拼音失败:', ch, e);
        return ''; 
      }
    }

    function renderLessonList(){
      const book = bookSelect.value;
      const LESSONS = DATA[book] || [];
      const grouped = groupBy(LESSONS,'unit');
      let html = '';
      Object.keys(grouped).sort((a,b)=>+a-+b).forEach(u=>{
        html += `<h4>第${u}单元</h4>`;
        grouped[u].forEach(l=>{
          html += `
            <label class="lesson-item">
              <input type="checkbox" data-id="${l.id}" checked>
              <span>${l.title}</span>
            </label>`;
        });
      });
      listEl.innerHTML = html || '<div style="color:#999;padding:6px 4px;">本册暂无数据</div>';
    }

    function collectChars(){
      const book = bookSelect.value;
      const LESSONS = DATA[book] || [];
      const checks = [...listEl.querySelectorAll('input[type="checkbox"]')].filter(c=>c.checked);
      const chosenIds = new Set(checks.map(c=>c.dataset.id));
      const pool = [];
      
      console.log('当前册别:', book); // 调试信息
      console.log('选中的课文:', chosenIds); // 调试信息
      
      LESSONS.forEach(l=>{
        if(chosenIds.size===0 || chosenIds.has(l.id)){
          const chars = (l.chars||'').split(/\s+/).filter(Boolean);
          pool.push(...chars);
        }
      });
      return unique(pool);
    }

    function buildDeck(){
      const pool = collectChars();
      if(pool.length===0){
        progressInfoEl.textContent = '没有可用生字，请先在设置中选择课文';
        return false;
      }
      
      const studyMode = document.getElementById('studyMode').value;
      if(studyMode === 'random') {
        currentDeck = shuffle(pool).map(ch=>({ch, py:getPinyinForChar(ch)}));
      } else {
        currentDeck = pool.map(ch=>({ch, py:getPinyinForChar(ch)}));
      }
      
      currentIndex = 0;
      isStudyMode = true;
      return true;
    }

    function showCurrentCard(){
      if(!isStudyMode || currentDeck.length === 0) return;
      
      const current = currentDeck[currentIndex];
      currentHanziEl.textContent = current.ch;
      currentPinyinEl.textContent = current.py || '暂无拼音';
      
      // 重置卡片状态
      currentCardEl.classList.remove('flipped');
      
      // 更新进度信息
      progressInfoEl.textContent = `${currentIndex + 1} / ${currentDeck.length}`;
      
      // 显示/隐藏控制按钮
      document.getElementById('btnNext').style.display = currentIndex < currentDeck.length - 1 ? 'block' : 'none';
      document.getElementById('btnPrev').style.display = currentIndex > 0 ? 'block' : 'none';
    }

    function nextCard(){
      if(currentIndex < currentDeck.length - 1) {
        currentIndex++;
        showCurrentCard();
      }
    }

    function prevCard(){
      if(currentIndex > 0) {
        currentIndex--;
        showCurrentCard();
      }
    }

    function startStudy(){
      if(buildDeck()) {
        const practiceMode = document.getElementById('practiceMode').value;
        
        if(practiceMode === 'dictation') {
          startDictationMode();
        } else {
          showCurrentCard();
          document.getElementById('btnStart').style.display = 'none';
          document.getElementById('btnNext').style.display = 'block';
          document.getElementById('btnPrev').style.display = 'block';
          document.getElementById('btnShuffle').style.display = 'block';
          progressInfoEl.textContent = `1 / ${currentDeck.length}`;
        }
      }
    }

    // ========== 听写功能 ==========
    
    // 语音合成配置
    let VOICE_CONFIG = {
      // 预录音方案：使用在线汉字读音库
      usePreRecorded: true,
      // 在线TTS API配置
      onlineTTS: {
        provider: 'edge', // 'baidu', 'aliyun', 'tencent', 'edge'
        fallbackToNative: true
      }
    };

    // 根据用户选择更新语音配置
    function updateVoiceConfig() {
      // 固定使用中等质量：优化TTS
      VOICE_CONFIG.usePreRecorded = false;
      console.log('🎯 启用中等质量语音（优化TTS）');
    }

    function initSpeechSynthesis() {
      if ('speechSynthesis' in window) {
        speechSynthesis = window.speechSynthesis;
        
        // 等待语音列表加载
        if (speechSynthesis.getVoices().length === 0) {
          speechSynthesis.addEventListener('voiceschanged', () => {
            console.log('语音列表已加载');
          });
        }
        
        return true;
      } else {
        console.warn('浏览器不支持语音合成功能');
        return false;
      }
    }

    // 获取最佳中文语音（海外优化版本）
    function getBestChineseVoice() {
      const voices = speechSynthesis.getVoices();
      
      // 海外友好的语音选择（按优先级排序）
      const preferredVoices = [
        // Microsoft Edge 语音（海外质量最佳）
        'Microsoft Xiaoxiao Online (Natural) - Chinese (Mainland)',
        'Microsoft Xiaoxiao - Chinese (Simplified, PRC)',
        'Microsoft Yunyang - Chinese (Mainland)',
        'Microsoft Kangkang - Chinese (Mainland)',
        
        // Google Chrome 语音
        'Google 普通话（中国大陆）',
        'Google 中文（中国）',
        'Chinese (China)',
        
        // Safari 语音（macOS/iOS）
        'Ting-Ting (Enhanced)', // macOS增强版
        'Ting-Ting', // macOS
        'Sin-ji', // iOS
        'Mei-Jia', // 台湾中文
        
        // 其他中文语音
        'Chinese (Taiwan)',
        'Chinese (Hong Kong)',
        'zh-CN',
        'zh-TW',
        'zh-HK'
      ];
      
      console.log('可用语音列表:', voices.map(v => `${v.name} (${v.lang})`));
      
      for (const preferred of preferredVoices) {
        const voice = voices.find(v => 
          v.name.includes(preferred) || 
          v.name === preferred ||
          (v.lang && (v.lang.includes('zh-CN') || v.lang.includes('zh-TW') || v.lang.includes('zh')))
        );
        if (voice) {
          console.log('✅ 选择语音:', voice.name, '语言:', voice.lang);
          return voice;
        }
      }
      
      // 最后尝试任何包含中文的语音
      const anyChineseVoice = voices.find(v => 
        v.lang && (v.lang.toLowerCase().includes('zh') || v.lang.toLowerCase().includes('chinese'))
      );
      
      if (anyChineseVoice) {
        console.log('✅ 找到中文语音:', anyChineseVoice.name);
        return anyChineseVoice;
      }
      
      console.warn('⚠️ 未找到中文语音，使用默认语音');
      return voices[0] || null;
    }

    // 使用预录音方案（海外友好的在线语音源）
    async function playPreRecordedAudio(character) {
      // 海外可用的语音源，按优先级排序
      const audioSources = [
        // Google翻译语音（海外友好，无需API密钥）
        `https://translate.google.com/translate_tts?ie=UTF-8&tl=zh&client=tw-ob&q=${encodeURIComponent(character)}`,
        
        // 有道词典语音（通常海外可用）
        `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(character)}&type=1`,
        
        // Microsoft翻译语音（海外友好）
        `https://www.bing.com/translator/api/language/Speak?locale=zh-Hans&gender=female&media=audio/mp3&text=${encodeURIComponent(character)}`,
        
        // Voice RSS（免费TTS服务，海外可用）
        `https://api.voicerss.org/?key=demo&hl=zh-cn&c=MP3&f=44khz_16bit_stereo&src=${encodeURIComponent(character)}`,
      ];

      const playBtn = document.getElementById('btnPlayAudio');
      const soundWaves = document.getElementById('soundWaves');

      for (let i = 0; i < audioSources.length; i++) {
        try {
          console.log(`尝试语音源 ${i + 1}: ${audioSources[i]}`);
          
          const audio = new Audio();
          audio.src = audioSources[i];
          audio.volume = 1.0;
          
          // 添加播放状态指示
          playBtn.textContent = '🔊 播放中...';
          playBtn.disabled = true;
          soundWaves.classList.add('playing');
          
          // 等待音频加载并播放
          await new Promise((resolve, reject) => {
            audio.oncanplaythrough = async () => {
              try {
                await audio.play();
                resolve();
              } catch (error) {
                reject(error);
              }
            };
            
            audio.onended = () => {
              playBtn.textContent = '🔊 播放';
              playBtn.disabled = false;
              soundWaves.classList.remove('playing');
              resolve();
            };
            
            audio.onerror = () => {
              playBtn.textContent = '🔊 播放';
              playBtn.disabled = false;
              soundWaves.classList.remove('playing');
              reject(new Error('音频加载失败'));
            };
            
            // 设置超时
            setTimeout(() => {
              reject(new Error('音频加载超时'));
            }, 5000);
          });
          
          console.log(`✅ 语音源 ${i + 1} 播放成功`);
          return true;
          
        } catch (error) {
          console.warn(`语音源 ${i + 1} 失败:`, error);
          
          // 重置状态
          playBtn.textContent = '🔊 播放';
          playBtn.disabled = false;
          soundWaves.classList.remove('playing');
          
          // 如果不是最后一个源，继续尝试下一个
          if (i < audioSources.length - 1) {
            console.log('尝试下一个语音源...');
            continue;
          }
        }
      }
      
      console.warn('所有在线语音源都失败了');
      return false;
    }

    // 使用高质量TTS（海外优化版本）
    async function playWithEdgeTTS(character) {
      return new Promise((resolve, reject) => {
        try {
          const utterance = new SpeechSynthesisUtterance(character);
          const voice = getBestChineseVoice();
          
          if (voice) {
            utterance.voice = voice;
            console.log(`🎯 使用语音: ${voice.name}`);
          } else {
            console.warn('⚠️ 未找到合适的中文语音');
          }
          
          // 针对海外用户优化的语音设置
          utterance.lang = voice ? voice.lang : 'zh-CN';
          utterance.rate = 0.5; // 非常慢的语速，适合儿童学习
          utterance.pitch = 1.2; // 稍高音调，更清晰
          utterance.volume = 1.0;
          
          // 添加播放状态
          const playBtn = document.getElementById('btnPlayAudio');
          const soundWaves = document.getElementById('soundWaves');
          
          utterance.onstart = () => {
            playBtn.textContent = '🔊 播放中...';
            playBtn.disabled = true;
            soundWaves.classList.add('playing');
          };
          
          utterance.onend = () => {
            playBtn.textContent = '🔊 播放';
            playBtn.disabled = false;
            soundWaves.classList.remove('playing');
            resolve(true);
          };
          
          utterance.onerror = (event) => {
            console.error('优化TTS播放失败:', event);
            playBtn.textContent = '🔊 播放';
            playBtn.disabled = false;
            soundWaves.classList.remove('playing');
            reject(new Error('TTS播放失败'));
          };
          
          // 确保停止之前的播放
          speechSynthesis.cancel();
          
          // 等待一小段时间再播放，确保cancel生效
          setTimeout(() => {
            speechSynthesis.speak(utterance);
          }, 100);
          
        } catch (error) {
          console.warn('优化TTS初始化失败:', error);
          reject(error);
        }
      });
    }

    // 添加特殊的语音增强函数（针对海外用户）
    async function playWithEnhancedTTS(character) {
      return new Promise((resolve, reject) => {
        try {
          // 为单个汉字添加适当的停顿和重音
          const enhancedText = character;
          
          const utterance = new SpeechSynthesisUtterance(enhancedText);
          const voice = getBestChineseVoice();
          
          if (voice) {
            utterance.voice = voice;
          }
          
          // 特别优化的设置
          utterance.lang = 'zh-CN';
          utterance.rate = 0.4; // 极慢语速
          utterance.pitch = 1.3; // 高音调
          utterance.volume = 1.0;
          
          const playBtn = document.getElementById('btnPlayAudio');
          const soundWaves = document.getElementById('soundWaves');
          
          utterance.onstart = () => {
            playBtn.textContent = '🔊 播放中...';
            playBtn.disabled = true;
            soundWaves.classList.add('playing');
          };
          
          utterance.onend = () => {
            playBtn.textContent = '🔊 播放';
            playBtn.disabled = false;
            soundWaves.classList.remove('playing');
            resolve(true);
          };
          
          utterance.onerror = (event) => {
            playBtn.textContent = '🔊 播放';
            playBtn.disabled = false;
            soundWaves.classList.remove('playing');
            reject(new Error('增强TTS播放失败'));
          };
          
          speechSynthesis.cancel();
          setTimeout(() => {
            speechSynthesis.speak(utterance);
          }, 150);
          
        } catch (error) {
          reject(error);
        }
      });
    }

    // 智能语音播放函数（海外优化多方案降级）
    async function speakText(text) {
      // 防止重复播放
      const playBtn = document.getElementById('btnPlayAudio');
      if (playBtn.textContent.includes('播放中')) {
        return;
      }

      const quality = 'medium'; // 固定使用中等质量
      let success = false;

      console.log(`🎯 开始语音播放，质量设置: ${quality}，字符: ${text}`);

      // 方案1: 使用在线预录音（仅在高质量模式下）
      if (quality === 'high' && VOICE_CONFIG.usePreRecorded) {
        try {
          console.log('🌐 尝试在线语音服务...');
          success = await playPreRecordedAudio(text);
          if (success) {
            console.log('✅ 在线语音播放成功');
            return;
          }
        } catch (error) {
          console.warn('在线语音失败:', error);
        }
      }

      // 方案2: 使用增强TTS（中高质量模式）
      if (!success && (quality === 'high' || quality === 'medium')) {
        try {
          console.log('🎯 尝试增强TTS...');
          success = await playWithEnhancedTTS(text);
          if (success) {
            console.log('✅ 增强TTS播放成功');
            return;
          }
        } catch (error) {
          console.warn('增强TTS失败:', error);
        }
      }

      // 方案3: 使用优化TTS
      if (!success) {
        try {
          console.log('🎮 尝试优化TTS...');
          success = await playWithEdgeTTS(text);
          if (success) {
            console.log('✅ 优化TTS播放成功');
            return;
          }
        } catch (error) {
          console.warn('优化TTS失败:', error);
        }
      }

      // 方案4: 降级到基础Web Speech API
      if (!success) {
        try {
          console.log('🔄 使用基础TTS...');
          await playWithNativeTTS(text);
          console.log('✅ 基础TTS播放成功');
        } catch (error) {
          console.error('❌ 所有语音方案都失败了:', error);
          
          // 显示友好的错误提示
          const playBtn = document.getElementById('btnPlayAudio');
          const soundWaves = document.getElementById('soundWaves');
          
          playBtn.textContent = '🔊 播放失败';
          playBtn.disabled = false;
          soundWaves.classList.remove('playing');
          
          // 显示用户提示
          setTimeout(() => {
            playBtn.textContent = '🔊 播放';
            alert('语音播放失败，可能原因：\n\n1. 网络连接问题\n2. 浏览器不支持中文语音\n3. 系统未安装中文语音包\n\n建议：\n• 检查网络连接\n• 使用Chrome或Edge浏览器\n• 在设置中降低语音质量');
          }, 2000);
        }
      }
    }

    // 基础Web Speech API播放（降级方案）
    async function playWithNativeTTS(text) {
      return new Promise((resolve, reject) => {
        if (!speechSynthesis) {
          if (!initSpeechSynthesis()) {
            reject(new Error('浏览器不支持语音功能'));
            return;
          }
        }

        // 停止当前播放的语音
        speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        const voice = getBestChineseVoice();
        
        if (voice) {
          utterance.voice = voice;
        }
        
        // 优化的语音设置
        utterance.lang = 'zh-CN';
        utterance.rate = 0.6; // 更慢的语速
        utterance.pitch = 1.1; // 稍高音调，更清晰
        utterance.volume = 1.0;

        // 播放状态管理
        const playBtn = document.getElementById('btnPlayAudio');
        const soundWaves = document.getElementById('soundWaves');

        utterance.onstart = () => {
          soundWaves.classList.add('playing');
          playBtn.textContent = '🔊 播放中...';
          playBtn.disabled = true;
        };

        utterance.onend = () => {
          soundWaves.classList.remove('playing');
          playBtn.textContent = '🔊 播放';
          playBtn.disabled = false;
          resolve();
        };

        utterance.onerror = (event) => {
          console.error('原生TTS播放错误:', event);
          soundWaves.classList.remove('playing');
          playBtn.textContent = '🔊 播放';
          playBtn.disabled = false;
          reject(new Error('原生TTS播放失败'));
        };

        speechSynthesis.speak(utterance);
      });
    }

    function startDictationMode() {
      isDictationMode = true;
      
      // 更新语音配置
      updateVoiceConfig();
      
      // 显示听写界面，隐藏识字卡
      document.getElementById('dictationContainer').style.display = 'block';
      document.getElementById('currentCard').parentElement.style.display = 'none';
      
      // 显示听写控制按钮，隐藏识字卡按钮
      document.getElementById('btnStart').style.display = 'none';
      document.getElementById('btnNext').style.display = 'none';
      document.getElementById('btnPrev').style.display = 'none';
      document.getElementById('btnShuffle').style.display = 'none';
      
      document.getElementById('btnCheck').style.display = 'block';
      document.getElementById('btnNextDictation').style.display = 'none';
      document.getElementById('btnReplay').style.display = 'block';
      
      // 初始化语音功能
      initSpeechSynthesis();
      
      // 显示语音质量提示
      const quality = 'medium'; // 固定使用中等质量
      const qualityText = {
        'medium': '中等质量系统语音'
      };
      
      console.log(`🎯 听写模式启动，使用 ${qualityText[quality]}`);
      
      // 显示当前题目
      showCurrentDictation();
      
      // 自动播放第一个字的读音
      setTimeout(() => {
        playCurrentCharAudio();
      }, 500);
    }

    function showCurrentDictation() {
      if(!isDictationMode || currentDeck.length === 0) return;
      
      const current = currentDeck[currentIndex];
      
      // 清空输入框和结果区域
      const inputEl = document.getElementById('dictationInput');
      const resultEl = document.getElementById('resultArea');
      
      inputEl.value = '';
      inputEl.className = '';
      resultEl.style.display = 'none';
      resultEl.className = 'result-area';
      
      // 重置拼音显示
      document.getElementById('dictationPinyin').textContent = '点击播放听声音';
      
      // 更新进度
      progressInfoEl.textContent = `听写练习 ${currentIndex + 1} / ${currentDeck.length}`;
      
      // 控制按钮状态
      document.getElementById('btnCheck').style.display = 'block';
      document.getElementById('btnNextDictation').style.display = 'none';
      
      // 聚焦输入框
      inputEl.focus();
    }

    function playCurrentCharAudio() {
      if(!isDictationMode || currentDeck.length === 0) return;
      
      const current = currentDeck[currentIndex];
      
      // 显示拼音提示（播放后显示）
      setTimeout(() => {
        document.getElementById('dictationPinyin').textContent = current.py || '暂无拼音';
      }, 100);
      
      // 播放汉字读音
      speakText(current.ch);
    }

    function checkDictationAnswer() {
      const inputEl = document.getElementById('dictationInput');
      const resultEl = document.getElementById('resultArea');
      const userAnswer = inputEl.value.trim();
      const correctAnswer = currentDeck[currentIndex].ch;
      const correctPinyin = currentDeck[currentIndex].py;
      
      if(!userAnswer) {
        alert('请先输入答案');
        return;
      }
      
      const isCorrect = userAnswer === correctAnswer;
      
      // 显示结果
      resultEl.style.display = 'block';
      
      if(isCorrect) {
        resultEl.className = 'result-area correct';
        document.getElementById('resultIcon').textContent = '✓';
        document.getElementById('resultText').textContent = '回答正确！';
        inputEl.className = 'correct';
      } else {
        resultEl.className = 'result-area incorrect';
        document.getElementById('resultIcon').textContent = '✗';
        document.getElementById('resultText').textContent = '答案不对，再试试吧';
        inputEl.className = 'incorrect';
      }
      
      // 显示正确答案
      document.getElementById('correctAnswer').textContent = correctAnswer;
      document.getElementById('correctPinyin').textContent = correctPinyin || '';
      
      // 控制按钮状态
      document.getElementById('btnCheck').style.display = 'none';
      if(currentIndex < currentDeck.length - 1) {
        document.getElementById('btnNextDictation').style.display = 'block';
      } else {
        document.getElementById('btnNextDictation').textContent = '完成练习';
        document.getElementById('btnNextDictation').style.display = 'block';
      }
    }

    function nextDictation() {
      if(currentIndex < currentDeck.length - 1) {
        currentIndex++;
        showCurrentDictation();
        // 自动播放下一个字
        setTimeout(() => {
          playCurrentCharAudio();
        }, 300);
      } else {
        // 练习完成
        finishDictation();
      }
    }

    function finishDictation() {
      // 计算正确率（这里简化处理，实际应用中可以记录每个字的正确性）
      const totalChars = currentDeck.length;
      alert(`🎉 听写练习完成！\n\n📊 练习统计：\n• 总字数：${totalChars} 个\n• 练习模式：听写训练\n\n💡 提示：可以多次练习来加深记忆！\n\n点击确定返回主界面。`);
      resetStudy();
    }

    // 添加触摸设备的优化
    function optimizeForTouch() {
      // 检测触摸设备
      if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
        // 为触摸设备添加额外的交互改进
        const inputEl = document.getElementById('dictationInput');
        
        // 防止移动端键盘遮挡
        inputEl.addEventListener('focus', () => {
          setTimeout(() => {
            inputEl.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'center',
              inline: 'nearest'
            });
          }, 300);
        });
        
        // 优化软键盘体验
        inputEl.addEventListener('blur', () => {
          // 软键盘收起后重新调整视图
          setTimeout(() => {
            window.scrollTo(0, 0);
          }, 100);
        });
      }
    }

    function shuffleCurrentDeck(){
      if(!isStudyMode || currentDeck.length === 0) return;
      
      // 打乱顺序
      currentDeck = shuffle(currentDeck);
      
      // 自动回到第一个生字
      currentIndex = 0;
      
      // 显示当前卡片
      showCurrentCard();
      
      // 显示提示
      progressInfoEl.textContent = `1 / ${currentDeck.length} (已随机)`;
      setTimeout(() => {
        progressInfoEl.textContent = `1 / ${currentDeck.length}`;
      }, 2000);
    }

    // ========== 打印功能 ==========
    
    // 获取笔画数
    function getStrokeCount(char) {
      return STROKE_ORDER[char] || '?';
    }
    
    // 更新打印生字列表显示
    function updatePrintCharsList() {
      const charsListEl = document.getElementById('printCharsList');
      
      if (!charsListEl) {
        console.error('找不到 printCharsList 元素');
        return;
      }
      
      // 先显示加载状态
      charsListEl.innerHTML = '<span style="color: #666;">正在收集生字...</span>';
      
      // 延迟执行，确保DOM已准备好
      setTimeout(() => {
        const chars = collectChars();
        
        console.log('收集到的生字:', chars); // 调试信息
        
        if (!chars || chars.length === 0) {
          charsListEl.innerHTML = '<span style="color: #ff6b6b;">⚠️ 没有可打印的生字，请先在设置中选择课文</span>';
          return;
        }
        
        // 按每行显示10个字符
        let html = `<div style="margin-bottom: 8px;"><strong>共 ${chars.length} 个生字：</strong></div>`;
        html += '<div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">';
        
        chars.forEach((char, index) => {
          const strokeCount = getStrokeCount(char);
          html += `<span style="display: inline-block; padding: 4px 8px; background: #fff; border: 1px solid var(--border); border-radius: 4px; font-size: 16px; font-weight: bold;">${char}</span>`;
          
          // 每行显示10个字符后换行
          if ((index + 1) % 10 === 0) {
            html += '<br>';
          }
        });
        
        html += '</div>';
        
        // 添加笔画数统计
        const strokeCounts = chars.map(char => getStrokeCount(char)).filter(count => count !== '?');
        if (strokeCounts.length > 0) {
          const avgStrokes = (strokeCounts.reduce((sum, count) => sum + count, 0) / strokeCounts.length).toFixed(1);
          html += `<div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">平均笔画数：${avgStrokes}画</div>`;
        }
        
        charsListEl.innerHTML = html;
      }, 100);
    }
    
    // 生成田字格HTML
    function generateTianziGrid(char, showStrokeOrder = false, isTraceMode = false) {
      const strokeCount = getStrokeCount(char);
      const strokeOrderHtml = showStrokeOrder ? `<div class="tianzi-stroke-order">${strokeCount}</div>` : '';
      const traceClass = isTraceMode ? ' trace' : '';
      
      return `
        <div class="tianzi-grid">
          <div class="tianzi-char${traceClass}">${char}</div>
          ${strokeOrderHtml}
        </div>
      `;
    }
    
    // 生成打印内容
    function generatePrintContent() {
      const chars = collectChars();
      if (chars.length === 0) {
        alert('没有可打印的生字，请先在设置中选择课文');
        return null;
      }
      
      const isTraceMode = document.getElementById('printTraceMode').checked;
      
      let html = `
        <div class="print-page">
          <div class="print-grid-container">
      `;
      
      if (isTraceMode) {
        // 描字模式：每行9个田字格都写生字（空心字）
        chars.forEach((char, index) => {
          // 每行9个田字格都写生字
          for (let i = 0; i < 9; i++) {
            html += generateTianziGrid(char, false, true);
          }
          
          // 每行9个田字格后换行
          html += '<br>';
        });
      } else {
        // 默认模式：每行第一个田字格写生字，剩下8个都是空的
        chars.forEach((char, index) => {
          // 第一个田字格写生字
          html += generateTianziGrid(char, false, false);
          
          // 剩下8个田字格都是空的
          for (let i = 0; i < 8; i++) {
            html += generateTianziGrid('', false, false);
          }
          
          // 每行9个田字格后换行
          html += '<br>';
        });
      }
      
      html += `
          </div>
        </div>
      `;
      
      return html;
    }
    
    // 执行打印
    function executePrint() {
      const printHtml = generatePrintContent();
      if (!printHtml) return;
      
      // 创建打印窗口
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>田字格生字练习</title>
          <style>
            body { margin: 0; padding: 0; font-family: 'SimSun', '宋体', serif; }
            .tianzi-grid {
              display: inline-block;
              width: 18mm;
              height: 18mm;
              border: 1px solid #000;
              position: relative;
              margin: 0;
              vertical-align: top;
              box-sizing: border-box;
            }
            .tianzi-grid::before {
              content: '';
              position: absolute;
              top: 50%;
              left: 0;
              right: 0;
              height: 1px;
              background: #000;
              border-top: 1px dashed #000;
              transform: translateY(-50%);
            }
            .tianzi-grid::after {
              content: '';
              position: absolute;
              left: 50%;
              top: 0;
              bottom: 0;
              width: 1px;
              background: #000;
              border-left: 1px dashed #000;
              transform: translateX(-50%);
            }
            .tianzi-char {
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              font-size: 14mm;
              font-weight: normal;
              line-height: 1;
              font-family: 'KaiTi', '楷体', 'STKaiti', '华文楷体', 'STKaiti', 'SimKai', serif;
              color: transparent;
              -webkit-text-stroke: 0.5px #000;
            }
            .tianzi-char.trace {
              color: transparent;
              -webkit-text-stroke: 0.5px #000;
            }
            .tianzi-stroke-order {
              position: absolute;
              top: 2px;
              right: 2px;
              font-size: 8px;
              color: #666;
              line-height: 1;
            }
            .print-page {
              width: 210mm;
              min-height: 297mm;
              margin: 0 auto;
              padding: 20mm;
              background: white;
              font-family: 'SimSun', '宋体', serif;
              font-size: 12pt;
              line-height: 1.5;
              box-sizing: border-box;
            }
            .print-grid-container {
              display: block;
              margin-bottom: 20px;
              line-height: 0;
            }
            @media print {
              body { margin: 0; padding: 0; }
              .print-page {
                width: 100%;
                margin: 0;
                padding: 20mm;
                box-sizing: border-box;
              }
              .tianzi-grid {
                break-inside: avoid;
              }
              .tianzi-char {
                color: transparent !important;
                -webkit-text-stroke: 0.5px #000 !important;
                font-weight: normal !important;
              }
            }
          </style>
        </head>
        <body>
          ${printHtml}
        </body>
        </html>
      `);
      
      printWindow.document.close();
      
      // 等待内容加载完成后打印
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 500);
      };
    }

    // 页面加载完成后初始化
    document.getElementById('btnSelectAll').onclick = ()=>{listEl.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=true)};
    document.getElementById('btnClear').onclick = ()=>{listEl.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false)};
    document.getElementById('btnStart').onclick = startStudy;
    document.getElementById('btnNext').onclick = nextCard;
    document.getElementById('btnPrev').onclick = prevCard;
    document.getElementById('btnShuffle').onclick = shuffleCurrentDeck;
    document.getElementById('btnStartStudy').onclick = ()=>{startStudy(); document.getElementById('settingsModal').classList.remove('show');};
    document.getElementById('btnSettings').onclick = ()=>{document.getElementById('settingsModal').classList.add('show');};
    document.getElementById('btnCloseSettings').onclick = ()=>{document.getElementById('settingsModal').classList.remove('show');};
    currentCardEl.addEventListener('click', ()=>{currentCardEl.classList.toggle('flipped')});
    bookSelect.addEventListener('change', ()=>{renderLessonList(); resetStudy()});
    
    // 打印功能事件绑定
    console.log('开始绑定打印按钮事件...');
    const printBtn = document.getElementById('btnPrint');
    console.log('打印按钮元素:', printBtn);
    if (printBtn) {
      printBtn.onclick = ()=>{
      console.log('打印按钮被点击');
      // 确保课文列表已经渲染
      if (listEl.innerHTML.includes('本册暂无数据') || listEl.querySelectorAll('input[type="checkbox"]').length === 0) {
        renderLessonList();
      }
      updatePrintCharsList();
      const printModal = document.getElementById('printModal');
      console.log('找到printModal元素:', printModal);
      if (printModal) {
        printModal.classList.add('show');
        printModal.style.display = 'flex';
        printModal.style.visibility = 'visible';
        console.log('已添加show类并设置display');
      } else {
        console.error('未找到printModal元素');
      }
      };
    } else {
      console.error('未找到打印按钮元素');
    }
    document.getElementById('btnCancelPrint').onclick = ()=>{
      const printModal = document.getElementById('printModal');
      printModal.classList.remove('show');
      printModal.style.display = 'none';
      printModal.style.visibility = 'hidden';
    };
    document.getElementById('btnConfirmPrint').onclick = ()=>{executePrint(); document.getElementById('printModal').classList.remove('show');};
    
    // 听写功能事件绑定
    document.getElementById('btnPlayAudio').onclick = playCurrentCharAudio;
    document.getElementById('btnCheck').onclick = checkDictationAnswer;
    document.getElementById('btnNextDictation').onclick = nextDictation;
    document.getElementById('btnReplay').onclick = playCurrentCharAudio;
    
    // 听写输入框回车键检查答案
    document.getElementById('dictationInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const checkBtn = document.getElementById('btnCheck');
        const nextBtn = document.getElementById('btnNextDictation');
        
        if (checkBtn.style.display !== 'none') {
          checkDictationAnswer();
        } else if (nextBtn.style.display !== 'none') {
          nextDictation();
        }
      }
    });
    
    function resetStudy(){
      isStudyMode = false;
      isDictationMode = false;
      currentDeck = [];
      currentIndex = 0;
      
      // 停止语音播放
      if(speechSynthesis) {
        speechSynthesis.cancel();
      }
      
      // 重置界面显示
      document.getElementById('dictationContainer').style.display = 'none';
      document.getElementById('currentCard').parentElement.style.display = 'flex';
      
      // 重置按钮状态
      document.getElementById('btnStart').style.display = 'block';
      document.getElementById('btnNext').style.display = 'none';
      document.getElementById('btnPrev').style.display = 'none';
      document.getElementById('btnShuffle').style.display = 'none';
      
      // 隐藏听写按钮
      document.getElementById('btnCheck').style.display = 'none';
      document.getElementById('btnNextDictation').style.display = 'none';
      document.getElementById('btnReplay').style.display = 'none';
      
      progressInfoEl.textContent = '点击"开始学习"开始识字';
      currentHanziEl.textContent = '字';
      currentPinyinEl.textContent = 'zì';
      currentCardEl.classList.remove('flipped');
    }

    // ========== 数据编辑器 ==========
    const editModal = document.getElementById('editModal');
    const jsonArea = document.getElementById('jsonArea');
    const btnCancelEdit = document.getElementById('btnCancelEdit');
    const btnSave = document.getElementById('btnSave');
    const btnDownload = document.getElementById('btnDownload');

    // 添加编辑按钮到设置弹窗
    function addEditButton(){
      const settingsDialog = document.querySelector('#settingsModal .dialog');
      const editBtn = document.createElement('button');
      editBtn.textContent = '编辑数据';
      editBtn.className = 'ghost';
      editBtn.style.marginTop = '10px';
      editBtn.onclick = ()=>{
        const book = bookSelect.value;
        const src = (DATA[book]||[]).map(x=>({unit:x.unit,id:x.id,title:x.title,chars:x.chars}));
        jsonArea.value = JSON.stringify(src, null, 2);
        editModal.classList.add('show');
      };
      settingsDialog.appendChild(editBtn);
    }

    btnCancelEdit.onclick = ()=> editModal.classList.remove('show');
    btnSave.onclick = ()=>{
      try{
        const parsed = JSON.parse(jsonArea.value);
        if(!Array.isArray(parsed)) throw new Error('JSON 顶层应为数组');
        const ok = parsed.every(it=>typeof it.unit==='number' && typeof it.id==='string' && typeof it.title==='string' && typeof it.chars==='string');
        if(!ok) throw new Error('每项需包含 {unit:number,id:string,title:string,chars:string}');
        DATA[bookSelect.value] = parsed;
        editModal.classList.remove('show');
        renderLessonList();
        resetStudy();
        alert('数据已更新，请重新开始学习');
      }catch(err){
        alert('解析失败：'+err.message);
      }
    };
    btnDownload.onclick = ()=>{
      const blob = new Blob([jsonArea.value], {type:'application/json;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `生字数据-${bookSelect.value}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    };

    // 等待库加载完成后再初始化
    function initializeApp() {
      if (typeof pinyinPro === 'undefined') {
        console.warn('pinyinPro 库未加载，请检查网络连接');
        // 延迟重试
        setTimeout(initializeApp, 1000);
        return;
      }
      
      console.log('pinyinPro 库已成功加载');
      renderLessonList();
      addEditButton();
      resetStudy();
      optimizeForTouch();
      
      // 绑定所有事件
      console.log('开始绑定事件...');
      
      // 基本功能事件绑定
      const btnSelectAll = document.getElementById('btnSelectAll');
      if (btnSelectAll) btnSelectAll.onclick = ()=>{listEl.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=true)};
      
      const btnClear = document.getElementById('btnClear');
      if (btnClear) btnClear.onclick = ()=>{listEl.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false)};
      
      const btnStart = document.getElementById('btnStart');
      if (btnStart) btnStart.onclick = startStudy;
      
      const btnNext = document.getElementById('btnNext');
      if (btnNext) btnNext.onclick = nextCard;
      
      const btnPrev = document.getElementById('btnPrev');
      if (btnPrev) btnPrev.onclick = prevCard;
      
      const btnShuffle = document.getElementById('btnShuffle');
      if (btnShuffle) btnShuffle.onclick = shuffleCurrentDeck;
      
      const btnStartStudy = document.getElementById('btnStartStudy');
      if (btnStartStudy) btnStartStudy.onclick = ()=>{startStudy(); document.getElementById('settingsModal').classList.remove('show');};
      
      const btnSettings = document.getElementById('btnSettings');
      if (btnSettings) btnSettings.onclick = ()=>{document.getElementById('settingsModal').classList.add('show');};
      
      const btnCloseSettings = document.getElementById('btnCloseSettings');
      if (btnCloseSettings) btnCloseSettings.onclick = ()=>{document.getElementById('settingsModal').classList.remove('show');};
      
      if (currentCardEl) currentCardEl.addEventListener('click', ()=>{currentCardEl.classList.toggle('flipped')});
      if (bookSelect) bookSelect.addEventListener('change', ()=>{renderLessonList(); resetStudy()});
      
      // 打印功能事件绑定
      console.log('开始绑定打印按钮事件...');
      const printBtn = document.getElementById('btnPrint');
      console.log('打印按钮元素:', printBtn);
      if (printBtn) {
        printBtn.onclick = ()=>{
          console.log('打印按钮被点击');
          // 确保课文列表已经渲染
          if (listEl.innerHTML.includes('本册暂无数据') || listEl.querySelectorAll('input[type="checkbox"]').length === 0) {
            renderLessonList();
          }
          updatePrintCharsList();
          const printModal = document.getElementById('printModal');
          console.log('找到printModal元素:', printModal);
          if (printModal) {
            printModal.classList.add('show');
            printModal.style.display = 'flex';
            printModal.style.visibility = 'visible';
            console.log('已添加show类并设置display');
          } else {
            console.error('未找到printModal元素');
          }
        };
      } else {
        console.error('未找到打印按钮元素');
      }
      
      const btnCancelPrint = document.getElementById('btnCancelPrint');
      if (btnCancelPrint) {
        btnCancelPrint.onclick = ()=>{
          const printModal = document.getElementById('printModal');
          if (printModal) {
            printModal.classList.remove('show');
            printModal.style.display = 'none';
            printModal.style.visibility = 'hidden';
          }
        };
      }
      
      const btnConfirmPrint = document.getElementById('btnConfirmPrint');
      if (btnConfirmPrint) {
        btnConfirmPrint.onclick = ()=>{executePrint(); document.getElementById('printModal').classList.remove('show');};
      }
      
      // 听写功能事件绑定
      const btnPlayAudio = document.getElementById('btnPlayAudio');
      if (btnPlayAudio) btnPlayAudio.onclick = playCurrentCharAudio;
      
      const btnCheck = document.getElementById('btnCheck');
      if (btnCheck) btnCheck.onclick = checkDictationAnswer;
      
      const btnNextDictation = document.getElementById('btnNextDictation');
      if (btnNextDictation) btnNextDictation.onclick = nextDictation;
      
      const btnReplay = document.getElementById('btnReplay');
      if (btnReplay) btnReplay.onclick = playCurrentCharAudio;
      
      // 听写输入框回车键检查答案
      const dictationInput = document.getElementById('dictationInput');
      if (dictationInput) {
        dictationInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            checkDictationAnswer();
          }
        });
      }
      
      // 听写模式切换
      const btnDictationMode = document.getElementById('btnDictationMode');
      if (btnDictationMode) {
        btnDictationMode.onclick = ()=>{
          document.getElementById('settingsModal').classList.remove('show');
          startDictationMode();
        };
      }
      
      // 听写设置
      const btnDictationSettings = document.getElementById('btnDictationSettings');
      if (btnDictationSettings) {
        btnDictationSettings.onclick = ()=>{
          document.getElementById('settingsModal').classList.remove('show');
          showDictationSettings();
        };
      }
      
      // 听写设置弹窗事件
      const btnCloseDictationSettings = document.getElementById('btnCloseDictationSettings');
      if (btnCloseDictationSettings) btnCloseDictationSettings.onclick = ()=>{document.getElementById('dictationSettingsModal').classList.remove('show');};
      
      const btnSaveDictationSettings = document.getElementById('btnSaveDictationSettings');
      if (btnSaveDictationSettings) btnSaveDictationSettings.onclick = saveDictationSettings;
      
      // 数据编辑功能
      const btnEditData = document.getElementById('btnEditData');
      if (btnEditData) {
        btnEditData.onclick = ()=>{
          const book = bookSelect.value;
          const LESSONS = DATA[book] || [];
          jsonArea.value = JSON.stringify(LESSONS, null, 2);
          editModal.classList.add('show');
        };
      }
      
      const btnCancelEdit = document.getElementById('btnCancelEdit');
      if (btnCancelEdit) btnCancelEdit.onclick = ()=>{editModal.classList.remove('show');};
      
      const btnSave = document.getElementById('btnSave');
      if (btnSave) {
        btnSave.onclick = ()=>{
          try{
            const parsed = JSON.parse(jsonArea.value);
            if(!Array.isArray(parsed)) throw new Error('JSON 顶层应为数组');
            const ok = parsed.every(it=>typeof it.unit==='number' && typeof it.id==='string' && typeof it.title==='string' && typeof it.chars==='string');
            if(!ok) throw new Error('每项需包含 {unit:number,id:string,title:string,chars:string}');
            DATA[bookSelect.value] = parsed;
            editModal.classList.remove('show');
            renderLessonList();
            resetStudy();
            alert('数据已更新，请重新开始学习');
          }catch(err){
            alert('解析失败：'+err.message);
          }
        };
      }
      
      const btnDownload = document.getElementById('btnDownload');
      if (btnDownload) {
        btnDownload.onclick = ()=>{
          const blob = new Blob([jsonArea.value], {type:'application/json;charset=utf-8'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `生字数据-${bookSelect.value}.json`;
          a.click();
          URL.revokeObjectURL(a.href);
        };
      }
      
      console.log('所有事件绑定完成');
      
      // 更新版本信息
      const versionEl = document.getElementById('appVersion');
      const dateEl = document.getElementById('versionDate');
      const footerVersionEl = document.getElementById('footerVersion');
      
      if (versionEl) versionEl.textContent = APP_VERSION;
      if (dateEl) dateEl.textContent = VERSION_DATE;
      if (footerVersionEl) footerVersionEl.textContent = APP_VERSION;
      
      console.log(`应用版本: v${APP_VERSION} (${VERSION_DATE})`);
      
      // 显示听写功能介绍（仅首次访问）
      if (!localStorage.getItem('dictation-intro-shown-v2')) {
        setTimeout(() => {
          alert('🎉 听写功能全新升级！\n\n✨ 优化语音支持：\n• 🎯 中等质量系统语音\n• 📱 多重降级保障机制\n\n🚀 使用方法：\n1️⃣ 点击"设置"→选择"听写模式"\n2️⃣ 开始学习，享受稳定中文发音');
          localStorage.setItem('dictation-intro-shown-v2', 'true');
        }, 1000);
      }
    }

    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>
